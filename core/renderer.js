var config=require("../config"),gaikan=require("gaikan"),fs=require("fs"),async=require("async"),path=require("path"),_default_auth_data={username:"",email:"",status:0,realname:""};module.exports=function(e){var t=new(require("i18n-2"))({locales:config.locales.avail,directory:path.join(__dirname,"lang"),extension:".js",devMode:config.locales.dev_mode}),s={},n={render:function(n,a,i,o){t.setLocale(o.session.current_locale);var r=(a||config.layouts["default"])+"_"+o.session.current_locale;i.auth=_default_auth_data,i.blocks={},i.blocks_sync={},o&&o.session&&o.session.auth&&(i.auth=o.session.auth);var c=[];Object.keys(e.get("blocks")).forEach(function(t){var s=e.get("blocks")[t],a=function(e){s(o,n,function(s){i.blocks[t]=s,e()})};c.push(a)}),Object.keys(e.get("blocks_sync")).forEach(function(t){var s=e.get("blocks_sync")[t];s&&(i.blocks_sync[t]=s)});var l=e.get("settings").site_description||"",u=e.get("settings").site_keywords||"";i.keywords&&u?i.keywords+=", "+u:i.keywords=u,i.description&&l?i.description+=". "+l:i.description=l,i._lang=t,e.get("settings")&&e.get("settings").site_title&&(i.site_title=e.get("settings").site_title),async.waterfall(c,function(){try{var e=s[r]||gaikan.compileFromFile("../views/"+r+".html");return s[r]||(s[r]=e),n.send(e(gaikan,i,void 0))}catch(t){return n.send("Cannot render layout: "+t)}})},render_file:function(e,t,n,a){var i=e+"/"+t+".html",o=s[e+"/"+t+".html"];return o||(o=gaikan.compileFromFile(fs.existsSync(path.join(e,"/custom_"+t+".html"))?e+"/custom_"+t+".html":i)),o?(n.auth=_default_auth_data,a&&a.session&&a.session.auth&&(n.auth=a.session.auth),s[i]||(s[i]=o),o(gaikan,n,void 0)):"Cannot render layout: "+t}};return n};