"use strict";var XBBCODE=function(){function t(e,r,n,o,a,l,u){u=u||[],n++;var p,g,f,d,b=new RegExp("(<bbcl="+n+" )("+s.join("|")+")([ =>])","gi"),T=new RegExp("(<bbcl="+n+" )("+s.join("|")+")([ =>])","i"),h=l.match(b)||[],x=c[e]||{};for(b.lastIndex=0,h||(l=""),f=0;f<h.length;f++)T.lastIndex=0,d=h[f].match(T)[2].toLowerCase(),x.restrictChildrenTo.length>0&&(x.validChildLookup[d]||(g='The tag "'+d+'" is not allowed as a child of the tag "'+e+'".',u.push(g))),p=c[d]||{},p.restrictParentsTo.length>0&&(p.validParentLookup[e]||(g='The tag "'+e+'" is not allowed as a parent of the tag "'+d+'".',u.push(g)));return l=l.replace(i,function(e,r,n,o,a){return u=t(n,e,r,n,o,a,u),e}),u}function e(t){return t=t.replace(/\<([^\>][^\>]*?)\>/gi,function(t,e){var r=e.match(/^bbcl=([0-9]+) /);return null===r?"<bbcl=0 "+e+">":"<"+e.replace(/^(bbcl=)([0-9]+)/,function(t,e,r){return e+(parseInt(r,10)+1)})+">"})}function r(t){return t.replace(/<bbcl=[0-9]+ \/\*>/gi,"").replace(/<bbcl=[0-9]+ /gi,"&#91;").replace(/>/gi,"&#93;")}function n(t){var e=t.text;return e=e.replace(i,x)}function o(t){for(t=t.replace(/\[(?!\*[ =\]]|list([ =][^\]]*)?\]|\/list[\]])/gi,"<"),t=t.replace(/\[(?=list([ =][^\]]*)?\]|\/list[\]])/gi,">");t!==(t=t.replace(/>list([ =][^\]]*)?\]([^>]*?)(>\/list])/gi,function(t,e,r){for(var n=t;n!==(n=n.replace(/\[\*\]([^\[]*?)(\[\*\]|>\/list])/i,function(t,e,r){r=">/list]"===r?"</*]</list]":"</*][*]";var n="<*]"+e+r;return n})););return n=n.replace(/>/g,"<")})););return t=t.replace(/</g,"[")}function a(t){for(;t!==(t=t.replace(l,function(t,r,n,o){return t=t.replace(/\[/g,"<"),t=t.replace(/\]/g,">"),e(t)})););return t}var c,s,i,l,u,p,g,f={},d=/^(?:https?|file|c):(?:\/{1,3}|\\{1})[-a-zA-Z0-9:@#%&()~_?\+=\/\\\.]*$/,b=/^(?:red|green|blue|orange|yellow|black|white|brown|gray|silver|purple|maroon|fushsia|lime|olive|navy|teal|aqua)$/,T=/^#?[a-fA-F0-9]{6}$/,h=[];c={b:{openTag:function(t,e){return'<span class="taracot-bbcode-b">'},closeTag:function(t,e){return"</span>"}},bbcode:{openTag:function(t,e){return""},closeTag:function(t,e){return""}},code:{openTag:function(t,e){return'<span class="taracot-bbcode-code">'},closeTag:function(t,e){return"</span>"},noParse:!0},color:{openTag:function(t,e){var r=t.substr(1)||"black";return b.lastIndex=0,T.lastIndex=0,b.test(r)||(T.test(r)?"#"!==r.substr(0,1)&&(r="#"+r):r="black"),'<span style="color:'+r+'">'},closeTag:function(t,e){return"</span>"}},i:{openTag:function(t,e){return'<span class="taracot-bbcode-i">'},closeTag:function(t,e){return"</span>"}},img:{openTag:function(t,e){var r=e;if(d.lastIndex=0,d.test(r)||(r=""),t){var n=t.substr(1).match(/width=(\d*),height=(\d*)/);if(n[1]&&n[2])return'<img src="'+r+'" style="width:'+n[1]+"px;height:"+n[2]+'px" />'}return'<img src="'+r+'" />'},closeTag:function(t,e){return""},displayContent:!1},list:{openTag:function(t,e){var r;return t?(r=parseInt(t.substr(1)),r&&"NaN"!=r?'<ol start="'+r+'">':"<ol>"):"<ul>"},closeTag:function(t,e){return t?"</ol>":"</ul>"},restrictChildrenTo:["*","li"]},noparse:{openTag:function(t,e){return""},closeTag:function(t,e){return""},noParse:!0},php:{openTag:function(t,e){return'<span class="taracot-bbcode-code">'},closeTag:function(t,e){return"</span>"},noParse:!0},quote:{openTag:function(t,e){return'<blockquote class="taracot-bbcode-blockquote">'},closeTag:function(t,e){return"</blockquote>"}},s:{openTag:function(t,e){return'<span class="taracot-bbcode-s">'},closeTag:function(t,e){return"</span>"}},left:{openTag:function(t,e){return'<div class="taracot-bbcode-left">'},closeTag:function(t,e){return"</div>"}},right:{openTag:function(t,e){return'<div class="taracot-bbcode-right">'},closeTag:function(t,e){return"</div>"}},center:{openTag:function(t,e){return'<div class="taracot-bbcode-center">'},closeTag:function(t,e){return"</div>"}},sub:{openTag:function(t,e){return"<sub>"},closeTag:function(t,e){return"</sub>"}},sup:{openTag:function(t,e){return"<sup>"},closeTag:function(t,e){return"</sup>"}},size:{openTag:function(t,e){var r=parseInt(t.substr(1),10)||0;return'<span class="taracot-bbcode-size-'+r+'">'},closeTag:function(t,e){return"</span>"}},font:{openTag:function(t,e){var r="'"+t.substr(1)+"'"||"'Helvetica Neue',Helvetica,Arial,sans-serif";return'<span style="font-family:'+r+'">'},closeTag:function(t,e){return"</span>"}},video:{openTag:function(t,e){var r=e||"";return'<iframe width="560" height="315" src="//www.youtube.com/embed/'+r+'" frameborder="0" allowfullscreen>'},closeTag:function(t,e){return"</iframe>"},displayContent:!1},table:{openTag:function(t,e){return'<table class="taracot-bbcode-table">'},closeTag:function(t,e){return"</table>"},restrictChildrenTo:["tbody","thead","tfoot","tr"]},tbody:{openTag:function(t,e){return"<tbody>"},closeTag:function(t,e){return"</tbody>"},restrictChildrenTo:["tr"],restrictParentsTo:["table"]},tfoot:{openTag:function(t,e){return"<tfoot>"},closeTag:function(t,e){return"</tfoot>"},restrictChildrenTo:["tr"],restrictParentsTo:["table"]},thead:{openTag:function(t,e){return'<thead class="taracot-bbcode-thead">'},closeTag:function(t,e){return"</thead>"},restrictChildrenTo:["tr"],restrictParentsTo:["table"]},td:{openTag:function(t,e){return'<td class="taracot-bbcode-td">'},closeTag:function(t,e){return"</td>"},restrictParentsTo:["tr"]},th:{openTag:function(t,e){return'<td class="taracot-bbcode-th">'},closeTag:function(t,e){return"</td>"},restrictParentsTo:["tr"]},tr:{openTag:function(t,e){return'<tr class="taracot-bbcode-tr">'},closeTag:function(t,e){return"</tr>"},restrictChildrenTo:["td","th"],restrictParentsTo:["table","tbody","tfoot","thead"]},u:{openTag:function(t,e){return'<span class="taracot-bbcode-u">'},closeTag:function(t,e){return"</span>"}},url:{openTag:function(t,e){var r;return r=t?t.substr(1):e.replace(/<.*?>/g,""),d.lastIndex=0,d.test(r)||(r="#"),'<a href="'+r+'">'},closeTag:function(t,e){return"</a>"}},"*":{openTag:function(t,e){return"<li>"},closeTag:function(t,e){return"</li>"},restrictParentsTo:["list"]}},s=[],function(){var t,e,r;for(t in c)if(c.hasOwnProperty(t)){for("*"===t?s.push("\\"+t):(s.push(t),c[t].noParse&&h.push(t)),c[t].validChildLookup={},c[t].validParentLookup={},c[t].restrictParentsTo=c[t].restrictParentsTo||[],c[t].restrictChildrenTo=c[t].restrictChildrenTo||[],r=c[t].restrictChildrenTo.length,e=0;r>e;e++)c[t].validChildLookup[c[t].restrictChildrenTo[e]]=!0;for(r=c[t].restrictParentsTo.length,e=0;r>e;e++)c[t].validParentLookup[c[t].restrictParentsTo[e]]=!0}}(),i=new RegExp("<bbcl=([0-9]+) ("+s.join("|")+")([ =][^>]*?)?>((?:.|[\\r\\n])*?)<bbcl=\\1 /\\2>","gi"),l=new RegExp("\\[("+s.join("|")+")([ =][^\\]]*?)?\\]([^\\[]*?)\\[/\\1\\]","gi"),u=new RegExp("\\[("+h.join("|")+")([ =][^\\]]*?)?\\]([\\s\\S]*?)\\[/\\1\\]","gi"),function(){for(var t=[],e=0;e<s.length;e++)"\\*"!==s[e]&&t.push("/"+s[e]);p=new RegExp("(\\[)((?:"+s.join("|")+")(?:[ =][^\\]]*?)?)(\\])","gi"),g=new RegExp("(\\[)("+t.join("|")+")(\\])","gi")}();var x=function(t,e,n,o,a){n=n.toLowerCase();var s=c[n].noParse?r(a):a.replace(i,x),l=c[n].openTag(o,s),u=c[n].closeTag(o,s);return c[n].displayContent===!1&&(s=""),l+s+u};return f.process=function(e){var r={html:"",error:!1},c=[];for(e.text=e.text.replace(/</g,"&lt;"),e.text=e.text.replace(/>/g,"&gt;"),e.text=e.text.replace(p,function(t,e,r,n){return"<"+r+">"}),e.text=e.text.replace(g,function(t,e,r,n){return"<"+r+">"}),e.text=e.text.replace(/\[/g,"&#91;"),e.text=e.text.replace(/\]/g,"&#93;"),e.text=e.text.replace(/</g,"["),e.text=e.text.replace(/>/g,"]");e.text!==(e.text=e.text.replace(u,function(t,e,r,n){return n=n.replace(/\[/g,"&#91;"),n=n.replace(/\]/g,"&#93;"),r=r||"",n=n||"","["+e+r+"]"+n+"[/"+e+"]"})););return e.text=o(e.text),e.text=a(e.text),c=t("bbcode",e.text,-1,"","",e.text),r.html=n(e),(-1!==r.html.indexOf("[")||-1!==r.html.indexOf("]"))&&c.push("Some tags appear to be misaligned."),e.removeMisalignedTags&&(r.html=r.html.replace(/\[.*?\]/g,"")),e.addInLineBreaks&&(r.html=r.html.replace(/\r\n/g,"\n"),r.html=r.html.replace(/(\r|\n)/g,"$1<br/>")),r.html=r.html.replace("&#91;","["),r.html=r.html.replace("&#93;","]"),r.error=0===c.length?!1:!0,r.errorQueue=c,r},f}();module.exports=XBBCODE;