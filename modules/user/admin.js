module.exports=function(e){var s={username:1,realname:1,email:1,status:1},t="username",r=1,n=30,i=e.get("express").Router(),a=require("path"),o=require("crypto"),u=require("mongodb").ObjectID,d=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:a.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode});i.get_module_name=function(e){return d.setLocale(e.session.current_locale),d.__("module_name")},i.get("/",function(s,t){if(d.setLocale(s.session.current_locale),!s.session.auth||s.session.auth.status<2)return s.session.auth_redirect_host=s.get("host"),s.session.auth_redirect="/cp/users",void t.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var r=e.get("renderer").render_file(a.join(__dirname,"views"),"user_control",{lang:d},s);e.get("cp").render(s,t,{body:r,css:'<link rel="stylesheet" href="/modules/user/css/main.css">'},d,"users",s.session.auth)}),i.post("/data/list",function(i,a){d.setLocale(i.session.current_locale);var o={ipp:n},u=i.body.skip,l=i.body.query,f=i.body.sort_mode,c=i.body.sort_cell;if("undefined"!=typeof u&&!u.match(/^[0-9]{1,10}$/))return o.status=0,o.error=d.__("invalid_query"),void a.send(JSON.stringify(o));if("undefined"!=typeof l&&!l.match(/^[\w\sА-Яа-я0-9_\-\.]{3,40}$/))return o.status=0,o.error=d.__("invalid_query"),void a.send(JSON.stringify(o));if(!i.session.auth||i.session.auth.status<2)return o.status=0,o.error=d.__("unauth"),void a.send(JSON.stringify(o));var _={};_[t]=r,"undefined"!=typeof c&&"undefined"!=typeof s[c]&&(_={},_[c]=1,"undefined"!=typeof f&&-1==f&&(_[c]=-1)),o.items=[];var m={};l&&(m={$or:[{username:new RegExp(l,"i")},{realname:new RegExp(l,"i")}]}),e.get("mongodb").collection("users").find(m).count(function(s,t){!s&&t>0?(o.total=t,e.get("mongodb").collection("users").find(m,{skip:u,limit:n}).sort(_).toArray(function(e,s){if("undefined"!=typeof s&&!e)for(var t=0;t<s.length;t++){var r=[];r.push(s[t]._id),r.push(s[t].username),r.push(s[t].realname),r.push(s[t].email),r.push(parseInt(s[t].status)),o.items.push(r)}o.status=1,a.send(JSON.stringify(o))})):(o.status=1,o.total="0",a.send(JSON.stringify(o)))})}),i.post("/data/load",function(s,t){d.setLocale(s.session.current_locale);var r={},n=s.body.id;return"undefined"!=typeof n&&n.match(/^[a-f0-9]{24}$/)?!s.session.auth||s.session.auth.status<2?(r.status=0,r.error=d.__("unauth"),void t.send(JSON.stringify(r))):(r.user={},void e.get("mongodb").collection("users").find({_id:new u(n)},{limit:1}).toArray(function(e,s){"undefined"==typeof s||e||s.length>0&&(r.user=s[0],delete r.user.password),r.status=1,t.send(JSON.stringify(r))})):(r.status=0,r.error=d.__("invalid_query"),void t.send(JSON.stringify(r)))}),i.post("/data/save",function(s,t){d.setLocale(s.session.current_locale);var r={err_fields:[],status:1};if(!s.session.auth||s.session.auth.status<2)return r.status=0,r.error=d.__("unauth"),void t.send(JSON.stringify(r));var n=s.body.username,i=s.body.password,a=s.body.email,l=s.body.realname,f=s.body.status,c=s.body.groups,_=s.body.id;if(l&&(l=l.replace(/&/g,"").replace(/>/g,"").replace(/</g,"").replace(/"/g,"")),"undefined"!=typeof _&&_&&!_.match(/^[a-f0-9]{24}$/))return r.status=0,r.error=d.__("invalid_query"),void t.send(JSON.stringify(r));n.match(/^[A-Za-z0-9_\-]{3,20}$/)||(r.status=0,r.err_fields.push("username"));var m=n.toLowerCase();if(a.match(/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/)||(r.status=0,r.err_fields.push("email")),l.match(/^.{0,40}$/)||(r.status=0,r.err_fields.push("realname")),f.match(/^[0-2]{1}$/)||(r.status=0,r.err_fields.push("status")),_||i.match(/^.{5,20}$/)||(r.status=0,r.err_fields.push("password"),r.err_fields.push("password-repeat")),c){var g=c.toLowerCase().replace(/[^a-z0-9_,]/g,"").split(","),p=g.filter(function(e,s){return g.indexOf(e)==s}).sort();c=p.join(", ")}if(0===r.status)return void t.send(JSON.stringify(r));if(_)e.get("mongodb").collection("users").find({$or:[{username_auth:m},{email:a}],$and:[{_id:{$ne:new u(_)}}]},{limit:1}).toArray(function(s,g){return"undefined"!=typeof g&&!s&&g.length>0?(r.status=0,g[0].username_auth==m?(r.error=d.__("username_exists"),r.err_fields.push("username")):g[0].email==a&&(r.error=d.__("email_exists"),r.err_fields.push("email")),void t.send(JSON.stringify(r))):void e.get("mongodb").collection("users").find({_id:new u(_)},{limit:1}).toArray(function(s,g){if("undefined"==typeof g||s)r.status=0,r.error=d.__("id_not_found"),t.send(JSON.stringify(r));else if(g.length>0){var p={username:n,username_auth:m,email:a,realname:l,status:f,groups:c};if(i){var h=o.createHash("md5");p.password=h.update(e.get("config").salt+"."+i).digest("hex")}else p.password=g[0].password;return void e.get("mongodb").collection("users").update({_id:new u(_)},{$set:p},function(){r.status=1,t.send(JSON.stringify(r))})}})});else{e.get("mongodb").collection("users").find({$or:[{username_auth:m},{email:a}]},{limit:1}).toArray(function(s,u){if("undefined"!=typeof u&&!s&&u.length>0)return r.status=0,u[0].username_auth==m?(r.error=d.__("username_exists"),r.err_fields.push("username")):u[0].email==a&&(r.error=d.__("email_exists"),r.err_fields.push("email")),void t.send(JSON.stringify(r));var _=o.createHash("md5"),g=_.update(e.get("config").salt+"."+i).digest("hex");e.get("mongodb").collection("users").insert({username:n,username_auth:m,email:a,realname:l,status:f,groups:c,password:g,regdate:Date.now()},function(){r.status=1,t.send(JSON.stringify(r))})})}}),i.post("/data/delete",function(s,t){d.setLocale(s.session.current_locale);var r={status:1};if(!s.session.auth||s.session.auth.status<2)return r.status=0,r.error=d.__("unauth"),void t.send(JSON.stringify(r));var n=s.body.ids;if("object"!=typeof n||n.length<1)return r.status=0,r.error=d.__("invalid_query"),void t.send(JSON.stringify(r));for(var i=0;i<n.length;i++)n[i].match(/^[a-f0-9]{24}$/)&&e.get("mongodb").collection("users").remove({_id:new u(n[i])},l);t.send(JSON.stringify(r))});var l=function(){};return i};