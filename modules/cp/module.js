module.exports=function(e){function t(t,s,a,r,o){var n={unique:!1,background:!0,dropDups:!1,w:1};a&&(n=a);for(var i=[],u=0;u<s.length;u++){var _={};if(_[s[u]]=1,i.push({col:t,ix:_}),!r){var c={};c[s[u]]=-1,i.push({col:t,ix:c})}}p.every(i,function(t,s){e.get("mongodb").collection(t.col).ensureIndex(t.ix,function(){s(!0)})},function(e){o()})}var s=require("path"),a="https://taracot.org/source/taracotjs/update_info.json",r="https://taracot.org/source/taracotjs",o="",n=require("request"),i=e.get("express").Router(),u=require("os"),_=require("fs-extra"),p=require("async"),c=require("unzip2"),d=require("gaikan"),m=require("checksum"),l=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:s.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),g=d.compileFromFile(_.existsSync(s.join(__dirname,"views")+"/custom_parts_updates_table.html")?s.join(__dirname,"views")+"/custom_parts_updates_table.html":s.join(__dirname,"views")+"/parts_updates_table.html"),f=d.compileFromFile(_.existsSync(s.join(__dirname,"views")+"/custom_parts_updates_tr.html")?s.join(__dirname,"views")+"/custom_parts_updates_tr.html":s.join(__dirname,"views")+"/parts_updates_tr.html");return i.get("/",function(t,r){if("undefined"==typeof t.session.auth||t.session.auth===!1||t.session.auth.status<2)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/cp",void r.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));l.setLocale(t.session.current_locale);var i,_,c=0;p.series([function(t){e.get("mongodb").collection("updates").find().toArray(function(s,r){if(!s&&r&&r.length)for(var u in r)r[u].update_timestamp&&(i=r[u].update_timestamp),r[u].update_last&&(_=r[u].update_last);!i||Date.now()-i>108e5?n({url:a,proxy:o,timeout:1e4,json:!0},function(s,a,r){s||200!==a.statusCode?t():e.get("mongodb").collection("updates").update({},{update_timestamp:Date.now(),update_last:r},{upsert:!0,safe:!1},function(e){i=Date.now(),_=r,t()})}):t()})},function(a){var o=u.loadavg();o=0===o[0]&&0===o[1]&&0===o[2]?l.__("not_available"):o[0]+", "+o[1]+", "+o[2];var n={hostname:u.hostname(),os_type:u.type(),os_platform:u.platform(),cpu_arch:u.arch(),os_release:u.release(),totalmem:parseInt(u.totalmem()/1024/1024)+" "+l.__("MB"),freemem:parseInt(u.freemem()/1024/1024)+" "+l.__("MB"),loadavg:o},p=parseInt((Date.now()-2592e6)/1e3);e.get("mongodb").collection("statistics").find({day:{$gte:p}},{limit:30}).sort({day:1}).toArray(function(o,u){var p=[],m=[],h=[],v=[];if(!o&&u&&u.length)for(var y,S=0;S<u.length;S++){var w=new Date(1e3*u[S].day),x=w.getMonth()+1,D=w.getFullYear();y!=x&&(y=x,m.push({month:l.__("month_"+x),year:D})),p.push(w.getDate()),u[S].visitors&&u[S].hits&&(h.push(u[S].visitors),v.push(u[S].hits))}var b=l.__("no_update_info_available");if(i&&_){var j=e.get("version_info"),q="";for(var J in j){var N="";_[J]&&_[J].version&&(N=_[J].version);var O="actual";N&&parseFloat(N.replace(/\./g,""))>parseFloat(j[J].replace(/\./g,""))&&(O="outdated",c++),q+=f(d,{module_name:J,local_version:j[J],server_version:N,status:O},void 0)}b=g(d,{lang:l,data:q},void 0)}var k=e.get("renderer").render_file(s.join(__dirname,"views"),"dashboard",{lang:l,os:n,days:JSON.stringify(p),months:JSON.stringify(m),visitors:JSON.stringify(h),hits:JSON.stringify(v),config:e.get("config"),updates_table:b,total_updates_avail:c},t);e.get("cp").render(t,r,{body:k},l,"dashboard",t.session.auth),a()})}],function(e){})}),i.post("/_update/start",function(a,i){l.setLocale(a.session.current_locale);var u=require("moment");return u.locale(a.session.current_locale),"undefined"==typeof a.session.auth||a.session.auth===!1||a.session.auth.status<2?i.send(JSON.stringify({status:0,error:l.__("unauth")})):void e.get("mongodb").collection("updates").find().toArray(function(a,d){if(a||!d||!d.length)return i.send(JSON.stringify({status:0,error:l.__("no_update")}));var g,f,h=[],v=e.get("version_info");for(var y in d)d[y].update_timestamp&&(g=d[y].update_timestamp),d[y].update_last&&(f=d[y].update_last);for(var S in v){var w="";f[S]&&f[S].version&&(w=f[S].version),w&&parseFloat(w.replace(/\./g,""))>parseFloat(v[S].replace(/\./g,""))&&h.push(S)}return h.length?(cp_updater_messages=[],e.set("_cp_updater_messages",cp_updater_messages),e.set("_cp_updater_complete",void 0),e.set("_cp_updater_fail",void 0),_.exists(e.get("config").dir.tmp+"/taracot_cp_updater.lock",function(a){return a?i.send(JSON.stringify({status:0,error:l.__("update_in_progress")+": taracot_cp_updater.lock"})):void _.writeFile(e.get("config").dir.tmp+"/taracot_cp_updater.lock",Date.now(),function(a){return a?i.send(JSON.stringify({status:0,error:l.__("cannot_create_lock")+": taracot_cp_updater.lock"})):void setTimeout(function(){p.eachSeries(h,function(a,i){cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+l.__("downloading_module")+": "+a),e.set("_cp_updater_messages",cp_updater_messages);var p=s.join(__dirname,"..",e.get("config").dir.tmp,"taracot_"+a+".zip");_.createWriteStream(p);n({method:"GET",url:r+"/taracot_"+a+".zip",proxy:o,encoding:null},function(r,o,n){return r||200!==o.statusCode?i(l.__("cannot_download")+" taracot_"+a+".zip"):(cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+l.__("saving_module")+": "+a),e.set("_cp_updater_messages",cp_updater_messages),void _.writeFile(p,n,function(r){return r?i(r):(cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+l.__("validating_checksum")+": "+a),e.set("_cp_updater_messages",cp_updater_messages),void m.file(p,function(r,o){if(r)return i(r);if(o!=f[a].checksum)return i(l.__("invalid_checksum")+": "+a);cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+l.__("extracting_module")+": "+a),e.set("_cp_updater_messages",cp_updater_messages);var n=s.join(__dirname,"..");"core"==a&&(n=s.join(__dirname,"..",".."));var d;try{d=_.createReadStream(p).pipe(c.Extract({path:n}))}catch(m){return i(m)}d.on("error",function(e){i(e)}),d.on("close",function(){if("core"==a)return i();cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+l.__("installing_module")+": "+a);try{var s=require("../"+a+"/install")(e.get("mongodb"),t,e.get("config"));s.collections(function(t){t&&(cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+t+": "+a),e.set("_cp_updater_messages",cp_updater_messages)),s.indexes(function(t){t&&(cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+t+": "+a),e.set("_cp_updater_messages",cp_updater_messages)),s.misc(function(t){return t&&(cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+t+": "+a),e.set("_cp_updater_messages",cp_updater_messages)),i()})})})}catch(r){return i(r.message)}})}))}))})},function(t){t&&(cp_updater_messages.push("["+u(Date.now()).format("LTS")+"] "+t),e.set("_cp_updater_messages",cp_updater_messages),e.set("_cp_updater_fail",!0)),_.unlink(e.get("config").dir.tmp+"/taracot_cp_updater.lock",function(t){e.set("_cp_updater_complete",!0)})})},100)})}),i.send(JSON.stringify({status:1}))):i.send(JSON.stringify({status:0,error:l.__("no_update")}))})}),i.post("/_update/status",function(t,s){if("undefined"==typeof t.session.auth||t.session.auth===!1||t.session.auth.status<2)return s.send(JSON.stringify({messages:[l.__("unauth")]}));var a=e.get("_cp_updater_messages")||[],r=e.get("_cp_updater_complete")||void 0,o=e.get("_cp_updater_fail")||void 0;return s.send(JSON.stringify({messages:a,complete:r,failed:o}))}),i.post("/_update/restart",function(t,s){if("undefined"==typeof t.session.auth||t.session.auth===!1||t.session.auth.status<2)return s.send(JSON.stringify({status:0}));var a=e.get("config").update_restart_command||void 0;return setTimeout(function(){if(a){var e=require("sys"),t=require("child_process").exec;t(a,function(t,s,a){e.puts(s)})}else process.exit(1)},1e3),s.send(JSON.stringify({status:1}))}),i};