module.exports=function(e){var t={pname:1,lang:1},n="pname",s=1,i=30,o=require("path"),r=e.get("express").Router(),a=require("mongodb").ObjectID,d=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:o.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode});r.get_module_name=function(e){return d.setLocale(e.session.current_locale),d.__("module_name")},r.get("/",function(t,n){if(d.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<2)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/cp/parts",void n.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var s=e.get("renderer").render_file(o.join(__dirname,"views"),"parts_control",{lang:d,locales:JSON.stringify(e.get("config").locales.avail)},t);e.get("cp").render(t,n,{body:s,css:'<link rel="stylesheet" href="/modules/parts/css/main.css">'},d,"pages",t.session.auth)}),r.post("/data/list",function(o,r){d.setLocale(o.session.current_locale);var a={ipp:i},u=o.body.skip,l=o.body.query,f=o.body.sort_mode,c=o.body.sort_cell;if("undefined"!=typeof u&&!u.match(/^[0-9]{1,10}$/))return a.status=0,a.error=d.__("invalid_query"),void r.send(JSON.stringify(a));if("undefined"!=typeof l&&!l.match(/^[\w\sА-Яа-я0-9_\-\.]{3,40}$/))return a.status=0,a.error=d.__("invalid_query"),void r.send(JSON.stringify(a));if(!o.session.auth||o.session.auth.status<2)return a.status=0,a.error=d.__("unauth"),void r.send(JSON.stringify(a));var g={};g[n]=s,"undefined"!=typeof c&&"undefined"!=typeof t[c]&&(g={},g[c]=1,"undefined"!=typeof f&&-1==f&&(g[c]=-1)),a.items=[];var p={};l&&(p={pname:new RegExp(l,"i")}),e.get("mongodb").collection("parts").find(p).count(function(t,n){!t&&n>0?(a.total=n,e.get("mongodb").collection("parts").find(p,{skip:u,limit:i}).sort(g).toArray(function(e,t){if("undefined"!=typeof t&&!e)for(var n=0;n<t.length;n++){var s=[];s.push(t[n]._id),s.push(t[n].pname),s.push(t[n].plang),a.items.push(s)}a.status=1,r.send(JSON.stringify(a))})):(a.status=1,a.total="0",r.send(JSON.stringify(a)))})}),r.post("/data/load",function(t,n){d.setLocale(t.session.current_locale);var s={},i=t.body.id;return"undefined"!=typeof i&&i.match(/^[a-f0-9]{24}$/)?!t.session.auth||t.session.auth.status<2?(s.status=0,s.error=d.__("unauth"),void n.send(JSON.stringify(s))):(s.data={},void e.get("mongodb").collection("parts").find({_id:new a(i)},{limit:1}).toArray(function(e,t){"undefined"==typeof t||e||t.length>0&&(s.data=t[0]),s.status=1,n.send(JSON.stringify(s))})):(s.status=0,s.error=d.__("invalid_query"),void n.send(JSON.stringify(s)))}),r.post("/data/save",function(t,n){d.setLocale(t.session.current_locale);var s={err_fields:[],status:1};if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=d.__("unauth"),void n.send(JSON.stringify(s));var i=t.body.pname,o=t.body.pvalue,r=t.body.plang,u=t.body.id;if("undefined"!=typeof u&&u&&!u.match(/^[a-f0-9]{24}$/))return s.status=0,s.error=d.__("invalid_query"),void n.send(JSON.stringify(s));i.match(/^[A-Za-z0-9_\-]{1,40}$/)||(s.status=0,s.err_fields.push("pname")),i=i.toLowerCase(),o.length>2097152&&(s.status=0,s.err_fields.push("pvalue"));for(var l=e.get("config").locales.avail[0],f=0;f<e.get("config").locales.avail.length;f++)r==e.get("config").locales.avail[f]&&(l=e.get("config").locales.avail[f]);if(r=l,0===s.status)return void n.send(JSON.stringify(s));if(u)e.get("mongodb").collection("parts").find({pname:i,plang:r,_id:{$ne:new a(u)}},{limit:1}).toArray(function(t,l){return"undefined"!=typeof l&&l.length>0||t?(s.status=0,s.error=d.__("option_exists"),s.err_fields.push("pname"),void n.send(JSON.stringify(s))):void e.get("mongodb").collection("parts").find({_id:new a(u)},{limit:1}).toArray(function(t,l){if("undefined"==typeof l||t)s.status=0,s.error=d.__("id_not_found"),n.send(JSON.stringify(s));else if(l.length>0){var f={pname:i,pvalue:o,plang:r};return void e.get("mongodb").collection("parts").update({_id:new a(u)},f,function(){s.status=1,n.send(JSON.stringify(s))})}})});else{e.get("mongodb").collection("parts").find({pname:i,plang:r},{limit:1}).toArray(function(t,a){return"undefined"!=typeof a&&a.length>0||t?(s.status=0,s.error=d.__("option_exists"),s.err_fields.push("pname"),void n.send(JSON.stringify(s))):void e.get("mongodb").collection("parts").insert({pname:i,pvalue:o,plang:r},function(){s.status=1,n.send(JSON.stringify(s))})})}}),r.post("/data/delete",function(t,n){d.setLocale(t.session.current_locale);var s={status:1};if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=d.__("unauth"),void n.send(JSON.stringify(s));var i=t.body.ids;if("object"!=typeof i||i.length<1)return s.status=0,s.error=d.__("invalid_query"),void n.send(JSON.stringify(s));for(var o=0;o<i.length;o++)i[o].match(/^[a-f0-9]{24}$/)&&e.get("mongodb").collection("parts").remove({_id:new a(i[o])},u);n.send(JSON.stringify(s))});var u=function(){};return r};