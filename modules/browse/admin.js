module.exports=function(e){var r=require("path"),t=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:r.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),n=require("fs-extra"),i=e.get("express").Router(),a=require("mime"),s=(require("archiver"),require("unzip2"),require("crypto")),o=require("async"),u=!1;e.get("config").graphicsmagick&&(u=require("gm")),i.get_module_name=function(e){return t.setLocale(e.session.current_locale),t.__("module_name")},i.get("/",function(n,i){if(t.setLocale(n.session.current_locale),!n.session.auth||n.session.auth.status<2)return n.session.auth_redirect_host=n.get("host"),n.session.auth_redirect="/cp/browse",void i.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var a=!1,s="";n.query.io&&(a=!0),n.query.CKEditorFuncNum&&(s=n.query.CKEditorFuncNum);var o=e.get("renderer").render_file(r.join(__dirname,"views"),"browse",{lang:t,io:a,CKEditorFuncNum:s,locales:JSON.stringify(e.get("config").locales.avail)},n);i.send(o)}),i.post("/data/load",function(r,i){t.setLocale(r.session.current_locale);var u={},m=r.body.io||!1;if(m&&"false"!=m&&(m=!0),!r.session.auth||r.session.auth.status<2)return u.status=0,u.error=t.__("unauth"),i.send(JSON.stringify(u));var l=r.body.dir;if(l&&!c(l))return u.status=0,u.error=t.__("invalid_dir"),i.send(JSON.stringify(u));l=l?"/"+l:"";var d=e.get("config").dir.storage+l;n.exists(d,function(e){if(!e)return u.status=0,u.error=t.__("dir_not_exists"),i.send(JSON.stringify(u));var r=[],c=[];n.readdir(d,function(e,t){t||(t=[]),o.eachSeries(t,function(e,t){var i={name:e};n.stat(d+"/"+e,function(o,u){if(o||!u)return t();if(!u.isFile()||e.match(/^\./)||e.match(/^___thumb_/))return u.isDirectory()&&!e.match(/^\./)&&(i.type="d",i.size="0",i.mime="",c.push(i)),t();var l=a.lookup(d+"/"+e),f=s.createHash("md5").update(e).digest("hex");n.exists(d+"/___thumb_"+f+".jpg",function(e){return e&&(i.thumb=f),i.type="f",i.size=u.size,i.mime=l,m?l.match(/image\//)&&r.push(i):r.push(i),t()})})},function(e){c.sort(function(e,r){return e.name&&r.name?e.name.toLowerCase().localeCompare(r.name.toLowerCase()):e.name.localeCompare(r.name)}),r.sort(function(e,r){return e.name&&r.name?e.name.toLowerCase().localeCompare(r.name.toLowerCase()):e.name.localeCompare(r.name)}),u.files=c.concat(r),u.status=1,i.send(JSON.stringify(u))})})})});var c=function(e){if(!e)return!0;var r=e.replace(/^\s+|\s+$/g,"");return r.length>40?!1:r.match(/^\./)?!1:r.match(/^\\/)?!1:r.match(/^[\^<>\:\"\\\|\?\*\x00-\x1f]+$/)?!1:!0};return i};