module.exports=function(e){var i=e.get("express").Router(),r=e.get("config"),a=require("path"),t=require("crypto"),l=e.get("mailer"),n=require("gaikan"),s=new(require("i18n-2"))({locales:r.locales.avail,directory:a.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),d=require("fs"),_=n.compileFromFile(d.existsSync(a.join(__dirname,"views")+"/custom_part_mail_fields.html")?a.join(__dirname,"views")+"/custom_part_mail_fields.html":a.join(__dirname,"views")+"/part_mail_fields.html");return i.post("/send",function(i,d){d.setHeader("Content-Type","application/json");var o=i.session.current_locale;s.setLocale(o);var c=i.body.fields,f=i.body.captcha,u=i.body.form_data,m=i.body.form_checksum;if(!f.match(/^[0-9]{4}$/))return void d.send(JSON.stringify({result:0,field:"captcha",error:s.__("invalid_captcha")}));if(f!=i.session.captcha)return i.session.captcha=0,void d.send(JSON.stringify({result:0,field:"captcha",error:s.__("invalid_captcha")}));i.session.captcha=0;try{u=JSON.parse(JSON.stringify(u))}catch(g){return d.send(JSON.stringify({result:0,field:"captcha",error:s.__("invalid_form_data")}))}if(t.createHash("md5").update(e.get("config").salt+JSON.stringify(u)+o).digest("hex")!=m)return d.send(JSON.stringify({result:0,field:"captcha",error:s.__("invalid_form_data")}));for(var p=[],v=0;v<u.length;v++){for(var h="",y=0;y<c.length;y++)c[y].id==u[v].id&&(h=c[y].val);if(h=h.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," "),u[v].mandatory&&!h)return d.send(JSON.stringify({result:0,field:u[v].id,error:s.__("mandatory_field_empty")+": "+u[v]["label_"+o]}));if(h&&"email"==u[v].type&&!h.match(/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/))return d.send(JSON.stringify({result:0,field:u[v].id,error:s.__("invalid_email")+": "+u[v]["label_"+o]}));if(h&&"select"==u[v].type){var b=u[v].values;if(!(b&&b instanceof Array))return d.send(JSON.stringify({result:0,field:"captcha",error:s.__("invalid_form_data")}));for(var S=!1,J=0;J<b.length;J++)b[J]["value_"+o]==h&&(S=!0);if(!S)return d.send(JSON.stringify({result:0,field:"captcha",error:s.__("invalid_form_data")}))}h=h.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g," "),p.push({label:u[v]["label_"+o],value:h})}for(var N="",O="",j=0;j<p.length;j++)N+=_(n,{field:p[j].label,value:p[j].value},void 0),O+=p[j].label+":	"+p[j].value+"\n";l.send(r.mailer.feedback,s.__("mail_feedback_on")+": "+e.get("settings").site_title,a.join(__dirname,"views"),"mail_feedback_html","mail_feedback_txt",{lang:s,fields_html:N,fields_txt:O,site_title:e.get("settings").site_title},i,function(){return d.send(JSON.stringify({result:1}))})}),i};