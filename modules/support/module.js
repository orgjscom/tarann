var sort_cells={ticket_id:1,user_id:1,ticket_subj:1,ticket_status:1,ticket_prio:1,ticket_date:1},sort_cell_default="ticket_id",sort_cell_default_mode=-1,support_upload_file_mb=10,items_per_page=30;module.exports=function(t){var e=t.get("express").Router(),s=require("path"),i=(require("async"),t.get("renderer")),r=require("moment"),n=t.get("mailer"),o=t.get("config"),a=require("crypto"),u=require("fs-extra"),_=require("string"),d=require("../../core/socketsender")(t),c=t.get("redis_client"),l=require("mongodb").ObjectID,p=new(require("i18n-2"))({locales:o.locales.avail,directory:s.join(__dirname,"lang"),extension:".js",devMode:o.locales.dev_mode});e.get("/",function(e,r){if(!e.session.auth||e.session.auth.status<1)return e.session.auth_redirect_host=e.get("host"),e.session.auth_redirect="/support",void r.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));p.setLocale(e.session.current_locale);var n={title:p.__("module_name"),page_title:p.__("module_name"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/support/css/frontend.css" type="text/css">'},o=i.render_file(s.join(__dirname,"views"),"support_frontend",{lang:p,data:n,status_list:JSON.stringify(p.__("status_list")),prio_list:JSON.stringify(p.__("prio_list")),current_locale:e.session.current_locale},e);n.content=o,t.get("renderer").render(r,void 0,n,e)}),e.get("/dashboard",function(e,r){var n;if(e.session.auth&&e.session.auth.groups_hash&&e.session.auth.groups_hash.support&&(n=1),!e.session.auth||e.session.auth.status<2&&!n)return e.session.auth_redirect_host=e.get("host"),e.session.auth_redirect="/support/dashboard",void r.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));p.setLocale(e.session.current_locale);var o={title:p.__("module_dashboard"),page_title:p.__("module_dashboard"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/support/css/dashboard.css" type="text/css">'},u=i.render_file(s.join(__dirname,"views"),"support_dashboard",{lang:p,data:o,status_list:JSON.stringify(p.__("status_list")),prio_list:JSON.stringify(p.__("prio_list")),current_locale:e.session.current_locale,current_username:e.session.auth.username,current_user:JSON.stringify({id:e.session.auth._id,id_hash:a.createHash("md5").update(t.get("config").salt+"."+e.session.auth._id).digest("hex")})},e);o.content=u,t.get("renderer").render(r,void 0,o,e)}),e.post("/ajax/list",function(e,s){p.setLocale(e.session.current_locale);var i={ipp:items_per_page},r=e.body.skip,n=e.body.sort_mode,o=e.body.sort_cell;if("undefined"!=typeof r&&!r.match(/^[0-9]{1,10}$/))return i.status=0,i.error=p.__("invalid_query"),s.send(JSON.stringify(i));if(!e.session.auth||e.session.auth.status<1)return i.status=0,i.error=p.__("unauth"),s.send(JSON.stringify(i));var a={};a[sort_cell_default]=sort_cell_default_mode,sort_cells&&sort_cells[o]&&(a={},a[o]=1,"undefined"!=typeof n&&-1==n&&(a[o]=-1)),i.items=[],t.get("mongodb").collection("support").find({user_id:e.session.auth._id}).count(function(n,o){!n&&o>0?(i.total=o,t.get("mongodb").collection("support").find({user_id:e.session.auth._id},{skip:r,limit:items_per_page}).sort(a).toArray(function(t,e){if(!t&&e&&e.length)for(var r=0;r<e.length;r++){var n=[];n.push(e[r]._id),n.push(e[r].ticket_id),n.push(e[r].ticket_subj),n.push(e[r].ticket_status),n.push(e[r].ticket_prio),n.push(e[r].ticket_date),n.push(e[r].ticket_unread),i.items.push(n)}i.status=1,s.send(JSON.stringify(i))})):(i.status=1,i.total="0",s.send(JSON.stringify(i)))})}),e.post("/ajax/dashboard/list",function(e,s){if(p.setLocale(e.session.current_locale),e.session.auth&&e.session.auth.groups_hash&&e.session.auth.groups_hash.support&&(has_support_group=1),!e.session.auth||e.session.auth.status<2&&!has_support_group)return e.session.auth_redirect_host=e.get("host"),e.session.auth_redirect="/support",void s.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));var i={ipp:items_per_page},r=e.body.skip,n=e.body.sort_mode,o=e.body.sort_cell;if("undefined"!=typeof r&&!r.match(/^[0-9]{1,10}$/))return i.status=0,i.error=p.__("invalid_query"),s.send(JSON.stringify(i));var a={};a[sort_cell_default]=sort_cell_default_mode,sort_cells&&sort_cells[o]&&(a={},a[o]=1,"undefined"!=typeof n&&-1==n&&(a[o]=-1)),i.items=[],t.get("mongodb").collection("support").find().count(function(e,n){!e&&n>0?(i.total=n,t.get("mongodb").collection("support").find({},{skip:r,limit:items_per_page}).sort(a).toArray(function(e,r){if(!e&&r&&r.length){var n=[],o={};for(var a in r)if(o[r[a].user_id]||(n.push({_id:new l(r[a].user_id)}),o[r[a].user_id]=1),r[a].ticket_replies&&r[a].ticket_replies.length)for(var u in r[a].ticket_replies)o[r[a].ticket_replies[u].reply_user]||(n.push({_id:new l(r[a].ticket_replies[u].reply_user)}),o[r[a].ticket_replies[u].reply_user]=1);t.get("mongodb").collection("users").find({$or:n}).toArray(function(t,e){var n={};if(!t&&e&&e.length)for(var o in e)n[e[o]._id]=e[o].username;for(var a in r){var u,_;r[a].ticket_replies&&r[a].ticket_replies.length&&(u=r[a].ticket_replies[r[a].ticket_replies.length-1].reply_user,_=r[a].ticket_replies.length),u&&(u=n[u]);var d=[];d.push(r[a]._id),d.push(r[a].ticket_id),d.push(n[r[a].user_id]),d.push(u),d.push(r[a].ticket_subj),d.push(r[a].ticket_status),d.push(r[a].ticket_prio),d.push(r[a].ticket_date),d.push(_),d.push(r[a].locked_by),i.items.push(d)}i.status=1,s.send(JSON.stringify(i))})}})):(i.status=1,i.total="0",s.send(JSON.stringify(i)))})}),e.post("/ajax/ticket/create",function(e,i){p.setLocale(e.session.current_locale);var a={status:1};if(!e.session.auth||e.session.auth.status<1)return a.status=0,a.error=p.__("unauth"),i.send(JSON.stringify(a));var u=e.body.ticket_subj,d=parseInt(e.body.ticket_prio),c=e.body.ticket_msg;return!u||u.length>100?(a.status=0,a.error=p.__("form_data_incorrect"),a.err_field="ticket_subj",i.send(JSON.stringify(a))):(u=_(u).stripTags().s.replace(/\n/g,"<br>"),!d||1>d||d>3?(a.status=0,a.error=p.__("form_data_incorrect"),a.err_field="ticket_prio",i.send(JSON.stringify(a))):!c||c.length>4096?(a.status=0,a.error=p.__("form_data_incorrect"),a.err_field="ticket_msg",i.send(JSON.stringify(a))):(c=_(c).stripTags().s.replace(/\n/g,"<br>"),void t.get("mongodb").collection("counters").findAndModify({_id:"support"},[],{$inc:{seq:1}},{"new":!0},function(_,l){var h;!_&&l&&l.seq||(h=Date.now()),l.seq&&(h=l.seq),t.get("mongodb").collection("support").insert({user_id:e.session.auth._id,ticket_id:h,ticket_date:Date.now(),ticket_status:1,ticket_subj:u,ticket_prio:d,ticket_msg:c,ticket_lang:e.session.current_locale,ticket_host:e.get("host"),ticket_replies:[]},function(u,_){if(u)return a.status=0,a.error=p.__("database_error"),i.send(JSON.stringify(a));var d={};_&&_.length&&(d=_[0]),a.ticket_id=h,r.locale(d.ticket_lang||e.session.current_locale);var c={lang:p,site_title:t.get("settings").site_title,ticket_num:h,ticket_id:d._id,ticket_subj:d.ticket_subj,ticket_msg:d.ticket_msg,ticket_date:r(d.ticket_date).format("L LT"),ticket_status:p.__("status_list")[d.ticket_status-1],ticket_reply:"â€”",view_url:o.protocol+"://"+e.get("host")+"/support?mode=view&ticket_id="+d._id},l=p.__("new_support_message")+", "+p.__("ticket_number")+" "+d.ticket_id+" ("+t.get("settings").site_title+")";c.view_url=o.protocol+"://"+e.get("host")+"/support/dashboard?mode=view&ticket_id="+d._id,n.send(o.mailer.feedback,l,s.join(__dirname,"views"),"mail_newreply_html","mail_newreply_txt",c,e,function(){return i.send(JSON.stringify(a))})})})))}),e.post("/ajax/ticket/reply",function(e,i){p.setLocale(e.session.current_locale),r.locale(e.session.current_locale);var a={status:1};if(!e.session.auth||e.session.auth.status<1)return i.send({status:0,error:p.__("unauth")});var u=e.body.id,h=e.body.ticket_reply_msg;return u&&u.match(/^[a-f0-9]{24}$/)?!h||h.length>4096?(a.status=0,a.error=p.__("form_data_incorrect"),a.err_field="ticket_msg",i.send(JSON.stringify(a))):(h=_(h).stripTags().s.replace(/\n/g,"<br>"),void t.get("mongodb").collection("support").find({_id:new l(u)}).toArray(function(u,_){if(u||!_||1!=_.length)return i.send({status:0,error:p.__("invalid_ticket")});var f,g=_[0],k=Date.now();if(e.session.auth.groups_hash&&e.session.auth.groups_hash.support&&(f=1),g.user_id!=e.session.auth._id&&e.session.auth.status<2&&!f)return i.send({status:0,error:p.__("unauth")});var m=0;g.user_id!=e.session.auth._id&&(m=1);var y=g.ticket_status;2!=e.session.auth.status&&!f||1!=y||(y=2),t.get("mongodb").collection("support").update({_id:new l(g._id)},{$set:{ticket_date:Date.now(),ticket_status:y,ticket_unread:m},$push:{ticket_replies:{reply_msg:h,reply_date:k,reply_user:e.session.auth._id}}},function(u){return u?i.send({status:0,error:p.__("database_error")}):(a.ticket_id=g.ticket_id,a.reply_date=k,void t.get("mongodb").collection("users").find({$or:[{status:2},{groups:{$regex:"support"}},{_id:new l(g.user_id)}]}).toArray(function(u,_){var l=c.multi(),f="";if(!u&&_&&_.length)for(var k in _)l.get(o.redis.prefix+"socketio_online_"+_[k]._id),_[k]._id==g.user_id&&_[k].email&&(f=_[k].email);l.exec(function(u,c){if(c&&c.length)for(var l in _)c[l]&&_[l]._id!=e.session.auth._id&&d.emit(_[l]._id,"ticket_changed",{ticket_id:g._id,locked_by:e.session.auth.username,ticket_date:Date.now(),ticket_status:y,reply_user:e.session.auth.username});r.locale(g.ticket_lang||e.session.current_locale),p.setLocale(g.ticket_lang||e.session.current_locale);var k=g.ticket_host||e.get("host"),m={lang:p,site_title:t.get("settings").site_title,ticket_num:g.ticket_id,ticket_id:g._id,ticket_subj:g.ticket_subj,ticket_msg:g.ticket_msg,ticket_date:r(g.ticket_date).format("L LT"),ticket_status:p.__("status_list")[g.ticket_status-1],ticket_reply:h,view_url:o.protocol+"://"+k+"/support?mode=view&ticket_id="+g._id},v=p.__("new_support_message")+", "+p.__("ticket_number")+" "+g.ticket_id+" ("+t.get("settings").site_title+")";if(g.user_id==e.session.auth._id)m.view_url=o.protocol+"://"+k+"/support/dashboard?mode=view&ticket_id="+g._id,n.send(o.mailer.feedback,v,s.join(__dirname,"views"),"mail_newreply_html","mail_newreply_txt",m,e,function(){return i.send(JSON.stringify(a))});else{if(!f)return i.send(JSON.stringify(a));n.send(f,v,s.join(__dirname,"views"),"mail_newreply_html","mail_newreply_txt",m,e,function(){return i.send(JSON.stringify(a))})}})}))})})):i.send({status:0,error:p.__("invalid_query")})}),e.post("/ajax/ticket/load",function(e,s){p.setLocale(e.session.current_locale);var i={status:1};if(!e.session.auth||e.session.auth.status<1)return i.status=0,i.error=p.__("unauth"),s.send(JSON.stringify(i));var r;e.session.auth&&e.session.auth.groups_hash&&e.session.auth.groups_hash.support&&(r=1);var n=e.body.id;return n&&n.match(/^[a-f0-9]{24}$/)?void t.get("mongodb").collection("support").find({_id:new l(n)}).toArray(function(a,u){if(a||!u||1!=u.length||e.session.auth._id!=u[0].user_id&&e.session.auth.status<2&&!r)return s.send({status:0,error:p.__("invalid_ticket")});i.ticket=u[0];var _=[{_id:new l(i.ticket.user_id)}],h={};if(h[i.ticket.user_id]=1,i.ticket.ticket_replies)for(var f in i.ticket.ticket_replies)h[i.ticket.ticket_replies[f].reply_user]||(h[i.ticket.ticket_replies[f].reply_user]=1,_.push({_id:new l(i.ticket.ticket_replies[f].reply_user)}));t.get("mongodb").collection("users").find({$or:_}).toArray(function(a,u){if(i.users={},!a&&u&&u.length)for(var _ in u)i.users[u[_]._id]={username:u[_].username,realname:u[_].realname,email:u[_].email};var p={};e.session.auth._id==i.ticket.user_id&&(p.ticket_unread=0),i.ticket.locked_by||!r&&2!=e.session.auth.status||(p.locked_by=e.session.auth.username),i.items=u,t.get("mongodb").collection("support").update({_id:new l(n)},{$set:p},function(a){return i.ticket.locked_by||!r&&2!=e.session.auth.status?s.send(JSON.stringify(i)):void t.get("mongodb").collection("users").find({$or:[{status:2},{groups:{$regex:"support"}}]}).toArray(function(t,r){var a=c.multi();if(!t&&r&&r.length)for(var u in r)a.get(o.redis.prefix+"socketio_online_"+r[u]._id);a.exec(function(t,o){if(o&&o.length)for(var a in r)o[a]&&r[a]._id!=e.session.auth._id&&d.emit(r[a]._id,"ticket_changed",{ticket_id:n,locked_by:e.session.auth.username});return s.send(JSON.stringify(i))})})})})}):s.send({status:0,error:p.__("invalid_query")})}),e.post("/ajax/upload",function(e,i){p.setLocale(e.session.current_locale);var r={status:1};if(!e.session.auth||e.session.auth.status<1)return r.status=0,r.error=p.__("unauth"),i.send(JSON.stringify(r));var n=parseInt(e.body.ticket_id),o=parseInt(e.body.reply_id);if(!n||n.isNaN||1>n)return i.send({status:0,error:p.__("invalid_query")});if(o&&(o.isNaN||1>o))return i.send({status:0,error:p.__("invalid_query")});if(!e.files||!e.files.file)return r.status=0,r.error=p.__("no_file_sent"),i.send(JSON.stringify(r));var a=e.files.file;if(a.size>1048576*support_upload_file_mb)return r.status=0,r.error=p.__("file_too_big"),void i.send(JSON.stringify(r));var _=s.extname(a.originalname),d=n+"_"+Date.now();if(!h(a.originalname)||!_)return r.status=0,r.error=p.__("invalid_filename_syntax"),void i.send(JSON.stringify(r));_=_.toLowerCase();var c,f={ticket_id:n};e.session.auth&&e.session.auth.groups_hash&&e.session.auth.groups_hash.support&&(c=1),e.session.auth.status<2&&!c&&(f.user_id=e.session.auth._id),t.get("mongodb").collection("support").find(f).toArray(function(e,n){if(e||!n||!n.length||n.length>1)return i.send({status:0,error:p.__("invalid_ticket")});var c=n[0];u.move(t.get("config").dir.tmp+"/"+a.name,s.join(__dirname,"files",d+_),function(e){if(e)return i.send({status:0,error:p.__("upload_failed")});if(o){for(var s in c.ticket_replies)c.ticket_replies[s].reply_date==o&&(c.ticket_replies[s].attachment=d+_);t.get("mongodb").collection("support").update({_id:new l(c._id)},{$set:{ticket_replies:c.ticket_replies}},function(t){return i.send(t?{status:0,error:p.__("database_error")}:JSON.stringify(r))})}else t.get("mongodb").collection("support").update({_id:new l(c._id)},{$set:{attachment:d+_}},function(t){return i.send(t?{status:0,error:p.__("database_error")}:JSON.stringify(r))})})})}),e.get("/attachment/:filename",function(e,i,r){var n=e.params.filename;return!n||!h(n)||!e.session.auth||e.session.auth.status<1?i.status(404)&&r():void u.exists(s.join(__dirname,"files",n),function(o){if(!o)return i.status(404)&&r();var a={root:s.join(__dirname,"files"),dotfiles:"deny",headers:{"x-timestamp":Date.now(),"x-sent":!0}};if(2==e.session.auth.status||e.session.auth.groups_hash&&e.session.auth.groups_hash.support)i.sendFile(n,a,function(t){return t?i.status(404)&&r():void 0});else{var u=n.split(/_/);if(!u||!u.length)return i.status(404)&&r();var _=parseInt(u[0]);if(!_||_.isNaN)return i.status(404)&&r();t.get("mongodb").collection("support").find({ticket_id:_,user_id:e.session.auth._id}).toArray(function(t,e){return t||!e||1!=e.length?i.status(404)&&r():void i.sendFile(n,a,function(t){return t?i.status(404)&&r():void 0})})}})}),e.post("/ajax/ticket/unlock",function(e,s){p.setLocale(e.session.current_locale);var i,r={status:1};if(e.session.auth&&e.session.auth.groups_hash&&e.session.auth.groups_hash.support&&(i=1),!e.session.auth||e.session.auth.status<2&&!i)return r.status=0,r.error=p.__("unauth"),s.send(JSON.stringify(r));var n=e.body.id;return n&&n.match(/^[a-f0-9]{24}$/)?void t.get("mongodb").collection("support").update({_id:new l(n)},{$set:{locked_by:null}},function(i){t.get("mongodb").collection("users").find({$or:[{status:2},{groups:{$regex:"support"}}]}).toArray(function(t,i){var a=c.multi();if(!t&&i&&i.length)for(var u in i)a.get(o.redis.prefix+"socketio_online_"+i[u]._id);a.exec(function(t,o){if(o&&o.length)for(var a in i)o[a]&&i[a]._id!=e.session.auth._id&&d.emit(i[a]._id,"ticket_changed",{ticket_id:n,locked_by:void 0});return s.send(JSON.stringify(r))})})}):s.send({status:0,error:p.__("invalid_query")})}),e.post("/ajax/ticket/save",function(e,s){p.setLocale(e.session.current_locale);var i,r={status:1};if(e.session.auth&&e.session.auth.groups_hash&&e.session.auth.groups_hash.support&&(i=1),!e.session.auth||e.session.auth.status<2&&!i)return r.status=0,r.error=p.__("unauth"),s.send(JSON.stringify(r));var n=e.body.id,a=parseInt(e.body.ticket_status),u=parseInt(e.body.ticket_prio);return!n||!n.match(/^[a-f0-9]{24}$/)||!a||a.isNaN||1>a||a>3||!u||u.isNaN||1>u||u>3?s.send({status:0,error:p.__("invalid_query")}):void t.get("mongodb").collection("support").update({_id:new l(n)},{$set:{ticket_status:a,ticket_prio:u}},function(i){t.get("mongodb").collection("users").find({$or:[{status:2},{groups:{$regex:"support"}}]}).toArray(function(t,i){var _=c.multi();if(!t&&i&&i.length)for(var l in i)_.get(o.redis.prefix+"socketio_online_"+i[l]._id);_.exec(function(t,o){if(o&&o.length)for(var _ in i)o[_]&&i[_]._id!=e.session.auth._id&&d.emit(i[_]._id,"ticket_changed",{ticket_id:n,locked_by:e.session.auth.username,ticket_status:a,ticket_prio:u});return s.send(JSON.stringify(r))})})})});var h=function(t){if(!t)return!1;var e=t.replace(/^\s+|\s+$/g,"");return!e||e.length>80?!1:e.match(/^\./)?!1:e.match(/^[\^<>\:\"\/\\\|\?\*\x00-\x1f]+$/)?!1:!0};return e};