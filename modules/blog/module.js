module.exports=function(e){var t=e.get("express").Router(),o=require("gaikan"),s=e.get("renderer"),r=require("path"),n=require("mongodb").ObjectID,i=require("async"),a=require("../../core/xbbcode.js"),_=require("crypto"),l=e.get("parser"),d=require("fs"),m=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:r.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),p=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_post.html")?r.join(__dirname,"views")+"/custom_parts_post.html":r.join(__dirname,"views")+"/parts_post.html"),c=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_pagination.html")?r.join(__dirname,"views")+"/custom_parts_pagination.html":r.join(__dirname,"views")+"/parts_pagination.html"),u=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_page_normal.html")?r.join(__dirname,"views")+"/custom_parts_page_normal.html":r.join(__dirname,"views")+"/parts_page_normal.html"),g=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_page_span.html")?r.join(__dirname,"views")+"/custom_parts_page_span.html":r.join(__dirname,"views")+"/parts_page_span.html"),h=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_badge.html")?r.join(__dirname,"views")+"/custom_parts_badge.html":r.join(__dirname,"views")+"/parts_badge.html"),v=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_badge_link.html")?r.join(__dirname,"views")+"/custom_parts_badge_link.html":r.join(__dirname,"views")+"/parts_badge_link.html"),f=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_keyword.html")?r.join(__dirname,"views")+"/custom_parts_keyword.html":r.join(__dirname,"views")+"/parts_keyword.html"),b=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_button.html")?r.join(__dirname,"views")+"/custom_parts_button.html":r.join(__dirname,"views")+"/parts_button.html"),w=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_buttons_wrap.html")?r.join(__dirname,"views")+"/custom_parts_buttons_wrap.html":r.join(__dirname,"views")+"/parts_buttons_wrap.html"),y=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_moderation_alert.html")?r.join(__dirname,"views")+"/custom_parts_moderation_alert.html":r.join(__dirname,"views")+"/parts_moderation_alert.html"),S=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_button_class.html")?r.join(__dirname,"views")+"/custom_parts_button_class.html":r.join(__dirname,"views")+"/parts_button_class.html"),x=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_button_delete_post.html")?r.join(__dirname,"views")+"/custom_parts_button_delete_post.html":r.join(__dirname,"views")+"/parts_button_delete_post.html"),j=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_moderation_badge.html")?r.join(__dirname,"views")+"/custom_parts_moderation_badge.html":r.join(__dirname,"views")+"/parts_moderation_badge.html"),k=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_comments_form.html")?r.join(__dirname,"views")+"/custom_parts_comments_form.html":r.join(__dirname,"views")+"/parts_comments_form.html"),N=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_comment.html")?r.join(__dirname,"views")+"/custom_parts_comment.html":r.join(__dirname,"views")+"/parts_comment.html"),O=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_comment_delete.html")?r.join(__dirname,"views")+"/custom_parts_comment_delete.html":r.join(__dirname,"views")+"/parts_comment_delete.html"),J=o.compileFromFile(d.existsSync(r.join(__dirname,"views")+"/custom_parts_comment_deleted.html")?r.join(__dirname,"views")+"/custom_parts_comment_deleted.html":r.join(__dirname,"views")+"/parts_comment_deleted.html");t.get(/^\/blog(\/(keywords|area|user|moderation)\/(.*))?\/?$/,function(t,s){var r=t.session.current_locale,i=require("moment");m.setLocale(r),i.locale(r);var a={post_lang:r,post_draft:{$ne:"1"},post_deleted:{$ne:"1"},post_moderated:"1"},_="/blog?page=",l="";t.params&&t.params[1]&&t.params[2]&&"user"==t.params[1]&&(l=String(t.params[2]).replace(/\//,"")),q(l,function(d){if(t.params&&t.params[1]&&t.params[2]){if("area"==t.params[1]){var S;try{S=JSON.parse(e.set("settings").blog_areas)}catch(x){S=[]}for(var j="",k=0;k<S.length;k++)S[k].id==t.params[2]&&(j=S[k].id);j&&(a.post_area=j,_="/blog/area/"+j+"?page=")}if("keywords"==t.params[1]){var N=String(t.params[2]).replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ").replace(/\//g,"");N&&N.length>2&&N.length<50&&(a.post_keywords=new RegExp("(^|, )"+N+"($|,)"),_="/blog/keyword/"+N+"?page=")}if("user"==t.params[1]&&d&&d._id&&(a.post_user_id=d._id.toHexString(),_="/blog/user/"+l+"?page=",String(d._id.toHexString())===String(t.session.auth._id)&&(delete a.post_draft,delete a.post_moderated)),"moderation"==t.params[1]){var O=!1;if(t.session.auth&&2==t.session.auth.status&&(O=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(O=!0),!O)return F(m.__("blog_error"),m.__("moderate_permission_denied"),t,s,"error");a.post_moderated="",_="/blog/moderation/all/?page="}}var J=parseInt(t.query.page)||1,q=10,$=10;if(J&&("NaN"==J||0>J))return F(m.__("blog_error"),m.__("invalid_skip_value"),t,s,"error");var H=(J-1)*$;e.get("mongodb").collection("blog").find({post_moderated:"",post_deleted:"",post_draft:""}).count(function(l,d){e.get("mongodb").collection("blog").find(a).count(function(l,S){return!l&&S>0?void e.get("mongodb").collection("blog").find(a,{skip:H,limit:$}).sort({post_timestamp:-1}).toArray(function(a,l){if(a)return F(m.__("module_name"),m.__("no_records_found"),t,s,"error");if(!l||!l.length)return F(m.__("module_name"),m.__("no_records_found"),t,s,"error");for(var x=[],j={},k=0;k<l.length;k++)j[l[k].post_user_id]||(j[l[k].post_user_id]=1,x.push({_id:new n(l[k].post_user_id)}));e.get("mongodb").collection("users").find({$or:x}).toArray(function(n,a){var x={};if(a)for(var j=0;j<a.length;j++)x[a[j]._id]=a[j].username;var k,N="";try{k=JSON.parse(e.set("settings").blog_areas)}catch(O){k=[]}d&&d>0&&(N+=y(o,{notice:m.__("posts_avaiting_moderation"),count:d},void 0));for(var H=0;H<l.length;H++){l[H].post_title&&(l[H].post_title=l[H].post_title.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),l[H].post_keywords&&(l[H].post_keywords=l[H].post_keywords.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),l[H].post_area&&(l[H].post_area=l[H].post_area.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),l[H].post_content&&(l[H].post_content=l[H].post_content.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var L="",A="";L=l[H].post_timestamp?i(l[H].post_timestamp).fromNow():i(Date.now()).fromNow(),A+=h(o,{icon:"clock-o",text:L},void 0),x[l[H].post_user_id]&&(A+=v(o,{icon:"user",text:x[l[H].post_user_id],url:"/blog/user/"+x[l[H].post_user_id]},void 0));var D="";if(l[H].post_keywords){for(var M=l[H].post_keywords.split(","),I=0;I<M.length;I++){var T=M[I].replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ");D+=", "+f(o,{url:"/blog/keywords/"+T,text:T})}D=D.replace(/, /,"")}for(var B="",R=0;R<k.length;R++)k[R].id==l[H].post_area&&(B=k[R][r]);var z=l[H].post_content_html;l[H].post_cut&&(z=l[H].post_content_cut_html);var E="";l[H].post_cut&&(E+=b(o,{icon:"angle-double-right",text:m.__("read_more"),url:"/blog/post/"+l[0]._id.toHexString()},void 0)),E&&(E=w(o,{buttons:E},void 0)),N+=p(o,{lang:m,post_title:l[H].post_title,post_content:z,post_area_id:l[H].post_area,post_area:B,post_keywords:D,post_badges:A,buttons:E,blog_text:m.__("module_name"),post_url:"/blog/post/"+l[H]._id.toHexString()},void 0)}var Z=Math.ceil(S/$),C="";if(Z>1){if(Z>q){if(J>1){var G=J-1;C+=u(o,{url:_+G,text:"«"},void 0)}J>3&&(C+=u(o,{url:"/blog?page=1",text:"1"},void 0));var K=J-2;1>K&&(K=1),K-1>1&&(C+=g(o,{"class":"taracot-dots",text:"..."},void 0));var P=J+2;P>Z&&(P=Z);for(var H=K;P>=H;H++)C+=J==H?g(o,{"class":"active",text:H},void 0):u(o,{url:_+H,text:H},void 0);if(Z-1>P&&(C+=g(o,{"class":"taracot-dots",text:"..."},void 0)),Z-3>=J&&(C+=u(o,{url:_+Z,text:Z},void 0)),Z>J){var G=J+1;C+=u(o,{url:_+G,text:"»"},void 0)}}else for(var H=1;Z>=H;H++)C+=H==J?g(o,{"class":"active",text:H},void 0):u(o,{url:_+H,text:H},void 0);N+=c(o,{pages:C},void 0)}return F(m.__("module_name"),N,t,s)})}):F(m.__("module_name"),m.__("no_records_found"),t,s,"error")})})})}),t.get("/blog/post",function(t,o,n){var i=t.session.current_locale;m.setLocale(i);var a=e.set("settings").blog_mode||"private",_=e.set("settings").blog_areas||"[]";if(!t.session.auth||t.session.auth.status<1)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/blog/post",void o.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));if("private"==a){var l=!1;if(t.session.auth&&2==t.session.auth.status&&(l=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_post&&(l=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(l=!0),!l)return F(m.__("blog_error"),m.__("unauth_to_create_post"),t,o,"error")}var d={title:m.__("blog_post"),page_title:m.__("blog_post"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/blog/css/main.css" type="text/css"><link rel="stylesheet" href="/modules/blog/js/wysibb/theme/default/wbbtheme.css" type="text/css">'},p=s.render_file(r.join(__dirname,"views"),"post",{lang:m,data:d,blog_mode:a,blog_areas:_,locale:i,blog_data:!1},t);return d.content=p,e.get("renderer").render(o,void 0,d,t)}),t.post("/blog/post/save",function(t,o,s){var r=t.session.current_locale,i={status:1};if(m.setLocale(r),!t.session.auth||t.session.auth.status<1)return i.status=0,i.error=m.__("unauth"),o.send(JSON.stringify(i));var _=e.set("settings").blog_mode||"private";if("private"==_){var d=!1;if(t.session.auth&&2==t.session.auth.status&&(d=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_post&&(d=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(d=!0),!d)return i.status=0,i.error=m.__("unauth_to_create_post"),o.send(JSON.stringify(i))}var p=t.body.post_id,c=t.body.post_title,u=t.body.post_area,g=t.body.post_keywords,h=t.body.post_content,v="",f="";if(t.body.post_draft&&(v="1"),t.body.post_comments&&(f="1"),!c||c.length>100)return i.status=0,i.error=m.__("invalid_title"),o.send(JSON.stringify(i));if(g){var b=g.replace(/[\'\"<>\&]/g,"").split(","),w=b.filter(function(e,t){return b.indexOf(e)==t});g="";for(var y=0;y<w.length;y++)g+=", "+w[y].replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ");g=g.replace(/, /,"")}if(!g||g.length>250)return i.status=0,i.error=m.__("invalid_keywords"),o.send(JSON.stringify(i));if(!u)return i.status=0,i.error=m.__("invalid_area"),o.send(JSON.stringify(i));if(!h)return i.status=0,i.error=m.__("invalid_content"),o.send(JSON.stringify(i));c=c.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,""),g=g.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,""),u=u.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,""),h=h.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");var S;try{S=JSON.parse(e.set("settings").blog_areas)}catch(x){S=[]}for(var j="",k=0;k<S.length;k++)S[k].id==u&&(j=S[k].id);u=j,p&&!p.match(/^[a-f0-9]{24}$/)&&(p=void 0),h=h.replace(/\[cut\]/gi,"[cut]");var N=h.split("[cut]"),O="",J="",F=0,q=a.process({text:h.replace(/\[cut\]/gi,"").replace(/\[\/\*\]/g,""),removeMisalignedTags:!0,addInLineBreaks:!0});if(!q||q.error)return i.status=0,i.error=m.__("bbcode_process_failed"),o.send(JSON.stringify(i));if(O=q.html,N.length>1){var $=N[0],H=a.process({text:$,removeMisalignedTags:!0,addInLineBreaks:!0});if(!H||H.error)return i.status=0,i.error=m.__(H.error),o.send(JSON.stringify(i));J=H.html,F=1}var L={post_title:c,post_area:u,post_keywords:g,post_content:h,post_content_html:O,post_cut:F,post_content_cut_html:J,post_draft:v,post_comments:f};"moderation"==_?(L.post_moderated="",2==t.session.auth.status&&(L.post_moderated="1"),t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(L.post_moderated="1")):L.post_moderated="1";var A=l.words(l.html2text(O),c),D={swords:A.words,sdesc:A.desc,stitle:c,slang:r,item_id:p,surl:"",space:"blog"};p?e.get("mongodb").collection("blog").find({_id:new n(p)}).toArray(function(s,a){if(s)return i.status=0,o.send(JSON.stringify(i));if(!a||!a.length)return i.status=0,i.error=m.__("unable_to_find_post"),o.send(JSON.stringify(i));var _=String(t.session.auth._id),l=String(a[0].post_user_id);if(_!=l){var d=!1;if(t.session.auth&&2==t.session.auth.status&&(d=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(d=!0),!d)return i.status=0,i.error=m.__("unauth_to_create_post"),o.send(JSON.stringify(i))}e.get("mongodb").collection("blog").update({_id:new n(p)},{$set:L},function(t,s){return t?(i.status=0,o.send(JSON.stringify(i))):void(v||!L.post_moderated?e.get("mongodb").collection("search_index").remove({item_id:p},function(){return o.send(JSON.stringify(i))}):(D.surl="/blog/post/"+p,e.get("mongodb").collection("search_index").update({item_id:p,slang:r},D,{upsert:!0,safe:!1},function(){return o.send(JSON.stringify(i))})))})}):(L.post_timestamp=Date.now(),L.post_user_id=t.session.auth._id,L.post_lang=r,L.post_deleted="",e.get("mongodb").collection("blog").insert(L,function(t,s){return t?(i.status=0,o.send(JSON.stringify(i))):(s[0]._id&&(i.post_id=s[0]._id.toHexString()),void(v||!L.post_moderated?e.get("mongodb").collection("search_index").remove({item_id:i.post_id},function(){return o.send(JSON.stringify(i))}):(D.surl="/blog/post/"+i.post_id,D.item_id=i.post_id,e.get("mongodb").collection("search_index").update({item_id:i.post_id,slang:r},D,{upsert:!0,safe:!1},function(){return o.send(JSON.stringify(i))}))))}))}),t.get("/blog/post/:id",function(t,a,l){var p=t.session.current_locale;m.setLocale(p);var c=require("moment");c.locale(p);var u=t.params.id;return u&&u.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("blog").find({_id:new n(u)}).toArray(function(l,u){if(l)return F(m.__("blog_error"),m.__("db_request_failed"),t,a,"error");if(!u||!u.length)return F(m.__("blog_error"),m.__("post_not_found"),t,a,"error");var g=!1;t.session.auth&&2==t.session.auth.status&&(g=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(g=!0);var b=!1;if(t.session.auth&&t.session.auth._id==u[0].post_user_id&&(b=!0),u[0].post_draft&&!g&&!b)return F(m.__("blog_error"),m.__("post_is_a_draft"),t,a,"error");var y;t.session.auth&&(y=String(t.session.auth._id));var q=String(u[0].post_user_id);return y!=q&&u[0].post_draft&&u[0].status<2&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator?F(m.__("blog_error"),m.__("post_not_found"),t,a,"error"):void e.get("mongodb").collection("blog_comments").find({post_id:u[0]._id.toHexString()},{limit:1e4}).sort({comment_timestamp:1}).toArray(function(l,b){var y=[],F={};y.push({_id:new n(u[0].post_user_id)}),F[String(u[0].post_user_id)]=1;for(var q=0;q<b.length;q++)F[b[q].comment_user_id]||(F[b[q].comment_user_id]=1,y.push({_id:new n(b[q].comment_user_id)}));e.get("mongodb").collection("users").find({$or:y}).toArray(function(n,l){for(var y={},F={},q=0;q<l.length;q++)y[l[q]._id.toHexString()]=l[q].username;i.series([function(t){i.eachSeries(Object.keys(y),function(t){var o=_.createHash("md5").update(e.get("config").salt+"."+t).digest("hex");d.exists(r.join(__dirname,"..","..","public","images","avatars",o+".jpg"),function(e){e&&(F[t]="/images/avatars/"+o+".jpg")})},function(e){t()})},function(n){try{blog_areas=JSON.parse(e.set("settings").blog_areas)}catch(i){blog_areas=[]}for(var _="",l=0;l<blog_areas.length;l++)blog_areas[l].id==u[0].post_area&&(_=blog_areas[l][p]);var d="",q="";d=u[0].post_timestamp?c(u[0].post_timestamp).fromNow():c(Date.now()).fromNow(),q+=h(o,{icon:"clock-o",text:d},void 0),y[u[0].post_user_id]&&(q+=v(o,{icon:"user",text:y[u[0].post_user_id],url:"/blog/user/"+y[u[0].post_user_id]},void 0));var $="";if(u[0].post_keywords){for(var H=u[0].post_keywords.split(","),L=0;L<H.length;L++){var A=H[L].replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ");$+=", "+f(o,{url:"/blog/keywords/"+A,text:A})}$=$.replace(/, /,"")}var D,M="";t.session.auth&&(D=String(t.session.auth._id));var I=String(u[0].post_user_id);(t.session.auth&&D===I||t.session.auth&&2==t.session.auth.status||t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator)&&(M+=S(o,{icon:"pencil",text:m.__("edit_post"),"class":"button-small",url:"/blog/post/edit/"+u[0]._id.toHexString()},void 0)),t.session.auth&&2==t.session.auth.status&&(M+=x(o,{text:m.__("delete_post"),post_del_confirm:m.__("post_del_confirm"),url:"/blog/post/moderate/delete/"+u[0]._id.toHexString()},void 0));var T=e.set("settings").blog_mode||"private";"moderation"==T&&(g&&!u[0].post_moderated&&(M+=S(o,{icon:"unlock",text:m.__("allow_post"),"class":"button-small",url:"/blog/post/moderate/allow/"+u[0]._id.toHexString()},void 0)),g&&u[0].post_moderated&&(M+=S(o,{icon:"lock",text:m.__("disallow_post"),"class":"button-small",url:"/blog/post/moderate/disallow/"+u[0]._id.toHexString()},void 0))),M&&(M=w(o,{buttons:M},void 0));for(var B=function(e,t,o){for(var s=o||b,r=0;r<s.length;r++)s[r]&&s[r].children&&B(e,t,s[r].children),s[r]&&s[r]._id.toHexString()==t&&(s[r].children||(s[r].children=[]),s[r].children.push(e))},R=0;R<b.length;R++)b[R]&&b[R].comment_parent&&(B(b[R],String(b[R].comment_parent)),delete b[R]);for(var z="",E=function(e,t){if(t||(t=0),e){var s;s=e.comment_timestamp?e.comment_timestamp:Date.now();var r=F[e.comment_user_id]||"/images/avatars/default.png",n="";if(g&&(n=O(o,{id:e._id.toHexString(),text_delete:m.__("delete_comment")},void 0)),z+=e.comment_deleted?J(o,{comment_id:e._id.toHexString(),level:15*t,deleted_text:m.__("comment_deleted")}):N(o,{username:y[e.comment_user_id],comment:e.comment_text,reply_link:m.__("reply_link"),comment_id:e._id.toHexString(),timestamp:c(s).format("L LT"),level:15*t,avatar_url:r,delete_btn:n}),e.children)for(var i=0;i<e.children.length;i++)E(e.children[i],t+1)}},R=0;R<b.length;R++)E(b[R]);u[0].post_title&&(u[0].post_title=u[0].post_title.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),u[0].post_keywords&&(u[0].post_keywords=u[0].post_keywords.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),u[0].post_area&&(u[0].post_area=u[0].post_area.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),u[0].post_content&&(u[0].post_content=u[0].post_content.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var Z=u[0].post_title;u[0].post_moderated||(Z+=j(o,{notice:m.__("post_needs_moderation")},void 0));var C="";t.session.auth&&t.session.auth.status>0&&u[0].post_comments&&(C=k(o,{lang:m},void 0));var G={title:u[0].post_title+" | "+m.__("module_name"),page_title:u[0].post_title+" | "+m.__("module_name"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/blog/css/frontend.css">',lang:m,current_locale:p,post_title:Z,post_content:u[0].post_content_html,post_area_id:u[0].post_area,post_area:_,post_keywords:$,blog_text:m.__("module_name"),post_id:u[0]._id.toHexString(),buttons:M,post_badges:q,comments_form:C,comments_flow:z},K=s.render_file(r.join(__dirname,"views"),"post_view",{lang:m,data:G},t);return G.content=K,e.get("renderer").render(a,void 0,G,t),n()}])})})}):F(m.__("blog_error"),m.__("post_not_found"),t,a,"error")}),t.get("/blog/post/edit/:id",function(t,o,i){var a=t.session.current_locale;m.setLocale(a);var _=t.params.id;return _&&_.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("blog").find({_id:new n(_)}).toArray(function(n,i){if(n)return F(m.__("blog_error"),m.__("db_request_failed"),t,o,"error");if(!i||!i.length)return F(m.__("blog_error"),m.__("post_not_found"),t,o,"error");var _;t.session.auth&&(_=String(t.session.auth._id));var l=String(i[0].post_user_id);if(_!=l){var d=!1;if(t.session.auth&&2==t.session.auth.status&&(d=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(d=!0),!d)return F(m.__("blog_error"),m.__("unauth_to_edit_post"),t,o,"error")}var p=e.set("settings").blog_mode||"private",c=e.set("settings").blog_areas||"[]",u={title:m.__("edit_post"),page_title:m.__("edit_post"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/blog/css/main.css" type="text/css"><link rel="stylesheet" href="/modules/blog/js/wysibb/theme/default/wbbtheme.css" type="text/css">'};i[0].post_title&&(i[0].post_title=i[0].post_title.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),i[0].post_keywords&&(i[0].post_keywords=i[0].post_keywords.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),i[0].post_area&&(i[0].post_area=i[0].post_area.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g,"")),i[0].post_content&&(i[0].post_content=i[0].post_content.replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var g=s.render_file(r.join(__dirname,"views"),"post",{lang:m,data:u,blog_mode:p,blog_areas:c,locale:a,blog_data:JSON.stringify(i[0])},t);return u.content=g,e.get("renderer").render(o,void 0,u,t)}):F(m.__("blog_error"),m.__("post_not_found"),t,o,"error")}),t.get("/blog/post/moderate/:func/:id",function(t,o,s){var r=t.params.id,i=t.params.func;if(!r||!r.match(/^[a-f0-9]{24}$/)||!i)return F(m.__("blog_error"),m.__("post_not_found"),t,o,"error");if("allow"!=i&&"disallow"!=i&&"delete"!=i)return F(m.__("blog_error"),m.__("invalid_moderation_function"),t,o,"error");var a=!1;return t.session.auth&&2==t.session.auth.status&&(a=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(a=!0),a?void e.get("mongodb").collection("blog").find({_id:new n(r)}).toArray(function(s,a){return!s&&a&&a.length?a[0].post_deleted?F(m.__("moderation"),m.__("post_has_been_deleted"),t,o,"error"):("allow"==i&&e.get("mongodb").collection("blog").update({_id:new n(r)},{$set:{post_moderated:"1"}},function(e,s){return e?F(m.__("moderation"),m.__("moderate_actions_failed"),t,o,"error"):o.redirect(303,"/blog/post/"+r+"?rnd="+Math.random().toString().replace(".",""))}),"disallow"==i&&e.get("mongodb").collection("blog").update({_id:new n(r)},{$set:{post_moderated:""}},function(s,n){return s?F(m.__("moderation"),m.__("moderate_actions_failed"),t,o,"error"):void e.get("mongodb").collection("search_index").remove({item_id:r},function(){return o.redirect(303,"/blog/post/"+r+"?rnd="+Math.random().toString().replace(".",""))})}),void("delete"==i&&e.get("mongodb").collection("blog").update({_id:new n(r)},{$set:{post_deleted:"1"}},function(s,n){return s?F(m.__("moderation"),m.__("moderate_actions_failed"),t,o,"error"):void e.get("mongodb").collection("search_index").remove({item_id:r},function(){return F(m.__("moderation"),m.__("post_has_been_deleted"),t,o,"error")})}))):F(m.__("blog_error"),m.__("post_not_found"),t,o,"error")}):F(m.__("blog_error"),m.__("moderate_permission_denied"),t,o,"error")}),t.post("/blog/post/comment",function(t,s,r){var i=t.session.current_locale,a=require("moment");a.locale(i);var _={status:1};if(m.setLocale(i),!t.session.auth||t.session.auth.status<1)return _.status=0,_.error=m.__("unauth"),s.send(JSON.stringify(_));var l=t.body.post_id,d=t.body.comment_parent||"",p=t.body.comment_text;return l&&l.match(/^[a-f0-9]{24}$/)?d&&!d.match(/^[a-f0-9]{24}$/)?(_.status=0,_.error=m.__("invalid_post"),s.send(JSON.stringify(_))):(p=p.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ").replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g," "),!p||p.length<2||p.length>2048?(_.status=0,_.error=m.__("invalid_comment"),s.send(JSON.stringify(_))):void e.get("mongodb").collection("blog").find({_id:new n(l)}).toArray(function(r,n){if(r||!n||!n.length)return _.status=0,_.error=m.__("invalid_post"),s.send(JSON.stringify(_));if(!n[0].post_comments)return _.status=0,_.error=m.__("comments_disallowed"),s.send(JSON.stringify(_));var i=Date.now(),c={comment_parent:d,post_id:l,comment_text:p,comment_timestamp:Date.now(),comment_user_id:t.session.auth._id};e.get("mongodb").collection("blog_comments").insert(c,function(e,r){if(e)return _.status=0,_.error=m.__("invalid_comment"),s.send(JSON.stringify(_));var n=N(o,{username:t.session.auth.username,comment:p,reply_link:m.__("reply_link"),comment_id:r[0]._id.toHexString(),timestamp:a(i).format("L LT"),level:"[set_margin]",avatar_url:t.session.auth.avatar});return _.comment_html=n,_.comment_id=r[0]._id.toHexString(),s.send(JSON.stringify(_))})})):(_.status=0,_.error=m.__("invalid_post"),s.send(JSON.stringify(_)))}),t.post("/blog/post/comment/delete",function(t,o,s){var r=t.session.current_locale,i={status:1};if(m.setLocale(r),!t.session.auth||t.session.auth.status<1)return i.status=0,i.error=m.__("unauth"),o.send(JSON.stringify(i));var a=!1;if(t.session.auth&&2==t.session.auth.status&&(a=!0),t.session.auth&&t.session.auth.groups_hash&&t.session.auth.groups_hash.blog_moderator&&(a=!0),!a)return i.status=0,i.error=m.__("unauth"),o.send(JSON.stringify(i));var _=t.body.comment_id;return _&&_.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("blog_comments").find({_id:new n(_)}).toArray(function(t,s){return!t&&s&&s.length?void e.get("mongodb").collection("blog_comments").update({_id:new n(_)},{$set:{comment_deleted:"1"}},function(e,t){return e?(i.status=0,i.error=m.__("invalid_comment"),o.send(JSON.stringify(i))):o.send(JSON.stringify(i))}):(i.status=0,i.error=m.__("invalid_comment"),o.send(JSON.stringify(i)))}):(i.status=0,i.error=m.__("invalid_comment"),o.send(JSON.stringify(i)))});var F=function(t,o,n,i,a){a||(a="blog");var _={title:t,page_title:t,keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/blog/css/frontend.css">'},l=s.render_file(r.join(__dirname,"views"),a,{lang:m,title:t,content:o,current_locale:n.session.current_locale},n);_.content=l,e.get("renderer").render(i,void 0,_,n)},q=function(t,o){return t&&t.match(/^[A-Za-z0-9_\-]{3,20}$/)?void e.get("mongodb").collection("users").find({username:t}).toArray(function(e,t){return!e&&t&&t.length?void o(t[0]):o()}):o()};return t};