module.exports=function(e){var t,r=e.get("express").Router(),i=require("gaikan"),a=(e.get("renderer"),require("path")),n=require("mongodb").ObjectID,s=require("fs"),o=e.get("parser"),_=require("async"),l=e.get("mailer"),c=require("merge"),u=e.get("config"),m=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_catalog.html")?a.join(__dirname,"views")+"/custom_catalog.html":a.join(__dirname,"views")+"/catalog.html"),d=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_cart.html")?a.join(__dirname,"views")+"/custom_cart.html":a.join(__dirname,"views")+"/cart.html"),p=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_checkout.html")?a.join(__dirname,"views")+"/custom_checkout.html":a.join(__dirname,"views")+"/checkout.html"),h=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_orders.html")?a.join(__dirname,"views")+"/custom_orders.html":a.join(__dirname,"views")+"/orders.html"),g=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_catalog_item.html")?a.join(__dirname,"views")+"/custom_parts_catalog_item.html":a.join(__dirname,"views")+"/parts_catalog_item.html"),f=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_item.html")?a.join(__dirname,"views")+"/custom_item.html":a.join(__dirname,"views")+"/item.html"),v=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_li_a.html")?a.join(__dirname,"views")+"/custom_parts_li_a.html":a.join(__dirname,"views")+"/parts_li_a.html"),y=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_nav_sub.html")?a.join(__dirname,"views")+"/custom_parts_nav_sub.html":a.join(__dirname,"views")+"/parts_nav_sub.html"),w=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_btn_mini.html")?a.join(__dirname,"views")+"/custom_parts_btn_mini.html":a.join(__dirname,"views")+"/parts_btn_mini.html"),b=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_btn_mini_disabled.html")?a.join(__dirname,"views")+"/custom_parts_btn_mini_disabled.html":a.join(__dirname,"views")+"/parts_btn_mini_disabled.html"),j=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_btn.html")?a.join(__dirname,"views")+"/custom_parts_btn.html":a.join(__dirname,"views")+"/parts_btn.html"),S=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_btn_disabled.html")?a.join(__dirname,"views")+"/custom_parts_btn_disabled.html":a.join(__dirname,"views")+"/parts_btn_disabled.html"),x=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_pagination.html")?a.join(__dirname,"views")+"/custom_parts_pagination.html":a.join(__dirname,"views")+"/parts_pagination.html"),N=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_page_normal.html")?a.join(__dirname,"views")+"/custom_parts_page_normal.html":a.join(__dirname,"views")+"/parts_page_normal.html"),F=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_page_span.html")?a.join(__dirname,"views")+"/custom_parts_page_span.html":a.join(__dirname,"views")+"/parts_page_span.html"),k=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_tn_img.html")?a.join(__dirname,"views")+"/custom_parts_tn_img.html":a.join(__dirname,"views")+"/parts_tn_img.html"),$=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_desc_list.html")?a.join(__dirname,"views")+"/custom_parts_desc_list.html":a.join(__dirname,"views")+"/parts_desc_list.html"),q=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_desc_list_item.html")?a.join(__dirname,"views")+"/custom_parts_desc_list_item.html":a.join(__dirname,"views")+"/parts_desc_list_item.html"),A=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_cart.html")?a.join(__dirname,"views")+"/custom_parts_cart.html":a.join(__dirname,"views")+"/parts_cart.html"),O=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_cart_item.html")?a.join(__dirname,"views")+"/custom_parts_cart_item.html":a.join(__dirname,"views")+"/parts_cart_item.html"),J=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_checkout.html")?a.join(__dirname,"views")+"/custom_parts_checkout.html":a.join(__dirname,"views")+"/parts_checkout.html"),I=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_checkout_item.html")?a.join(__dirname,"views")+"/custom_parts_checkout_item.html":a.join(__dirname,"views")+"/parts_checkout_item.html"),M=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_alert_warning.html")?a.join(__dirname,"views")+"/custom_parts_alert_warning.html":a.join(__dirname,"views")+"/parts_alert_warning.html"),L=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_select_option.html")?a.join(__dirname,"views")+"/custom_parts_select_option.html":a.join(__dirname,"views")+"/parts_select_option.html"),G=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_orders.html")?a.join(__dirname,"views")+"/custom_parts_orders.html":a.join(__dirname,"views")+"/parts_orders.html"),T=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_orders_tr.html")?a.join(__dirname,"views")+"/custom_parts_orders_tr.html":a.join(__dirname,"views")+"/parts_orders_tr.html"),C=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_mail_neworder_orders_table_html.html")?a.join(__dirname,"views")+"/custom_parts_mail_neworder_orders_table_html.html":a.join(__dirname,"views")+"/parts_mail_neworder_orders_table_html.html"),B=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_mail_neworder_orders_table_row_html.html")?a.join(__dirname,"views")+"/custom_parts_mail_neworder_orders_table_row_html.html":a.join(__dirname,"views")+"/parts_mail_neworder_orders_table_row_html.html"),E=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_mail_neworder_summary_html.html")?a.join(__dirname,"views")+"/custom_parts_mail_neworder_summary_html.html":a.join(__dirname,"views")+"/parts_mail_neworder_summary_html.html"),R=i.compileFromFile(s.existsSync(a.join(__dirname,"views")+"/custom_parts_mail_neworder_shipping_html.html")?a.join(__dirname,"views")+"/custom_parts_mail_neworder_shipping_html.html":a.join(__dirname,"views")+"/parts_mail_neworder_shipping_html.html"),K=new(require("i18n-2"))({locales:u.locales.avail,directory:a.join(__dirname,"lang"),extension:".js",devMode:u.locales.dev_mode}),Z=[{id:"j1_1",text:"/",data:null,parent:"#",type:"root"}],D=["AF","AX","AL","DZ","AS","AD","AO","AI","AQ","AG","AR","AM","AW","AU","AT","AZ","BS","BH","BD","BB","BY","BE","BZ","BJ","BM","BT","BO","BA","BW","BV","BR","IO","BN","BG","BF","BI","KH","CM","CA","CV","KY","CF","TD","CL","CN","CX","CC","CO","KM","CG","CD","CK","CR","CI","HR","CU","CY","CZ","DK","DJ","DM","DO","EC","EG","SV","GQ","ER","EE","ET","FK","FO","FJ","FI","FR","GF","PF","TF","GA","GM","GE","DE","GH","GI","GR","GL","GD","GP","GU","GT","GG","GN","GW","GY","HT","HM","VA","HN","HK","HU","IS","IN","ID","IR","IQ","IE","IM","IL","IT","JM","JP","JE","JO","KZ","KE","KI","KR","KW","KG","LA","LV","LB","LS","LR","LY","LI","LT","LU","MO","MK","MG","MW","MY","MV","ML","MT","MH","MQ","MR","MU","YT","MX","FM","MD","MC","MN","ME","MS","MA","MZ","MM","NA","NR","NP","NL","AN","NC","NZ","NI","NE","NG","NU","NF","MP","NO","OM","PK","PW","PS","PA","PG","PY","PE","PH","PN","PL","PT","PR","QA","RE","RO","RU","RW","BL","SH","KN","LC","MF","PM","VC","WS","SM","ST","SA","SN","RS","SC","SL","SG","SK","SI","SB","SO","ZA","GS","ES","LK","SD","SR","SJ","SZ","SE","CH","SY","TW","TJ","TZ","TH","TL","TG","TK","TO","TT","TN","TR","TM","TC","TV","UG","UA","AE","GB","US","UM","UY","UZ","VU","VE","VN","VG","VI","WF","EH","YE","ZM","ZW"];if(s.existsSync(a.join(__dirname,"config.js"))&&(t=require("./config")),!t&&s.existsSync(a.join(__dirname,"dist_config.js"))&&(t=require("./dist_config")),t)for(var P in t)u[P]=t[P];var H=u.catalog_payment.api,U=require(a.join(__dirname,"api",H,"module.js"))(e);U&&e.use("/catalog/api/payment/",U),r.post("/ajax/cancel",function(t,r){if(K.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<1)return r.send({status:0,error:K.__("unauth")});var i=t.body.id;return i&&i.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("warehouse_orders").find({_id:new n(i),user_id:t.session.auth._id},{limit:1}).toArray(function(t,a){if(t||!a||!a.length||0!==a[0].order_status)return r.send({status:0,error:K.__("invalid_query")});var s=a[0].cart_data,o=[];for(var l in s)o.push(l);_.each(o,function(t,r){e.get("mongodb").collection("warehouse").update({pfilename:t,pamount:{$ne:-1}},{$inc:{pamount:s[t]}},function(e){r(e)})},function(t){e.get("mongodb").collection("warehouse_orders").update({_id:new n(i)},{$set:{order_status:4}},function(){return r.send({status:1})})})}):r.send({status:0,error:K.__("invalid_query")})}),r.post("/ajax/addr",function(t,r,i){var a=t.session.current_locale;if(K.setLocale(a),!t.session.auth||t.session.auth.status<1)return r.send(JSON.stringify({status:0,error:K.__("unauth")}));var s=t.body.id,o=(t.body.ship_name||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),_=(t.body.ship_street||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),l=(t.body.ship_city||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),c=(t.body.ship_region||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),u=(t.body.ship_country||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),m=(t.body.ship_zip||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),d=(t.body.ship_phone||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),p=(t.body.ship_comment||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;").replace(/\n/g," ");if(!s||!s.match(/^[a-f0-9]{24}$/))return r.send(JSON.stringify({status:0,error:K.__("invalid_id")}));var h=[];if((!o||!o.length||o.length>80)&&h.push(K.__("invalid_name")),(!_||!_.length||_.length>120)&&h.push(K.__("invalid_street")),(!l||!l.length||l.length>120)&&h.push(K.__("invalid_city")),(!c||!c.length||c.length>120)&&h.push(K.__("invalid_region")),u&&u.match(/^[A-Z]{2}$/)||h.push(K.__("invalid_country")),m&&m.match(/^[0-9]{5,6}$/)||h.push(K.__("invalid_country")),d&&d.match(/^[0-9\+]{1,40}$/)||h.push(K.__("invalid_phone")),p&&p.length>1024&&h.push(K.__("invalid_comment")),!h.length){for(var g="",f=0;f<D.length;f++)D[f]==u&&(g=D[f]);g||h.push(K.__("invalid_country"))}return h.length?r.send(JSON.stringify({status:0,error:h.join(". ")})):(shipping_address={ship_name:o,ship_street:_,ship_city:l,ship_region:c,ship_country:u,ship_zip:m,ship_phone:d},void e.get("mongodb").collection("warehouse_orders").find({_id:new n(s),user_id:t.session.auth._id},{limit:1}).toArray(function(t,i){return t||!i||!i.length||i[0].order_status>0?r.send(JSON.stringify({status:0,error:K.__("unauth")})):void e.get("mongodb").collection("warehouse_orders").update({_id:new n(s)},{$set:{shipping_address:shipping_address,ship_comment:p}},function(e){return r.send(e?JSON.stringify({status:0,error:K.__("ajax_failed")}):JSON.stringify({status:1}))})}))}),r.post("/ajax/order",function(t,r,i){var a=t.session.current_locale;if(K.setLocale(a),!t.session.auth||t.session.auth.status<1)return r.send(JSON.stringify({status:0,error:K.__("unauth")}));var s=t.body.id;return s&&s.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("warehouse_orders").find({_id:new n(s)}).toArray(function(i,n){if(i||!n||!n.length||n[0].user_id!=t.session.auth._id)return r.send(JSON.stringify({status:0,error:K.__("unauth")}));var s=n[0];s.status=1,e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"curs"},{conf:"ship"}]}).toArray(function(i,o){var _=[],l=[];if(!i&&o&&o.length){for(var m=0;m<o.length;m++)if("curs"==o[m].conf&&o[m].data)try{_=JSON.parse(o[m].data)}catch(d){}for(var p=0;p<o.length;p++)if("ship"==o[p].conf&&o[p].data)try{l=JSON.parse(o[p].data)}catch(d){}}for(var h={},g=0;g<l.length;g++)h[l[g].id]=l[g][a]||l[g].id;var f=n[0].cart_data,v=[];s.cart_data=[];for(var y in f)v.push({pfilename:y});e.get("mongodb").collection("warehouse").find({$or:v}).toArray(function(e,i){var n=require("moment");n.locale(a);var o={};if(i&&i.length)for(var l=0;l<i.length;l++)i[l].pdata[t.session.current_locale]&&(i[l]=c(i[l],i[l].pdata[t.session.current_locale])),o[i[l].pfilename]=i[l].ptitle;for(var m in f)s.cart_data.push({title:o[m]||m,amount:f[m]});for(var d=0;d<D.length;d++)s.shipping_address.ship_country&&D[d]==s.shipping_address.ship_country&&(s.shipping_address.ship_country_full=K.__("country_list")[d]);return s.order_timestamp=n(s.order_timestamp).format("L LT"),_&&_.length&&(s.currency=_[0][a]),s.payment_enabled=u.catalog_payment&&u.catalog_payment.enabled&&0===s.order_status,s.ship_method&&h[s.ship_method]&&(s.ship_method=h[s.ship_method]),s.order_status_text=K.__("order_status_list")[s.order_status],r.send(JSON.stringify(s))})})}):r.send(JSON.stringify({status:0,error:K.__("invalid_id")}))}),r.get("/orders",function(t,r,a){var n=t.session.current_locale;K.setLocale(n);var s=parseInt(t.query.page)||1,o=t.query.sort||"t",_=t.query.show_all||"1",l=t.query.find||"",c=t.query.cat||"";if(o&&"t"!=o&&"u"!=o&&"d"!=o&&(o="t"),_&&"1"!=_&&"0"!=_&&(_="1"),s&&("NaN"==s||0>s)&&(s=1),c&&(c=c.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),l&&(l=l.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),!t.session.auth||t.session.auth.status<1)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/catalog/orders?rnd="+Math.random().toString().replace(".","")+"&page="+s+"&sort="+o+"&show_all="+_+"&find="+l+"&cat="+c,void r.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));var u=require("moment");u.locale(n),e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"curs"}]}).toArray(function(a,m){var d=[];if(!a&&m&&m.length)for(var p=0;p<m.length;p++)if("curs"==m[p].conf&&m[p].data)try{d=JSON.parse(m[p].data)}catch(g){}e.get("mongodb").collection("warehouse_orders").find({user_id:t.session.auth._id},{limit:100}).sort({order_timestamp:-1}).toArray(function(a,m){var p=K.__("no_orders");if(!a&&m&&m.length){for(var g="",f=0;f<m.length;f++)g+=T(i,{lang:K,id:m[f]._id,order_id:m[f].order_id,order_date:u(m[f].order_timestamp).format("L LT"),order_status:K.__("order_status_list")[m[f].order_status],order_sum:m[f].sum_total+" "+d[0][n]},void 0);p=G(i,{lang:K,items:g},void 0)}for(var v="",y=0;y<D.length;y++)v+=L(i,{val:D[y],text:K.__("country_list")[y]},void 0);var w=0,b=t.session.catalog_cart||[];if(b.length)for(var j=0;j<b.length;j++)w+=parseInt(b[j].amount);var S=Z,x=ae(S,"",t,!0),N=h(i,{lang:K,init_sort:o,init_view:_,init_path:c,init_page:s,init_find:l,orders_html:p,country_list_html:v,cart_items_count:w,bread:x},void 0),F={title:K.__("my_orders"),current_lang:n,page_title:K.__("my_orders"),content:N,keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/catalog/css/frontend.css" type="text/css">'};e.get("renderer").render(r,void 0,F,t)})})}),r.post("/ajax/checkout",function(t,r,n){var s=t.session.current_locale;if(K.setLocale(s),!t.session.auth||t.session.auth.status<1)return r.send(JSON.stringify({status:0,error:K.__("unauth"),stop:1}));var o=(t.body.ship_method||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,""),m=(t.body.ship_name||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),d=(t.body.ship_street||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),p=(t.body.ship_city||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),h=(t.body.ship_region||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),g=(t.body.ship_country||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),f=(t.body.ship_zip||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),v=(t.body.ship_phone||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;"),y=(t.body.ship_comment||"").replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"&quot;").replace(/\n/g," "),w=parseFloat(t.body.subtotal_cost),b={};if(!o.match(/_noaddr$/i)){var j=[];if((!m||!m.length||m.length>80)&&j.push(K.__("invalid_name")),(!d||!d.length||d.length>120)&&j.push(K.__("invalid_street")),(!p||!p.length||p.length>120)&&j.push(K.__("invalid_city")),(!h||!h.length||h.length>120)&&j.push(K.__("invalid_region")),g&&g.match(/^[A-Z]{2}$/)||j.push(K.__("invalid_country")),f&&f.match(/^[0-9]{5,6}$/)||j.push(K.__("invalid_country")),v&&v.match(/^[0-9\+]{1,40}$/)||j.push(K.__("invalid_phone")),y&&y.length>1024&&j.push(K.__("invalid_comment")),(parseInt(w).isNAN||0>w)&&j.push(K.__("invalid_subtotal_cost")),!j.length){for(var S="",x=0;x<D.length;x++)D[x]==g&&(S=D[x]);S||j.push(K.__("invalid_country"))}if(j.length)return r.send(JSON.stringify({status:0,error:j.join(". ")}));b={ship_name:m,ship_street:d,ship_city:p,ship_region:h,ship_country:g,ship_zip:f,ship_phone:v}}e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"curs"},{conf:"ship"}]}).toArray(function(n,m){var d=[],p=[];if(!n&&m&&m.length){for(var h=0;h<m.length;h++)if("curs"==m[h].conf&&m[h].data)try{d=JSON.parse(m[h].data)}catch(g){}for(var f=0;f<m.length;f++)if("ship"==m[f].conf&&m[f].data)try{p=JSON.parse(m[f].data)}catch(g){}}for(var v,j=0;j<p.length;j++)p[j].id===o&&(v=p[j]);if(!v)return r.send(JSON.stringify({status:0,error:K.__("invalid_ship_method")}));for(var S={},x={},N=0;N<d.length;N++)S[d[N].id]=d[N][s]||d[N].id,x[d[N].id]=d[N].exr||1;for(var F=t.session.catalog_cart||[],k=[],$=0;$<F.length;$++)k.push({pfilename:F[$].sku});e.get("mongodb").collection("warehouse").find({$or:k}).toArray(function(n,m){var h=0,g=0,f=0;if(!m)return r.send(JSON.stringify({status:0,error:K.__("no_items_in_checkout"),stop:1}));for(var j={},N=0;N<m.length;N++){m[N].pdata[t.session.current_locale]&&(m[N]=c(m[N],m[N].pdata[t.session.current_locale]));for(var $=0,q=0;q<F.length;q++)F[q].sku==m[N].pfilename&&($=F[q].amount||0);var A=(S[m[N].pcurs]||m[N].pcurs,m[N].pprice*$);if(parseInt(m[N].pamount)>-1&&parseInt(m[N].pamount)<$)return r.send(JSON.stringify({status:0,error:K.__("item_missing")+": "+m[N].ptitle,stop:1}));j[m[N].pfilename]=parseFloat($),h+=A*x[m[N].pcurs],g+=m[N].pweight*$,f=parseInt(f)+parseInt($)}var O=v.price;v.weight>0&&g>0&&(O*=Math.ceil(g/v.weight)),v.amnt>0&&(O*=Math.ceil(f/v.amnt));var J=parseFloat(O)+parseFloat(h);if(w!=h)return r.send(JSON.stringify({status:0,error:K.__("invalid_subtotal_cost"),stop:1}));var I=require("moment");I.locale(s);var M=[];for(var L in j)M.push(L);_.each(M,function(t,r){e.get("mongodb").collection("warehouse").update({pfilename:t,pamount_unlimited:0},{$inc:{pamount:-j[t]}},function(e){r(e)})},function(n){e.get("mongodb").collection("warehouse").find({$or:k}).toArray(function(m,g){var f=!1;if((m||n||!g)&&(f=!0),g&&!f)for(var v=0;v<g.length;v++)g[v].pdata[t.session.current_locale]&&(g[v]=c(g[v],g[v].pdata[t.session.current_locale])),g[v].pamount<0&&(f=!0);if(f)_.each(M,function(t,r){e.get("mongodb").collection("warehouse").update({pfilename:t,pamount:{$ne:-1}},{$inc:{pamount:j[t]}},function(e){r(e)})},function(e){return r.send(JSON.stringify({status:0,error:K.__("order_place_failed"),stop:1}))});else{for(var w={},S=0;S<g.length;S++)w[g[S].pfilename]=g[S].ptitle;e.get("mongodb").collection("counters").findAndModify({_id:"warehouse_orders"},[],{$inc:{seq:1}},{"new":!0},function(n,c){var m;!n&&c&&c.seq||(m=Date.now()),c.seq&&(m=c.seq),e.get("mongodb").collection("warehouse_orders").insert({user_id:t.session.auth._id,order_id:m,order_timestamp:Date.now(),order_status:0,cart_data:j,ship_method:o,sum_subtotal:h,sum_total:J,shipping_address:b,ship_comment:y},function(n,c){n?_.each(M,function(t,r){e.get("mongodb").collection("warehouse").update({pfilename:t,pamount:{$ne:-1}},{$inc:{pamount:j[t]}},function(e){r(e)})},function(e){return r.send(JSON.stringify({status:0,error:K.__("order_place_failed"),stop:1}))}):(t.session.catalog_cart=[],e.get("mongodb").collection("warehouse_addr").update({user_id:t.session.auth._id},{shipping_address:b,user_id:t.session.auth._id},{upsert:!0,safe:!1},function(){if(!t.session.auth.email)return r.send(JSON.stringify({status:1,order_id_hex:c[0]._id,order_id:m}));var n="",_="";for(var g in j)n+=B(i,{lang:K,item:w[g],amount:j[g]},void 0),_+=w[g]+"	"+j[g]+"\n";for(var f=C(i,{lang:K,rows:n,col1:K.__("item_title"),col2:K.__("item_amount")},void 0),v=K.__("item_title")+"	"+K.__("item_amount")+"\n"+_,S=E(i,{lang:K,subtotal:h,total:J,currency:d[0][s]},void 0),x=K.__("subtotal")+"	"+h+" "+d[0][s]+"\n"+K.__("total")+"	"+J+" "+d[0][s],N="",F="",k="",$="",q=0;q<D.length;q++)b.ship_country&&D[q]==b.ship_country&&(k=K.__("country_list")[q]);for(var A=0;A<p.length;A++)p[A].id==o&&($=p[A][s]);b.ship_name&&(N=b.ship_name+"<br>"+b.ship_street+"<br>"+b.ship_city+"<br>"+b.ship_region+"<br>"+b.ship_zip+" "+k,F=b.ship_name+"\n"+b.ship_street+"\n"+b.ship_city+"\n"+b.ship_region+"\n"+b.ship_zip+" "+k);var O=R(i,{lang:K,shipping_method:$||o,ship_phone:b.ship_phone||"-",ship_comment:y||"-",addr:N},void 0),M={lang:K,site_title:e.get("settings").site_title,order_id:m,order_date:I(Date.now()).format("L LT"),items:f,items_txt:v,summary:S,summary_txt:x,shipping:O,view_url:u.protocol+"://"+t.get("host")+"/catalog/orders?mode=view&order_id="+c[0]._id,shipping_method:$||o,ship_phone:b.ship_phone||"-",ship_comment:y||"-",addr_txt:F,subj:K.__("your_order_id")+" "+m};l.send(t.session.auth.email,K.__("your_order_id")+" "+m+" ("+e.get("settings").site_title+")",a.join(__dirname,"views"),"mail_neworder_html","mail_neworder_txt",M,t,function(){M.subj=K.__("order_id")+" "+m,M.view_url=u.protocol+"://"+t.get("host")+"/cp/catalog_orders",l.send(u.mailer.feedback,K.__("order_id")+" "+m+" ("+e.get("settings").site_title+")",a.join(__dirname,"views"),"mail_neworder_html","mail_neworder_txt",M,t,function(){return r.send(JSON.stringify({status:1,order_id_hex:c[0]._id,order_id:m}))})})}))})})}})})})})}),r.get("/checkout",function(t,r,a){var n=t.session.current_locale;K.setLocale(n);var s=parseInt(t.query.page)||1,o=t.query.sort||"t",_=t.query.show_all||"1",l=t.query.find||"",m=t.query.cat||"";return o&&"t"!=o&&"u"!=o&&"d"!=o&&(o="t"),_&&"1"!=_&&"0"!=_&&(_="1"),s&&("NaN"==s||0>s)&&(s=1),m&&(m=m.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),l&&(l=l.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),!t.session.auth||t.session.auth.status<1?(t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/catalog/checkout?rnd="+Math.random().toString().replace(".","")+"&page="+s+"&sort="+o+"&show_all="+_+"&find="+l+"&cat="+m,void r.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""))):void e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"curs"},{conf:"ship"}]}).toArray(function(a,d){var h=[],g=[];if(!a&&d&&d.length){for(var f=0;f<d.length;f++)if("curs"==d[f].conf&&d[f].data)try{h=JSON.parse(d[f].data)}catch(v){}for(var y=0;y<d.length;y++)if("ship"==d[y].conf&&d[y].data)try{g=JSON.parse(d[y].data)}catch(v){}}for(var w={},b={},j=0;j<h.length;j++)w[h[j].id]=h[j][n]||h[j].id,b[h[j].id]=h[j].exr||1;for(var S=t.session.catalog_cart||[],x=[],N=0;N<S.length;N++)x.push({pfilename:S[N].sku});e.get("mongodb").collection("warehouse").find({$or:x}).toArray(function(a,d){var f="",v=0,y=[],j=0,x=0;if(d&&d.length){for(var N=0;N<d.length;N++){d[N].pdata[t.session.current_locale]&&(d[N]=c(d[N],d[N].pdata[t.session.current_locale]));for(var F=0,k=0;k<S.length;k++)S[k].sku==d[N].pfilename&&(F=S[k].amount||0);var $=w[d[N].pcurs]||d[N].pcurs,q=d[N].pprice*F,A="";parseInt(d[N].pamount)>-1&&parseInt(d[N].pamount)<F&&(y.push(d[N].pfilename),A=M(i,{msg:K.__("item_missing")},void 0)),v+=q*b[d[N].pcurs],j+=d[N].pweight*F,x=parseInt(x)+parseInt(F),f+=I(i,{lang:K,title:d[N].ptitle,price:d[N].pprice,sku:d[N].pfilename,amount:F,item_missing:A,sum:q,currency:$},void 0)}f=J(i,{body:f,subtotal:v,subtotal_currency:h[0][n],lang:K},void 0)}else f=K.__("no_items_in_checkout");for(var O="",G="",T=0;T<D.length;T++)O+=L(i,{val:D[T],text:K.__("country_list")[T]},void 0);for(var C=0;C<g.length;C++)G+=L(i,{val:g[C].id,text:g[C][n]},void 0);e.get("mongodb").collection("warehouse_addr").find({user_id:t.session.auth._id},{limit:1}).toArray(function(a,c){var d={};!a&&c&&c.length&&(d=c[0].shipping_address||{});var w=0;if(S.length)for(var b=0;b<S.length;b++)w+=parseInt(S[b].amount);var N=Z,F=ae(N,"",t,!0),k=p(i,{lang:K,checkout_html:f,country_list_html:O,sm_list_html:G,init_checkout:JSON.stringify(S||[]),init_sort:o,init_view:_,init_path:m,init_page:s,init_find:l,total_weight:j,total_amount:x,shipping_methods:JSON.stringify(g),subtotal_currency:h[0][n],subtotal:v,missing_items:JSON.stringify(y),shipping_address:JSON.stringify(d),bread:F,cart_items_count:w,payment_enabled:u.catalog_payment&&u.catalog_payment.enabled},void 0),$={title:K.__("checkout"),current_lang:n,page_title:K.__("checkout"),content:k,keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/catalog/css/frontend.css" type="text/css">'};e.get("renderer").render(r,void 0,$,t)})})})}),r.post("/ajax/cart",function(t,r,i){var a=t.session.current_locale;K.setLocale(a);var n=t.body.values;if(!n||!n.length)return r.send(JSON.stringify({status:0}));for(var s=0;s<n.length;s++)if(!n[s].id||!n[s].id.match(/^[A-Za-z0-9_\-\.]{0,80}$/)||isNaN(parseInt(n[s].val))||parseInt(n[s].val)<0)return r.send(JSON.stringify({status:0}));for(var o={},_=0;_<n.length;_++)o[n[_].id]=n[_].val;var l=t.session.catalog_cart||[],u=0;e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"curs"}]}).toArray(function(i,n){var s=[];if(!i&&n&&n.length)for(var _=0;_<n.length;_++)if("curs"==n[_].conf&&n[_].data)try{s=JSON.parse(n[_].data)}catch(m){}for(var d={},p={},h=0;h<s.length;h++)d[s[h].id]=s[h][a]||s[h].id,p[s[h].id]=s[h].exr||1;for(var g=[],f=0;f<l.length;f++){var v=o[l[f].sku];void 0!==v?(parseInt(v)>999&&(v=999),l[f].amount=v,v>0&&g.push(l[f])):g.push(l[f])}for(var y=[],w=0;w<l.length;w++)y.push({pfilename:l[w].sku});if(!y.length){for(var b=[],j=0;j<l.length;j++)b.push({id:l[j].sku,sum:0,amount:0});return t.session.catalog_cart=g,r.send(JSON.stringify({status:1,subtotal:0,cart:b,cart_size:0}))}e.get("mongodb").collection("warehouse").find({$or:y}).toArray(function(e,i){if(e)return r.send(JSON.stringify({status:0}));for(var a=[],n=0;n<i.length;n++){i[n].pdata[t.session.current_locale]&&(i[n]=c(i[n],i[n].pdata[t.session.current_locale]));var s=o[i[n].pfilename];if(-1!=parseInt(i[n].pamount)&&s>parseInt(i[n].pamount)){s=parseInt(i[n].pamount);for(var _=0;_<g.length;_++)g[_].sku==i[n].pfilename&&(g[_].amount=s,0===s&&g.splice(_,1))}sum=s*i[n].pprice,a.push({id:i[n].pfilename,sum:sum,amount:s}),u+=sum*p[i[n].pcurs]}return t.session.catalog_cart=g,r.send(JSON.stringify({status:1,subtotal:u,cart:a,cart_size:g.length}))})})}),r.get("/cart",function(t,r,a){var n=t.session.current_locale;K.setLocale(n);var s=parseInt(t.query.page)||1,o=t.query.sort||"t",_=t.query.show_all||"1",l=t.query.find||"",u=t.query.cat||"",m=t.query.sku;o&&"t"!=o&&"u"!=o&&"d"!=o&&(o="t"),_&&"1"!=_&&"0"!=_&&(_="1"),s&&("NaN"==s||0>s)&&(s=1),u&&(u=u.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),l&&(l=l.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),m&&!m.match(/^[A-Za-z0-9_\-\.]{0,80}$/)&&(m=""),e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"curs"}]}).toArray(function(a,p){var h=[];if(!a&&p&&p.length)for(var g=0;g<p.length;g++)if("curs"==p[g].conf&&p[g].data)try{h=JSON.parse(p[g].data)}catch(f){}for(var v={},y={},w=0;w<h.length;w++)v[h[w].id]=h[w][n]||h[w].id,y[h[w].id]=h[w].exr||1;var b=t.session.catalog_cart||[];if(m){for(var j,S=0;S<b.length;S++)b[S].sku==m&&(j=!0);return j||(b.push({sku:m,amount:1}),t.session.catalog_cart=b),r.redirect(303,"/catalog/cart?rnd="+Math.random().toString().replace(".","")+"&page="+s+"&sort="+o+"&show_all="+_+"&find="+l+"&cat="+u)}for(var x=[],N=0;N<b.length;N++)x.push({pfilename:b[N].sku});e.get("mongodb").collection("warehouse").find({$or:x}).toArray(function(a,m){var p="",g=0;if(m&&m.length){var f=0;g=m.length;for(var w=0;w<m.length;w++){m[w].pdata[t.session.current_locale]&&(m[w]=c(m[w],m[w].pdata[t.session.current_locale]));for(var j=0,S=0;S<b.length;S++)b[S].sku==m[w].pfilename&&(j=b[S].amount||0);-1!=parseInt(m[w].pamount)&&j>parseInt(m[w].pamount)&&(j=parseInt(m[w].pamount));var x=v[m[w].pcurs]||m[w].pcurs,N=m[w].pprice*j;f+=N*y[m[w].pcurs],p+=O(i,{lang:K,title:m[w].ptitle,price:m[w].pprice,sku:m[w].pfilename,amount:j,sum:N,currency:x},void 0)}var F=h[0]||{};p=A(i,{body:p,subtotal:f,subtotal_currency:F[n],lang:K},void 0)}else p=K.__("no_items_in_cart");var k=0;if(b.length)for(var $=0;$<b.length;$++)k+=parseInt(b[$].amount);var q=Z,J=ae(q,"",t,!0),I=d(i,{lang:K,cart_html:p,init_cart:JSON.stringify(b||[]),init_sort:o,init_view:_,init_path:u,init_page:s,init_find:l,bread:J,cart_items_count:k,whitems_length:g},void 0),M={title:K.__("cart"),current_lang:n,page_title:K.__("cart"),content:I,keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/catalog/css/frontend.css" type="text/css">'};e.get("renderer").render(r,void 0,M,t)})})}),r.get("/item/:sku",function(t,r,n){var o=t.session.current_locale;K.setLocale(o);var l=t.params.sku;if(!l||!l.match(/^[A-Za-z0-9_\-\.]{0,80}$/))return n();var u=parseInt(t.query.page)||1,m=t.query.sort||"t",d=t.query.show_all||"1",p=t.query.find,h=t.query.cat;m&&"t"!=m&&"u"!=m&&"d"!=m&&(m="t"),d&&"1"!=d&&"0"!=d&&(d="1"),u&&("NaN"==u||0>u)&&(u=1),h&&(h=h.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),p&&(p=p.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"items"},{conf:"collections"},{conf:"curs"},{conf:"misc"}]}).toArray(function(g,v){var y=[],w=[],b=[];if(!g&&v&&v.length)for(var x=0;x<v.length;x++){if("items"==v[x].conf&&v[x].data)try{y=JSON.parse(v[x].data)}catch(N){}if("curs"==v[x].conf&&v[x].data)try{w=JSON.parse(v[x].data)}catch(N){}if("misc"==v[x].conf&&v[x].data)try{b=JSON.parse(v[x].data)}catch(N){}}for(var F={},A={},O={},J=0;J<b.length;J++)O[b[J].id]=b[J][o];for(var I=0;I<w.length;I++)F[w[I].id]=w[I][o]||w[I].id;for(var M=0;M<y.length;M++)A[y[M].id]=y[M][o]||y[M].id;e.get("mongodb").collection("warehouse_categories").find({oname:"categories_json"},{limit:1}).toArray(function(g,v){var y;y=v&&v.length&&v[0].ovalue?JSON.parse(v[0].ovalue):Z,y=W(y),e.get("mongodb").collection("warehouse").find({pfilename:l},{limit:1}).toArray(function(l,g){if(l||!g||!g.length)return n();var v=g[0];v.pdata[t.session.current_locale]&&(v=c(v,v.pdata[t.session.current_locale]));for(var w=(Q(y,"/"+v.pcategory,t)||K.__("module_name"),X(y,v.pcategory_id).reverse()),b="",x=ae(y,v.pcategory_id,t,!0),N="",J=0;J<w.length;J++)b+="/"+w[J].name;var I="/modules/catalog/images/placeholder_300.png",M="#",L="";_.series([function(e){v.pimages&&v.pimages.length?s.exists(a.join(__dirname,"public","modules","catalog","files","tn_"+v.pimages[0]+".jpg"),function(t){t&&(I="/modules/catalog/files/tn_"+v.pimages[0]+".jpg"),s.exists(a.join(__dirname,"public","modules","catalog","files",v.pimages[0]+".jpg"),function(t){t&&(M="/modules/catalog/files/"+v.pimages[0]+".jpg"),v.pimages.length>1?_.eachSeries(v.pimages,function(e,t){s.exists(a.join(__dirname,"public","modules","catalog","files")+"/tn_"+e+".jpg",function(r){r&&(L+=k(i,{
src:"/modules/catalog/files/tn_"+e+".jpg",url:"/modules/catalog/files/"+e+".jpg"})),t()})},function(){e()}):e()})}):e()},function(a){var n="",s="";if(v.pchars&&v.pchars.length){for(var _="",l=0;l<v.pchars.length;l++)_+=q(i,{par:A[v.pchars[l].id]||v.pchars[l].id,val:v.pchars[l].val||"&nbsp;"},void 0);n=$(i,{items:_},void 0)}s+=q(i,{par:K.__("sku"),val:v.pfilename},void 0);var c=K.__("item_avail");0===parseInt(v.pamount)&&(c=K.__("item_not_avail")),s+=q(i,{par:K.__("avail"),val:c},void 0),s+=q(i,{par:K.__("item_weight"),val:v.pweight+" "+O.weight_units},void 0),s=$(i,{items:s},void 0),N=0===parseInt(v.pamount)?S(i,{lang:K},void 0):j(i,{lang:K},void 0),v.pcurs=F[v.pcurs]||v.pcurs;var g=t.session.catalog_cart||[],y=0;if(g.length)for(var w=0;w<g.length;w++)y+=parseInt(g[w].amount);var b="?sort="+m+"&page="+u+"&show_all="+d+"&cat="+(h||"")+"&find="+(p||""),k=f(i,{lang:K,whitem:v,bread:x,primary_img:I,primary_img_full:M,thumb_img:L,btn_buy:N,pchars:n,pgeninfo:s,init_sort:m,init_view:d,init_path:h,init_page:u,init_find:p,url_data:b,cart_items_count:y}),J={title:v.ptitle,current_lang:o,page_title:v.ptitle,content:k,keywords:v.pkeywords,description:v.pdesc,extra_css:'<link rel="stylesheet" href="/modules/catalog/css/frontend.css" type="text/css">'},G=v.playout||void 0;return e.get("renderer").render(r,G,J,t),a()}])})})})}),r.get(/^(.*)?$/,function(t,r,n){var l=t.session.current_locale;K.setLocale(l);var u=t.params[0],d=u.split("/");if(d.forEach(function(e){return e.match(/ /)?n():e.match(/^[\^<>\/\:\"\\\|\?\*\x00-\x1f]+$/)?n():void 0}),!u.match(/^[a-zA-Z_0-9\-\/]+$/))return n();var p=d.join("/");p&&(p=p.replace(/\/$/,""));var h={},f={},j=parseInt(t.query.page)||1,S=10,k=10,$=t.query.sort||"t",q=t.query.show_all||"1",A="",O=t.query.find;$&&"t"!=$&&"u"!=$&&"d"!=$&&($="t"),q&&"1"!=q&&"0"!=q&&(q="1"),j&&("NaN"==j||0>j)&&(j=1),"1"!=q&&(h.pamount={$ne:0}),"t"==$&&(f["pdata."+l+".ptitle"]=1),"u"==$&&(f.pprice=1),"d"==$&&(f.pprice=-1);var J=(j-1)*k;if(O&&(O=O.trim().replace(/\"/g,"").replace(/</g,"").replace(/>/g,"")),O){var I=o.words(O).words.split(/ /);if(I&&I.length){I=o.stem_all(I);for(var M=[],L=0;L<I.length;L++){var G=new RegExp(I[L],"i"),T={$regex:G},C=[],B={},E={};B["pdata."+l+".ptitle"]=T,E["pdata."+l+".pshortdesc"]=T,C.push(B),C.push(E),M.push({$or:C})}h.$and=M}}e.get("mongodb").collection("warehouse_conf").find({conf:"curs"}).toArray(function(o,u){var d=[];if(!o&&u&&u.length)for(var I=0;I<u.length;I++)if("curs"==u[I].conf&&u[I].data)try{d=JSON.parse(u[I].data)}catch(M){}for(var L={},G=0;G<d.length;G++)L[d[G].id]=d[G][l]||d[G].id;e.get("mongodb").collection("warehouse_categories").find({oname:"categories_json"},{limit:1}).toArray(function(o,u){var d;d=u&&u.length&&u[0].ovalue?JSON.parse(u[0].ovalue):Z,d=W(d);var I,M=Q(d,p,t)||K.__("module_name"),G=Y(d,p)||"#",T=ie(d,G),C="",B=X(d,G).reverse(),E="";if(p&&"#"==G)return n();for(var R=0;R<B.length;R++)E+="/"+B[R].name;A=z(E,q,$,"",O),p&&"#"!=p&&"j1_1"!=p&&(I=te(d,G));for(var D=0;D<T.length;D++){for(var P=X(d,T[D]).reverse(),H="",U=P[P.length-1][l],ee=0;ee<P.length;ee++)H+="/"+P[ee].name;if(T[D]==G){var ne="";if(I){for(var se="",oe=0;oe<I.length;oe++){for(var _e=X(d,I[oe]).reverse(),le="",ce=_e[_e.length-1][l],ue=0;ue<_e.length;ue++)le+="/"+_e[ue].name;se+=v(i,{"class":"",url:"/catalog"+le,text:ce})}ne=y(i,{items:se},void 0)}C+=v(i,{"class":"uk-active",url:"",sub:ne,text:U})}else C+=v(i,{"class":"",url:"/catalog"+H,text:U})}if("#"!=G){for(var me=re(d,G),de=[],pe=0;pe<me.length;pe++)de.push({pcategory_id:me[pe]});de.push({pcategory_id:G}),h.$or=de}e.get("mongodb").collection("warehouse").find(h).count(function(n,o){e.get("mongodb").collection("warehouse").find(h,{skip:J,limit:k}).sort(f).toArray(function(u,p){var h=0,f=ae(d,G,t),v="",y={};n||(h=parseInt(o)),_.series([function(e){h>0?_.eachSeries(p,function(e,t){e.pimages&&e.pimages.length?s.exists(a.join(__dirname,"public","modules","catalog","files","tn_"+e.pimages[0]+".jpg"),function(r){r&&(y[e.pimages[0]]=1),t()}):t()},function(){e()}):e()},function(a){if(h>0)for(var n=0;n<p.length;n++){p[n].pdata[t.session.current_locale]&&(p[n]=c(p[n],p[n].pdata[t.session.current_locale]));var s=p[n].ptitle,o="/modules/catalog/images/placeholder_50.png",_=p[n].pshortdesc||"",u=p[n].pfilename||"0",d=p[n].pprice,J=parseInt(p[n].pamount),I=L[p[n].pcurs],G="";G=0===J?b(i,{lang:K},void 0):w(i,{lang:K,sku:u,cat:E||"/"},void 0),p[n].pimages&&p[n].pimages.length&&y[p[n].pimages[0]]&&(o="/modules/catalog/files/tn_"+p[n].pimages[0]+".jpg"),v+=g(i,{lang:K,thumb:o,title:s,sku:u,price:d,btn_buy:G,currency:I,item_url:"/catalog/item/"+u+"?page="+j+"&sort="+$+"&show_all="+q+"&find="+(O||"")+"&cat="+(E||"/"),desc:_},void 0)}else v=K.__("no_items_found");var T=Math.ceil(h/k),B="";if(T>1)if(T>S){if(j>1){var R=j-1;B+=N(i,{url:A+R,text:"В«"},void 0)}j>3&&(B+=N(i,{url:"/blog?page=1",text:"1"},void 0));var Z=j-2;1>Z&&(Z=1),Z-1>1&&(B+=F(i,{"class":"taracot-dots",text:"..."},void 0));var D=j+2;D>T&&(D=T);for(var P=Z;D>=P;P++)B+=j==P?F(i,{"class":"active",text:P},void 0):N(i,{url:A+P,text:P},void 0);if(T-1>D&&(B+=F(i,{"class":"taracot-dots",text:"..."},void 0)),T-3>=j&&(B+=N(i,{url:A+T,text:T},void 0)),T>j){var H=j+1;B+=N(i,{url:A+H,text:"»"},void 0)}}else for(var U=1;T>=U;U++)B+=U==j?F(i,{"class":"active",text:U},void 0):N(i,{url:A+U,text:U},void 0);var W="",Y="";"1"==q?(W+=V("uk-active",z(E,"1",$,j,O),K.__("all")),W+=V("",z(E,"0",$,j,O),K.__("stock_only"))):(W+=V("",z(E,"1",$,j,O),K.__("all")),W+=V("uk-active",z(E,"0",$,j,O),K.__("stock_only"))),"t"==$&&(Y+=V("uk-active",z(E,q,"t",j,O),K.__("title")),Y+=V("",z(E,q,"u",j,O),K.__("price_up")),Y+=V("",z(E,q,"d",j,O),K.__("price_down"))),"u"==$&&(Y+=V("",z(E,q,"t",j,O),K.__("title")),Y+=V("uk-active",z(E,q,"u",j,O),K.__("price_up")),Y+=V("",z(E,q,"d",j,O),K.__("price_down"))),"d"==$&&(Y+=V("",z(E,q,"t",j,O),K.__("title")),Y+=V("",z(E,q,"u",j,O),K.__("price_up")),Y+=V("uk-active",z(E,q,"d",j,O),K.__("price_down")));var Q=t.session.catalog_cart||[],X=0;if(Q.length)for(var ee=0;ee<Q.length;ee++)X+=parseInt(Q[ee].amount);var te="?sort="+$+"&page="+j+"&show_all="+q+"&cat="+(E||"")+"&find="+(O||"");out_html=m(i,{lang:K,current_cat_title:M,current_cat_bread:f,current_neighborhood_html:C,catalog_items:v,pagination:x(i,{pages:B},void 0),filter_show:W,filter_sort:Y,init_sort:$,init_view:q,init_path:E,init_page:j,init_find:O,url_data:te,cart_items_count:X});var re={title:M,current_lang:l,page_title:M,content:out_html,keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/catalog/css/frontend.css" type="text/css">'};return e.get("renderer").render(r,void 0,re,t),a()}])})})})})});var V=function(e,t,r){return v(i,{"class":e||"",url:t||"",text:r||""})},z=function(e,t,r,i,a){return e||(e=""),t||(t="1"),r||(r="t"),a||(a=""),"/catalog"+e+"?find="+a+"&sort="+r+"&show_all="+t+"&page="+i},W=function(e){for(var t={},r=0;r<e.length;r++)t[e[r].id]=e[r],delete t[e[r].id].id;return t},Y=function(e,t,r){if(e&&t){var i=t.replace(/^\//,"").split("/");r||(r=0);for(var a in e)if(e[a].text==i[r]){if(r+1===i.length)return a||"";r++,Y(e[a],t,r)}return""}},Q=function(e,t,r,i){if(e&&t&&t.length){var a=t.replace(/^\//,"").split("/");i||(i=0);for(var n in e)if(e[n].text==a[i]){if(i+1===a.length)return e[n].data.lang[r.session.current_locale]||n||"";i++,Y(e[n],t,r,i)}return""}},X=function(e,t,r){var i=r||[];if(e&&t&&e[t]&&e[t].parent&&"#"!=e[t].parent){var a={name:e[t].text},n=u.locales.avail;if(e[t].data&&e[t].data.lang)for(var s=0;s<n.length;s++)a[n[s]]=e[t].data.lang[n[s]];i.push(a),X(e,e[t].parent,i)}return i},ee=function(e,t){for(var r in e)if(r==t&&e[r]&&e[r].parent)return e[r].parent;return""},te=function(e,t){var r=[];for(var i in e)e[i].parent==t&&r.push(i);return r},re=function(e,t,r){var i=r||[];for(var a in e)e[a].parent==t&&(re(e,a,i),i.push(a));return i},ie=function(e,t){var r=ee(e,t)||"j1_1",i=[];for(var a in e)e[a].parent==r&&i.push(a);return i},ae=function(e,t,r,i){var a=X(e,t).reverse(),n="",s="",o=[];n+='<li><a href="/catalog">'+K.__("module_name")+"</a></li>";for(var _=0;_<a.length;_++){s+="/"+a[_].name;var l=a[_][r.session.current_locale]||a[_].name;n+=a.length-1!=_||i?'<li><a href="/catalog'+s+'">'+l+"</a></li>":"<li>"+l+"</li>",o.push(l)}a.length||(n+="<li>"+K.__("all_catalog_items")+"</li>"),o=o.reverse();var c='<ul class="uk-breadcrumb">'+n+"</ul>",u='<ol class="breadcrumb">'+n+"</ol>";return{raw:a,html:n,html_uikit:c,html_bootstrap:u,title_arr:o}};return r};