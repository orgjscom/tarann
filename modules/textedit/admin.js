module.exports=function(e){e.set("textedit",!0);var r=require("path"),t=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:r.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),i=require("fs-extra"),n=require("./itob"),s=require("mime"),o=e.get("express").Router();o.get_module_name=function(e){return t.setLocale(e.session.current_locale),t.__("module_name")},o.get("/",function(o,l,_){if(t.setLocale(o.session.current_locale),!o.session.auth||o.session.auth.status<2)return o.session.auth_redirect_host=o.get("host"),o.session.auth_redirect="/cp/textedit",void l.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var c=o.query.fn;if(!c||c.match(/\.\./))return a(l);var d=r.resolve(e.get("config").dir.storage+"/"+c).replace(/\\/g,"/"),g=new RegExp("^"+r.resolve(e.get("config").dir.storage).replace(/\\/g,"/"));if(!d.match(g))return a(l);var u="",f={};if(i.existsSync(d)){var v=i.statSync(d);if(!v.isFile())return a(l,t.__("not_a_file"));var h=1024*e.get("config").max_edit_file_kb||1048576;if(v.size>h)return a(l,t.__("file_too_large"));if(!n.check(d))return a(l,t.__("cannot_edit_binary_file"));u=i.readFileSync(d,"utf8"),f={name:c,mime:s.lookup(d),size:v.size}}else f.name=c;var m=e.get("renderer").render_file(r.join(__dirname,"views"),"editor",{lang:t,content:u,file:JSON.stringify(f),locales:JSON.stringify(e.get("config").locales.avail)},o);l.send(m)}),o.post("/data/save",function(n,s,o){if(t.setLocale(n.session.current_locale),!n.session.auth||n.session.auth.status<2)return n.session.auth_redirect_host=n.get("host"),n.session.auth_redirect="/cp/textedit",void s.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var l={status:1},_=n.body.fn;if(!_||_.match(/\.\./))return l.status=0,l.error=t.__("invalid_filename"),void s.send(JSON.stringify(l));var c=r.resolve(e.get("config").dir.storage+"/"+_).replace(/\\/g,"/"),d=new RegExp("^"+r.resolve(e.get("config").dir.storage).replace(/\\/g,"/"));if(!c.match(d))return l.status=0,l.error=t.__("invalid_filename"),void s.send(JSON.stringify(l));var g=n.body.content,u=1024*e.get("config").max_edit_file_kb||1048576;if(g&&g.length>u)return l.status=0,l.error=t.__("file_too_large"),void s.send(JSON.stringify(l));if(i.existsSync(c)){var f=i.statSync(c);if(!f.isFile())return a(s,t.__("not_a_file"))}i.ensureFile(c,function(e){return e?(l.status=0,l.error=t.__("error_while_creating"),void s.send(JSON.stringify(l))):void i.writeFile(c,g,function(e){return e?(l.status=0,l.error=t.__("error_while_creating"),void s.send(JSON.stringify(l))):s.send(l)})})});var a=function(i,n){var s=t.__("file_loading_error");n&&(s=n);var o=e.get("renderer").render_file(r.join(__dirname,"views"),"error",{lang:t,err:s,locales:JSON.stringify(e.get("config").locales.avail)});i.send(o)};return o};