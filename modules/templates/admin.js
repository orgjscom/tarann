var glob=require("glob"),fs=require("fs");module.exports=function(e){var s=1e4,t=e.get("express").Router(),r=require("path"),a=(require("mongodb").ObjectID,new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:r.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}));t.get_module_name=function(e){return a.setLocale(e.session.current_locale),a.__("module_name")},t.get("/",function(s,t){if(a.setLocale(s.session.current_locale),!s.session.auth||s.session.auth.status<2)return s.session.auth_redirect_host=s.get("host"),s.session.auth_redirect="/cp/templates",void t.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var i=e.get("renderer").render_file(r.join(__dirname,"views"),"templates_control",{lang:a,locales:JSON.stringify(e.get("config").locales.avail)},s);e.get("cp").render(s,t,{body:i,css:'<link rel="stylesheet" href="/modules/templates/css/main.css">'},a,"menu",s.session.auth)}),t.post("/data/list",function(e,t){a.setLocale(e.session.current_locale);var r={ipp:s,items:[],status:1};return!e.session.auth||e.session.auth.status<2?(r.status=0,r.error=a.__("unauth"),void t.send(JSON.stringify(r))):(r.total=0,void glob("../views/*.html",{},function(e,s){if(!e&&s)for(var a=0;a<s.length;a++){var i=s[a].replace(/^\.\.\//,""),n=i.replace(/\//g,"__").replace(/\.html$/,""),o=[];o.push(n),o.push(i),r.items.push(o),r.total++}glob("../modules/*/views/*.html",{},function(e,s){if(!e&&s)for(var a=0;a<s.length;a++){var i=s[a].replace(/^\.\.\//,""),n=i.replace(/\//g,"__").replace(/\.html$/,""),o=[];o.push(n),o.push(i),r.items.push(o),r.total++}t.send(JSON.stringify(r))})}))}),t.post("/data/load",function(e,s){a.setLocale(e.session.current_locale);var t={data:{},status:1},r=e.body.id;if(!r||!r.match(/^[a-z0-9_]{1,200}$/i)||r.indexOf("views__")<0)return t.status=0,t.error=a.__("invalid_query"),s.send(JSON.stringify(t));if(!e.session.auth||e.session.auth.status<2)return t.status=0,t.error=a.__("unauth"),s.send(JSON.stringify(t));var i=r.replace(/__/g,"/")+".html";fs.exists("../"+i,function(e){return e?void fs.readFile("../"+i,"utf8",function(e,a){return e?(t.status=0,t.error=e,s.send(JSON.stringify(t))):(t.data.pvalue=a,t.data.id=r,s.send(JSON.stringify(t)))}):(t.status=0,t.error=a.__("invalid_template"),s.send(JSON.stringify(t)))})}),t.post("/data/save",function(e,s){a.setLocale(e.session.current_locale);var t={err_fields:[],status:1};if(!e.session.auth||e.session.auth.status<2)return t.status=0,t.error=a.__("unauth"),void s.send(JSON.stringify(t));var r=e.body.pvalue,i=e.body.id;(!i||!i.match(/^[a-z0-9_]{1,200}$/i)||i.indexOf("views__")<0)&&(t.status=0,ep.err_fields.push("pvalue")),r.length>2097152&&(t.status=0,t.err_fields.push("pvalue"));var n=i.replace(/__/g,"/")+".html";fs.exists("../"+n,function(e){return e||(t.status=0,t.err_fields.push("pvalue")),0===t.status?s.send(JSON.stringify(t)):void fs.writeFile("../"+n,r,function(e){return e&&(t.status=0,t.err_fields.push("pvalue")),s.send(JSON.stringify(t))})})});return t};