module.exports=function(e){var r=require("path"),t=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:r.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),i=require("fs-extra"),n=e.get("express").Router(),s=require("mime"),o=require("archiver"),a=require("unzip2"),u=require("async"),_=!1;e.get("config").graphicsmagick&&(_=require("gm"));var d=require("crypto");n.get_module_name=function(e){return t.setLocale(e.session.current_locale),t.__("module_name")},n.get("/",function(i,n){if(t.setLocale(i.session.current_locale),!i.session.auth||i.session.auth.status<2)return i.session.auth_redirect_host=i.get("host"),i.session.auth_redirect="/cp/files",void n.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var s="false";e.get("textedit")&&(s="true");var o=e.get("renderer").render_file(r.join(__dirname,"views"),"files",{lang:t,textedit:s,files_url:e.get("config").dir.storage_url,locales:JSON.stringify(e.get("config").locales.avail)},i);e.get("cp").render(i,n,{body:o,css:'<link rel="stylesheet" href="/modules/files/css/main.css">'},t,"files",i.session.auth)}),n.post("/data/load",function(r,n){t.setLocale(r.session.current_locale);var o={},a=r.body.io||!1;if(a&&"false"!=a&&(a=!0),!r.session.auth||r.session.auth.status<2)return o.status=0,o.error=t.__("unauth"),n.send(JSON.stringify(o));var _=r.body.dir;if(_&&!c(_))return o.status=0,o.error=t.__("invalid_dir"),n.send(JSON.stringify(o));_=_?"/"+_:"";var f=e.get("config").dir.storage+_;i.exists(f,function(e){if(!e)return o.status=0,o.error=t.__("dir_not_exists"),n.send(JSON.stringify(o));var r=[],_=[];i.readdir(f,function(e,t){t||(t=[]),u.eachSeries(t,function(e,t){var n={name:e};i.stat(f+"/"+e,function(o,u){if(o||!u)return t();if(!u.isFile()||e.match(/^\./)||e.match(/^___thumb_/))return u.isDirectory()&&!e.match(/^\./)&&(n.type="d",n.size="0",n.mime="",_.push(n)),t();var c=s.lookup(f+"/"+e),l=d.createHash("md5").update(e).digest("hex");i.exists(f+"/___thumb_"+l+".jpg",function(e){return e&&(n.thumb=l),n.type="f",n.size=u.size,n.mime=c,a?c.match(/image\//)&&r.push(n):r.push(n),t()})})},function(e){_.sort(function(e,r){return e.name&&r.name?e.name.toLowerCase().localeCompare(r.name.toLowerCase()):e.name.localeCompare(r.name)}),r.sort(function(e,r){return e.name&&r.name?e.name.toLowerCase().localeCompare(r.name.toLowerCase()):e.name.localeCompare(r.name)}),o.files=_.concat(r),o.status=1,n.send(JSON.stringify(o))})})})}),n.post("/data/newdir",function(r,n){t.setLocale(r.session.current_locale);var s={};if(!r.session.auth||r.session.auth.status<2)return s.status=0,s.error=t.__("unauth"),void n.send(JSON.stringify(s));var o=r.body.dir;if(o&&!c(o))return s.status=0,s.error=t.__("invalid_dir"),void n.send(JSON.stringify(s));var a=r.body.newdir.replace(/^\s+|\s+$/g,"");if(!a||!c(a,!0))return s.status=0,s.error=t.__("invalid_dir_syntax"),void n.send(JSON.stringify(s));o=o?"/"+o:"";var u=e.get("config").dir.storage+o;i.exists(u,function(e){return e?void i.exists(u+"/"+a,function(e){return e?(s.status=0,s.error=t.__("dir_already_exists"),n.send(JSON.stringify(s))):void i.mkdir(u+"/"+a,function(e){return e?(s.status=0,s.error=t.__("newdir_error"),n.send(JSON.stringify(s))):(s.status=1,n.send(JSON.stringify(s)))})}):(s.status=0,s.error=t.__("dir_not_exists"),n.send(JSON.stringify(s)))})}),n.post("/data/del",function(r,n){t.setLocale(r.session.current_locale);var s={};if(!r.session.auth||r.session.auth.status<2)return s.status=0,s.error=t.__("unauth"),n.send(JSON.stringify(s));var o=r.body.items;if(!o||!o.length)return s.status=0,s.error=t.__("invalid_request")+"1",n.send(JSON.stringify(s));for(var a=0;a<o.length;a++)if(!f(o[a]))return s.status=0,s.error=t.__("invalid_request"),n.send(JSON.stringify(s));var _=r.body.dir;if(_&&!c(_))return s.status=0,s.error=t.__("invalid_dir"),n.send(JSON.stringify(s));_=_?"/"+_:"";var l=e.get("config").dir.storage+_;i.exists(l,function(e){return e?void u.eachSeries(o,function(e,r){var t=d.createHash("md5").update(e).digest("hex");i.remove(l+"/"+e,function(e){return e?r(!0):void i.exists(l+"/___thumb_"+t+".jpg",function(e){return e?void i.remove(l+"/___thumb_"+t+".jpg",function(e){return e?r(!0):r()}):r()})})},function(e){return e?(s.status=0,s.error=t.__("some_files_not_deleted"),n.send(JSON.stringify(s))):(s.status=1,void n.send(JSON.stringify(s)))}):(s.status=0,s.error=t.__("dir_not_exists"),n.send(JSON.stringify(s)))})}),n.post("/data/rename",function(r,n){t.setLocale(r.session.current_locale);var s={};if(!r.session.auth||r.session.auth.status<2)return s.status=0,s.error=t.__("unauth"),void n.send(JSON.stringify(s));var o=r.body.old_filename,a=r.body.new_filename,_=r.body.dir;if(_&&!c(_))return s.status=0,s.error=t.__("invalid_dir"),void n.send(JSON.stringify(s));_=_?"/"+_:"";var l=e.get("config").dir.storage+_;return f(o)&&f(a)?o==a?(s.status=0,s.error=t.__("cannot_rename_same"),void n.send(JSON.stringify(s))):void i.exists(l,function(e){return e?void i.exists(l+"/"+o,function(e){return e?void i.exists(l+"/"+a,function(e){return e?(s.status=0,s.error=t.__("cannot_rename_same"),n.send(JSON.stringify(s))):void i.rename(l+"/"+o,l+"/"+a,function(e){if(e)return s.status=0,s.error=t.__("rename_error"),n.send(JSON.stringify(s));var r=d.createHash("md5").update(o).digest("hex");u.series([function(e){i.exists(l+"/___thumb_"+r+".jpg",function(t){if(t){var n=d.createHash("md5").update(a).digest("hex");i.rename(l+"/___thumb_"+r+".jpg",l+"/___thumb_"+n+".jpg",function(r){e()})}else e()})},function(e){return s.status=1,n.send(JSON.stringify(s)),e()}])})}):(s.status=0,s.error=t.__("file_not_exists"),n.send(JSON.stringify(s)))}):(s.status=0,s.error=t.__("dir_not_exists"),n.send(JSON.stringify(s)))}):(s.status=0,s.error=t.__("invalid_filename_syntax"),void n.send(JSON.stringify(s)))}),n.post("/data/paste",function(r,n){t.setLocale(r.session.current_locale);var s={};if(!r.session.auth||r.session.auth.status<2)return s.status=0,s.error=t.__("unauth"),void n.send(JSON.stringify(s));var o=r.body.clipboard;if(!o||!o.files||!o.files.length||!o.mode||"copy"!=o.mode&&"cut"!=o.mode)return s.status=0,s.error=t.__("invalid_request"),void n.send(JSON.stringify(s));for(var a=0;a<o.files.length;a++)if(!f(o.files[a]))return s.status=0,s.error=t.__("invalid_request"),void n.send(JSON.stringify(s));var _=o.dir;if(_&&!c(_))return s.status=0,s.error=t.__("invalid_dir"),void n.send(JSON.stringify(s));var l=r.body.dest;if(l&&!c(l))return s.status=0,s.error=t.__("invalid_dir"),void n.send(JSON.stringify(s));if(_==l)return s.status=0,s.error=t.__("cannot_paste_to_source_dir"),void n.send(JSON.stringify(s));for(var g=0;g<o.files.length;g++){var v=o.dir+"/"+o.files[g];v.match(/^\//)&&(v=v.replace(/^\//,""));var m=new RegExp("^"+v+"/"),h=new RegExp("^"+v+"$");if(l.match(m)||l.match(h))return s.status=0,s.error=t.__("cannot_paste_to_itself"),void n.send(JSON.stringify(s))}_=_?"/"+_:"",_=e.get("config").dir.storage+_,l=l?"/"+l:"",l=e.get("config").dir.storage+l,u.series([function(e){i.exists(_,function(r){return r?void e():(s.status=0,s.error=t.__("dir_not_exists"),e(!0))})},function(e){i.exists(l,function(r){return r?void e():(s.status=0,s.error=t.__("dir_not_exists"),e(!0))})},function(e){_=_.replace(/\/\//g,"/"),l=l.replace(/\/\//g,"/"),u.eachSeries(o.files,function(e,r){var n=_+"/"+e,a=l+"/"+e;return n==a||n==l?(s.status=0,s.error=t.__("cannot_paste_to_itself"),r(!0)):void i.exists(n,function(u){return u?void i.stat(n,function(u,f){if(u)return s.status=0,s.error=t.__("dir_or_file_not_exists"),r(!0);var c=d.createHash("md5").update(e).digest("hex");return f.isFile()||f.isDirectory()?void(f.isFile()?"cut"==o.mode?i.rename(n,a,function(e){return e?r(e):void i.rename(_+"/___thumb_"+c+".jpg",l+"/___thumb_"+c+".jpg",function(e){return r()})}):i.copy(n,a,function(e){return e?r(e):void i.copy(_+"/___thumb_"+c+".jpg",l+"/___thumb_"+c+".jpg",function(e){return r()})}):i.copy(n,a,function(e){return"cut"!=o.mode?r():void i.remove(n,function(e){return r()})})):r()}):(s.status=0,s.error=t.__("dir_or_file_not_exists"),r(!0))})},function(r){e(r)})}],function(){return void 0===s.status&&(s.status=1),n.send(JSON.stringify(s))})}),n.post("/data/upload",function(r,n){t.setLocale(r.session.current_locale);var s={};if(!r.session.auth||r.session.auth.status<2)return s.status=0,s.error=t.__("unauth"),void n.send(JSON.stringify(s));if(!r.files||!r.files.file)return s.status=0,s.error=t.__("no_file_sent"),void n.send(JSON.stringify(s));var o=r.files.file;if(o.size>1048576*e.get("config").max_upload_file_mb)return s.status=0,s.error=t.__("file_too_big"),void n.send(JSON.stringify(s));if(!f(o.originalname))return s.status=0,s.error=t.__("invalid_filename_syntax"),void n.send(JSON.stringify(s));var a=r.body.dir;return a&&!c(a)?(s.status=0,s.error=t.__("invalid_dir"),void n.send(JSON.stringify(s))):(a=a?"/"+a:"",a=e.get("config").dir.storage+a,void i.exists(a,function(r){return r?void i.rename(e.get("config").dir.tmp+"/"+o.name,a+"/"+o.originalname,function(e){if(e)return s.status=0,s.error=t.__("upload_failed"),n.send(JSON.stringify(s));if(!_||"image/png"!=o.mimetype&&"image/jpeg"!=o.mimetype)return s.status=1,n.send(JSON.stringify(s));var r=d.createHash("md5").update(o.originalname).digest("hex"),i=_(a+"/"+o.originalname);i.autoOrient(),i.size(function(e,t){return e?(s.status=1,n.send(JSON.stringify(s))):(t.width>=t.height?(i.resize(null,70),i.crop(70,70,0,0)):(i.resize(70,null),i.crop(70,70,0,0)),i.setFormat("jpeg"),i.write(a+"/___thumb_"+r+".jpg",function(e){return s.status=1,n.send(JSON.stringify(s))}),void 0)})}):(s.status=0,s.error=t.__("dir_not_exists"),n.send(JSON.stringify(s)))}))}),n.post("/data/download",function(n,s){t.setLocale(n.session.current_locale);var a={};if(!n.session.auth||n.session.auth.status<2)return a.error=t.__("unauth"),void s.send(JSON.stringify(a));var _=n.body.files;if(!_||!_.length)return a.error=t.__("no_file_sent"),void s.send(JSON.stringify(a));var d=n.body.dir;return d&&!c(d)?(a.error=t.__("invalid_dir"),void s.send(JSON.stringify(a))):(d=d?"/"+d:"",d=e.get("config").dir.storage+d,void u.series([function(e){i.exists(d,function(r){return r?e():(a.error=t.__("dir_not_exists"),s.send(JSON.stringify(a)),e(!0))})},function(e){u.eachSeries(_,function(e,r){return!f(_)||e.match(/^\./)||e.match(/^___thumb_/)?(a.error=t.__("invalid_filename_syntax"),s.send(JSON.stringify(a)),r(!0)):void i.exists(d+"/"+e,function(e){return e?r():(a.error=t.__("file_not_exists"),s.send(JSON.stringify(a)),r(!0))})},function(r){return e(r)})},function(e){return 1!=_.length?e():void i.stat(d+"/"+_[0],function(t,i){return i.isFile()?(s.cookie("fileDownload","true"),s.download(r.resolve(d+"/"+_[0])),e(!0)):e()})},function(n){var f=r.resolve(e.get("config").dir.tmp).replace(/\\/,"/")+"/download_"+Date.now()+".zip",c=i.createWriteStream(f);archive=o("zip"),c.on("close",function(){i.exists(f,function(e){return e?(s.cookie("fileDownload","true"),s.download(f),n()):(a.error=t.__("download_error"),s.send(JSON.stringify(a)),n(!0))})}),archive.on("error",function(e){return a.error=t.__("download_error"),s.send(JSON.stringify(a)),n(!0)}),archive.pipe(c),u.eachSeries(_,function(e,r){i.stat(d+"/"+e,function(t,i){return t?r(!0):i.isDirectory()?(archive.bulk([{expand:!0,cwd:d+"/"+e,src:["**"],dest:e}]),r()):i.isFile()?(archive.file(d+"/"+e,{name:e}),r()):r()})},function(e){return archive.finalize(),n()})}]))}),n.post("/data/unzip",function(r,n){t.setLocale(r.session.current_locale);var o={};if(!r.session.auth||r.session.auth.status<2)return o.error=t.__("unauth"),void n.send(JSON.stringify(o));var _=r.body.file;if(!f(_))return o.error=t.__("no_file_sent"),void n.send(JSON.stringify(o));var d=r.body.dir;return d&&!c(d)?(o.error=t.__("invalid_dir"),void n.send(JSON.stringify(o))):(d=d?"/"+d:"",d=e.get("config").dir.storage+d,void u.series([function(e){i.exists(d,function(r){return r?e():(o.error=t.__("dir_not_exists"),n.send(JSON.stringify(o)),e(!0))})},function(e){i.exists(d+"/"+_,function(r){return r?e():(o.error=t.__("file_not_exists"),n.send(JSON.stringify(o)),e(!0))})},function(e){var r=s.lookup(d+"/"+_);if("application/zip"!=r)return o.error=t.__("not_a_zip_archive"),n.send(JSON.stringify(o)),e(!0);var u=i.createReadStream(d+"/"+_),f=u.pipe(a.Extract({path:d}));f.on("close",function(){return o.status=1,n.send(JSON.stringify(o)),e()})}]))});var f=function(e){if(!e)return!1;var r=String(e).replace(/^\s+|\s+$/g,"");return!r||r.length>80?!1:r.match(/^\./)?!1:r.match(/^[\^<>\:\"\/\\\|\?\*\x00-\x1f]+$/)?!1:!0},c=function(e){if(!e)return!0;var r=String(e).replace(/^\s+|\s+$/g,"");return r.length>40?!1:r.match(/^\./)?!1:r.match(/^\\/)?!1:r.match(/^[\^<>\:\"\\\|\?\*\x00-\x1f]+$/)?!1:!0};return n};