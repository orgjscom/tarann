module.exports=function(r){var e,i={},n={},o=require("path"),a=r.get("config"),t=require("fs");if(t.existsSync(o.join(__dirname,"config.js"))&&(e=require("./config")),!e&&t.existsSync(o.join(__dirname,"dist_config.js"))&&(e=require("./dist_config")),e)for(var u in e)a[u]=e[u];var v={};for(var s in a.menu.drivers)v[s]=require(o.join(__dirname,"templates",a.menu.drivers[s]))(r);var d={data:function(e,o,t){var u=e.session.current_locale;return i[u]&&Date.now()-i[u]<=6e4&&n[u]?t(n[u]):void r.get("mongodb").collection("menu").find({lang:u},{limit:1}).toArray(function(r,e){if(r)return t();var o={};if(e&&e.length&&e[0].menu_source){var s=e[0].menu_source;try{s=JSON.parse(s)}catch(d){s=void 0}if(s){var f={};for(var m in a.menu.drivers)f[a.menu.drivers[m]]="";var c="j1_1";for(var _ in s)"#"==s[_].parent&&(c=s[_].id);for(var l in s)if(s[l].parent==c){var g=s[l].id,h=[];for(var p in s)s[p].parent==g&&h.push(s[p]);if(h.length)for(var j in a.menu.drivers)f[a.menu.drivers[j]]+=v[j].node_with_child(s[l],h);else for(var q in v)f[a.menu.drivers[q]]+=v[q].node_without_child(s[l],h)}for(var w in a.menu.drivers)f[a.menu.drivers[w]]=v[w].root_template(f[a.menu.drivers[w]]),o[a.menu.drivers[w]]=f[a.menu.drivers[w]]}}n[u]=o,i[u]=Date.now(),t(n[u])})}};return d};