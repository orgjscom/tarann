module.exports=function(e){var t=e.get("express").Router(),n=require("path"),s=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:n.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode});return t.get_module_name=function(e){return s.setLocale(e.session.current_locale),s.__("module_name")},t.get("/",function(t,o){return s.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<2?(t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/cp/menu",void o.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""))):void e.get("mongodb").collection("pages").find({},{limit:100}).sort({ptitle:1}).toArray(function(r,a){var i=[];if("undefined"!=typeof a&&!r)for(var l=0;l<a.length;l++){var u={};a[l].pdata&&a[l].pdata[t.session.current_locale]&&a[l].pdata[t.session.current_locale].ptitle&&(u.ptitle=a[l].pdata[t.session.current_locale].ptitle),a[l].pfolder&&(u.purl=a[l].pfolder),"/"!=a[l].pfolder&&(u.purl+="/"),a[l].pfilename&&(u.purl+=a[l].pfilename),"/"!=a[l].pfolder&&(u.purl=u.purl.replace(/\/$/,"")),i.push(u)}var c=e.get("renderer").render_file(n.join(__dirname,"views"),"menu_control",{lang:s,locales:JSON.stringify(e.get("config").locales.avail),pages:JSON.stringify(i)},t);e.get("cp").render(t,o,{body:c,css:'<link rel="stylesheet" href="/modules/menu/css/main.css"><link rel="stylesheet" href="/js/jstree/theme/style.min.css">'},s,"menu",t.session.auth)})}),t.post("/data/load",function(t,n){s.setLocale(t.session.current_locale);for(var o={status:1},r=t.body.lng,a=e.get("config").locales.avail[0],i=0;i<e.get("config").locales.avail.length;i++)r==e.get("config").locales.avail[i]&&(a=e.get("config").locales.avail[i]);return r=a,!t.session.auth||t.session.auth.status<2?(o.status=0,o.error=s.__("unauth"),void n.send(JSON.stringify(o))):void e.get("mongodb").collection("menu").find({lang:r},{limit:1}).toArray(function(e,t){return e?(o.status=0,o.error=s.__("database_error"),void n.send(JSON.stringify(o))):("undefined"!=typeof t&&t&&t.length?o.menu_source=t[0].menu_source||"":o.menu_source="",void n.send(JSON.stringify(o)))})}),t.post("/data/save",function(t,n){s.setLocale(t.session.current_locale);var o={status:1},r=t.body.lng,a=t.body.menu_source||"";t.body.menu_uikit||"",t.body.menu_uikit_offcanvas||"",t.body.menu_raw||"";a=a.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ").replace(/\n/g,"");for(var i=e.get("config").locales.avail[0],l=0;l<e.get("config").locales.avail.length;l++)r==e.get("config").locales.avail[l]&&(i=e.get("config").locales.avail[l]);return r=i,!t.session.auth||t.session.auth.status<2?(o.status=0,o.error=s.__("unauth"),void n.send(JSON.stringify(o))):void e.get("mongodb").collection("menu").find({lang:r},{limit:1}).toArray(function(t,i){if(t)return o.status=0,o.error=s.__("database_error"),void n.send(JSON.stringify(o));var l={lang:r,menu_source:a};"undefined"!=typeof i&&i&&i.length?e.get("mongodb").collection("menu").update({lang:r},l,function(e){return e?(o.status=0,o.error=s.__("database_error"),void n.send(JSON.stringify(o))):(o.status=1,void n.send(JSON.stringify(o)))}):e.get("mongodb").collection("menu").insert(l,function(e){return e?(o.status=0,o.error=s.__("database_error"),void n.send(JSON.stringify(o))):(o.status=1,void n.send(JSON.stringify(o)))})})}),t};