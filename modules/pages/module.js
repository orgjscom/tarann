module.exports=function(e){var t=e.get("express").Router(),a=require("path"),r=require("gaikan"),i=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:a.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),n=require("html-entities").AllHtmlEntities;entities=new n,t.get(/(.*)/,function(t,a,n){var d=t.session.current_locale;i.setLocale(d);var s=t.params[0],c=s.split("/");c.forEach(function(e){return e.match(/ /)||e.match(/^[\^<>\/\:\"\\\|\?\*\x00-\x1f]+$/)?a.status(404):void 0});var p=c.join("/"),u="",_=s.split("/").slice(0,-1).join("/")||"/",g=c[c.length-1],m={$or:[{pfolder:p,pfilename:u},{pfolder:_,pfilename:g}]};e.get("mongodb").collection("pages_folders").find({oname:"folders_json"},{limit:1}).toArray(function(i,s){var c;c=s&&s.length&&s[0].ovalue?JSON.parse(s[0].ovalue):[{id:"j1_1",text:"/",data:null,parent:"#",type:"root"}],e.get("mongodb").collection("pages").find(m,{limit:1}).toArray(function(i,s){if(!i&&"undefined"!=typeof s&&s&&s.length&&!i){s[0].pdata||(s[0].pdata={}),s[0].pdata[d]||(s[0].pdata[d]={});for(var p=s[0].pfolder_id||"j1_1",u=o(l(c),p).reverse(),_='<li><a href="/">'+e.get("settings").site_title+"</a></li>",g="",m=[],f=0;f<u.length;f++){g+="/"+u[f].name;var b=u[f][t.session.current_locale]||u[f].name;_+='<li><a href="'+g+'">'+b+"</a></li>",m.push(b)}m=m.reverse(),_+="<li>"+s[0].pdata[d].ptitle+"</li>",bread_html_uikit='<ul class="uk-breadcrumb">'+_+"</ul>",bread_html_bootstrap='<ol class="breadcrumb">'+_+"</ol>";var h={title:s[0].pdata[d].ptitle,keywords:s[0].pdata[d].keywords,description:s[0].pdata[d].desc,bread:u,bread_html:_,bread_html_uikit:bread_html_uikit,bread_html_bootstrap:bread_html_bootstrap,current_lang:d},v="";h.blocks_sync={};try{Object.keys(e.get("blocks_sync")).forEach(function(t){var a=e.get("blocks_sync")[t];a&&(h.blocks_sync[t]=a)});var k=r.compileFromString(entities.decode(s[0].pdata[d].pcontent));v=k(r,h,void 0)}catch(y){}var j=s[0].pdata[d].ptitle;m.length&&(j+=" | "+m.join(" | "));var x={title:j,current_lang:d,page_title:s[0].pdata[d].ptitle,content:v,keywords:s[0].pdata[d].pkeywords,description:s[0].pdata[d].pdesc,bread:u,bread_html:_,bread_html_uikit:bread_html_uikit,bread_html_bootstrap:bread_html_bootstrap},w=s[0].pdata[d].playout||void 0;return e.get("renderer").render(a,w,x,t)}return n()})})});var l=function(e){for(var t={},a=0;a<e.length;a++)t[e[a].id]=e[a],delete t[e[a].id].id;return t},o=function(t,a,r){var i=r||[];if(t&&a&&t[a]&&t[a].parent&&"#"!=t[a].parent){var n={name:t[a].text},l=e.get("config").locales.avail;if(t[a].data&&t[a].data.lang)for(var d=0;d<l.length;d++)n[l[d]]=t[a].data.lang[l[d]];i.push(n),o(t,t[a].parent,i)}return i};return t};