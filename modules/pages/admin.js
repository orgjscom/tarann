module.exports=function(e){var t={pfolder:1,pfilename:1,plock:1,ptitle:1},n="pfolder",s=1,a=30,o=e.get("express").Router(),i=require("path"),r=require("mongodb").ObjectID,l=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:i.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),d=e.get("parser"),u=require("async");o.get_module_name=function(e){return l.setLocale(e.session.current_locale),l.__("module_name")},o.get("/",function(t,n){return l.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<2?(t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/cp/pages",void n.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""))):void e.get("mongodb").collection("pages_folders").find({oname:"folders_json"},{limit:1}).toArray(function(s,a){var o;o=a&&a.length&&a[0].ovalue?a[0].ovalue:'[{"id":"j1_1","text":"/","data":null,"parent":"#","type":"root"}]';var r=e.get("renderer").render_file(i.join(__dirname,"views"),"pages_control",{lang:l,folders:o,auth:t.session.auth,locales:JSON.stringify(e.get("config").locales.avail),layouts:JSON.stringify(e.get("config").layouts),current_locale:t.session.current_locale},t);e.get("cp").render(t,n,{body:r,css:'<link rel="stylesheet" href="/modules/pages/css/main.css"><link rel="stylesheet" href="/js/jstree/theme/style.min.css">'},l,"pages",t.session.auth)})}),o.post("/data/list",function(o,i){l.setLocale(o.session.current_locale);var r={ipp:a},d=o.body.skip,u=o.body.query,f=o.body.sort_mode,p=o.body.sort_cell;if("undefined"!=typeof d&&!d.match(/^[0-9]{1,10}$/))return r.status=0,r.error=l.__("invalid_query"),i.send(JSON.stringify(r));if("undefined"!=typeof u&&!u.match(/^[\w\sА-Яа-я0-9_\-\.]{3,40}$/))return r.status=0,r.error=l.__("invalid_query"),i.send(JSON.stringify(r));if(!o.session.auth||o.session.auth.status<2)return r.status=0,r.error=l.__("unauth"),i.send(JSON.stringify(r));var c={};c[n]=s,t&&t[p]&&(c={},c[p]=1,"undefined"!=typeof f&&-1==f&&(c[p]=-1)),r.items=[];var g={};if(u){g={$or:[{pfilename:new RegExp(u,"i")},{pfolder:new RegExp(u,"i")}]};var _={};_["pdata."+o.session.current_locale+".ptitle"]=new RegExp(u,"i"),g.$or.push(_)}e.get("mongodb").collection("pages").find(g).count(function(t,n){!t&&n>0?(r.total=n,e.get("mongodb").collection("pages").find(g,{skip:d,limit:a}).sort(c).toArray(function(e,t){if(!e&&t&&t.length)for(var n=0;n<t.length;n++){var s=[];s.push(t[n]._id),"/"!=t[n].pfolder&&(t[n].pfilename="/"+t[n].pfilename,t[n].pfilename=t[n].pfilename.replace(/\/$/,"")),s.push(t[n].pfolder+t[n].pfilename),t[n].pdata&&t[n].pdata[o.session.current_locale]&&s.push(t[n].pdata[o.session.current_locale].ptitle),s.push(t[n].plock),r.items.push(s)}r.status=1,i.send(JSON.stringify(r))})):(r.status=1,r.total="0",i.send(JSON.stringify(r)))})}),o.post("/data/list/all",function(t,n){var s=t.session.current_locale;if(l.setLocale(s),!t.session.auth||t.session.auth.status<2)return a.status=0,a.error=l.__("unauth"),void n.send(JSON.stringify(a));var a={items:[]},o={pfilename:1,pfolder:1},i={};o["pdata."+s+".ptitle"]=1,i["pdata."+s+".ptitle"]=1,e.get("mongodb").collection("pages").find({},o,{limit:1e3}).sort(i).toArray(function(e,t){if("undefined"!=typeof t&&!e)for(var o=0;o<t.length;o++){var i=[];"/"!=t[o].pfolder&&(t[o].pfilename="/"+t[o].pfilename,t[o].pfilename=t[o].pfilename.replace(/\/$/,"")),i.push(t[o].pfolder+t[o].pfilename),t[o].pdata[s]||(t[o].pdata[s]={}),i.push(t[o].pdata[s].ptitle),a.items.push(i)}a.status=1,n.send(JSON.stringify(a))})}),o.post("/data/rootpages",function(t,n){l.setLocale(t.session.current_locale);var s={};return!t.session.auth||t.session.auth.status<2?(s.status=0,s.error=l.__("unauth"),void n.send(JSON.stringify(s))):void e.get("mongodb").collection("pages").find({pfilename:""},{pfolder:1},{limit:1e3}).toArray(function(e,t){if(s.root_pages=[],!e&&"undefined"!=typeof t)for(var a=0;a<t.length;a++)s.root_pages.push(t[a].pfolder);s.status=1,n.send(JSON.stringify(s))})}),o.post("/data/load",function(t,n){l.setLocale(t.session.current_locale);var s={},a=t.body.pid,o=t.body.unlock;if(!a||!a.match(/^[a-f0-9]{24}$/))return s.status=0,s.error=l.__("invalid_query"),n.send(JSON.stringify(s));if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=l.__("unauth"),n.send(JSON.stringify(s));var i=[];u.series([function(t){e.get("mongodb").collection("pages").find({pfilename:""},{pfolder:1},{limit:1e3}).toArray(function(e,n){if(!e&&"undefined"!=typeof n)for(var s=0;s<n.length;s++)i.push(n[s].pfolder);t()})},function(t){o?e.get("mongodb").collection("pages").update({_id:new r(a)},{$set:{plock:""}},function(e){return t()}):t()},function(t){e.get("mongodb").collection("pages").find({_id:new r(a)}).toArray(function(e,n){return!e&&n&&n.length?(s.status=1,s.pages_data=n[0],s.root_pages=i,t()):(s.status=0,s.error=l.__("no_results_in_table"),t(!0))})},function(n){s.pages_data&&!s.pages_data.plock?e.get("mongodb").collection("pages").update({_id:new r(a)},{$set:{plock:t.session.auth.username}},function(e){return n()}):n()}],function(e){return n.send(JSON.stringify(s))})}),o.post("/data/unlock",function(t,n){l.setLocale(t.session.current_locale);var s={},a=t.body.pid;return a&&a.match(/^[a-f0-9]{24}$/)?!t.session.auth||t.session.auth.status<2?(s.status=0,s.error=l.__("unauth"),n.send(JSON.stringify(s))):void u.series([function(t){e.get("mongodb").collection("pages").update({_id:new r(a)},{$set:{plock:void 0}},function(e){return t()})}],function(e){return n.send(JSON.stringify(s))}):(s.status=0,s.error=l.__("invalid_query"),n.send(JSON.stringify(s)))}),o.post("/data/save",function(t,n){l.setLocale(t.session.current_locale);var s={err_fields:[],status:1};if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=l.__("unauth"),void n.send(JSON.stringify(s));var a=t.body.save_data;if(!a)return s.status=0,s.error=l.__("invalid_query"),n.send(JSON.stringify(s));if(a._id&&!a._id.match(/^[a-f0-9]{24}$/))return s.status=0,s.error=l.__("invalid_query"),n.send(JSON.stringify(s));if(!a.pfolder_id||!a.pfolder_id.match(/^[A-Za-z0-9_\-\.]{1,20}$/))return s.status=0,s.error=l.__("invalid_folder"),n.send(JSON.stringify(s));if(a.pfilename&&(!a.pfilename||!a.pfilename.match(/^[A-Za-z0-9_\-\.]{0,80}$/)))return s.status=0,s.error=l.__("invalid_pfilename"),n.send(JSON.stringify(s));if(a.pfilename||(a.pfilename=""),!a.pdata||"object"!=typeof a.pdata)return s.status=0,s.error=l.__("invalid_query"),n.send(JSON.stringify(s));for(var o in a.pdata){if(!a.pdata[o].ptitle||a.pdata[o].ptitle.length>100)return s.status=0,s.error=l.__("invalid_query"),n.send(JSON.stringify(s));for(var i=e.get("config").locales.avail[0],f=0;f<e.get("config").locales.avail.length;f++)a.pdata[o].plang==e.get("config").locales.avail[f]&&(i=e.get("config").locales.avail[f]);a.pdata[o].plang=i;for(var p=e.get("config").layouts["default"],c=0;c<e.get("config").layouts.avail.length;c++)a.pdata[o].playout==e.get("config").layouts.avail[c]&&(p=e.get("config").layouts.avail[c]);a.pdata[o].playout=p}var g={pfilename:a.pfilename,pfolder:a.pfolder,pfolder_id:a.pfolder_id,pdata:{}};for(var _ in e.get("config").locales.avail)if(a.pdata[e.get("config").locales.avail[_]]){var v=e.get("config").locales.avail[_];g.pdata[v]={};try{g.pdata[v].ptitle=a.pdata[v].ptitle,g.pdata[v].pkeywords=a.pdata[v].pkeywords,g.pdata[v].pdesc=a.pdata[v].pdesc,g.pdata[v].pcontent=a.pdata[v].pcontent,g.pdata[v].playout=a.pdata[v].playout}catch(y){return s.status=0,s.error=l.__("invalid_query")+" ("+y+")",n.send(JSON.stringify(s))}}u.series([function(n){a._id?e.get("mongodb").collection("pages").find({_id:new r(a._id)},{plock:1}).toArray(function(e,a){return a&&a.length&&a[0].plock&&a[0].plock!=t.session.auth.username?(s.status=0,s.error=l.__("locked_by")+": "+a[0].plock,n(!0)):void n()}):n()},function(t){var n={pfilename:a.pfilename,pfolder:a.pfolder};a._id&&(n._id={$ne:new r(a._id)}),e.get("mongodb").collection("pages").find(n,{pfilename:1},{limit:1}).toArray(function(e,n){return e||n&&n.length?(s.status=0,s.error=l.__("page_exists"),t(!0)):void t()})},function(t){var n={pfilename:a.pfilename,pfolder:a.pfolder};a._id&&(n={_id:new r(a._id)}),e.get("mongodb").collection("pages").update(n,g,{safe:!1,upsert:!0},function(e,n){return e?t(!0):(n&&n._id&&(a._id=n._id),t())})},function(t){var n=[];for(var s in a.pdata)n.push({pr:d.words(d.html2text(a.pdata[s].pcontent),a.pdata[s].ptitle),title:a.pdata[s].ptitle,lang:s,desc:a.pdata[s].pdesc});u.eachSeries(n,function(t,n){var s={swords:t.pr.words,sdesc:t.pr.desc,stitle:t.title,slang:t.lang,item_id:a._id,surl:(a.pfolder+"/"+a.pfilename).replace(/(\/+)/,"/"),space:"pages"};e.get("mongodb").collection("search_index").update({item_id:a._id,slang:t.lang},s,{upsert:!0,safe:!1},function(){n()})},function(e){t()})}],function(e){return n.send(JSON.stringify(s))})}),o.post("/data/delete",function(t,n){l.setLocale(t.session.current_locale);var s={status:1};if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=l.__("unauth"),void n.send(JSON.stringify(s));var a=t.body.ids;if("object"!=typeof a||a.length<1)return s.status=0,s.error=l.__("invalid_query"),void n.send(JSON.stringify(s));for(var o=0;o<a.length;o++)a[o].match(/^[a-f0-9]{24}$/)&&(e.get("mongodb").collection("pages").remove({_id:new r(a[o])},f),e.get("mongodb").collection("search_index").remove({item_id:a[o]},f));n.send(JSON.stringify(s))});var f=function(){};return o.post("/data/folders/load",function(t,n){l.setLocale(t.session.current_locale);var s={status:1};return!t.session.auth||t.session.auth.status<2?(s.status=0,s.error=l.__("unauth"),void n.send(JSON.stringify(s))):void e.get("mongodb").collection("pages_folders").find({oname:"folders_json"},{limit:1}).toArray(function(e,t){return e?(s.status=0,s.error=l.__("cannot_load_db_data"),void n.send(JSON.stringify(s))):t&&t.length&&t[0].ovalue?(s.folders=t[0].ovalue,void n.send(JSON.stringify(s))):(s.folders='[{"id":"j1_1","text":"/","data":null,"parent":"#","type":"root"}]',void n.send(JSON.stringify(s)))})}),o.post("/data/folders/save",function(t,n){l.setLocale(t.session.current_locale);var s={status:1};if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=l.__("unauth"),void n.send(JSON.stringify(s));var a=t.body.json;try{JSON.parse(a)}catch(o){return s.status=0,s.error=l.__("cannot_parse_json"),void n.send(JSON.stringify(s))}e.get("mongodb").collection("pages_folders").remove(function(t){t||e.get("mongodb").collection("pages_folders").insert({oname:"folders_json",ovalue:a},function(e){return e?(s.status=0,s.error=l.__("cannot_save_db_data"),void n.send(JSON.stringify(s))):void n.send(JSON.stringify(s))})})}),o};