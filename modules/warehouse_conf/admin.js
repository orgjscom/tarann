module.exports=function(e){var i=e.get("express").Router(),t=require("path"),a=(require("mongodb").ObjectID,new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:t.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode})),r=require("util");return i.get_module_name=function(e){return a.setLocale(e.session.current_locale),a.__("module_name_cp")},i.get("/",function(i,r){return a.setLocale(i.session.current_locale),!i.session.auth||i.session.auth.status<2?(i.session.auth_redirect_host=i.get("host"),i.session.auth_redirect="/cp/warehouse_conf",void r.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""))):void e.get("mongodb").collection("warehouse_conf").find({$or:[{conf:"items"},{conf:"collections"},{conf:"curs"},{conf:"ship"},{conf:"misc"}]}).toArray(function(s,o){var c=[],n=[],l=[],g=[],f=[];if(!s&&o&&o.length)for(var d=0;d<o.length;d++){if("items"==o[d].conf&&o[d].data)try{c=JSON.parse(o[d].data)}catch(u){}if("collections"==o[d].conf&&o[d].data)try{n=JSON.parse(o[d].data)}catch(u){}if("curs"==o[d].conf&&o[d].data)try{l=JSON.parse(o[d].data)}catch(u){}if("ship"==o[d].conf&&o[d].data)try{g=JSON.parse(o[d].data)}catch(u){}if("misc"==o[d].conf&&o[d].data)try{f=JSON.parse(o[d].data)}catch(u){}}var h=e.get("renderer").render_file(t.join(__dirname,"views"),"warehouse_conf_cp",{lang:a,auth:i.session.auth,init_descitems:JSON.stringify(c),items:JSON.stringify(c),collections:JSON.stringify(n),curs:JSON.stringify(l),ship:JSON.stringify(g),misc:JSON.stringify(f),current_locale:i.session.current_locale,locales:JSON.stringify(e.get("config").locales.avail)},i);e.get("cp").render(i,r,{body:h,css:'<link rel="stylesheet" href="/modules/warehouse_conf/css/main.css">'},a,"warehouse_conf_cp",i.session.auth)})}),i.post("/config/save",function(i,t){a.setLocale(i.session.current_locale);var s={status:1};if(!i.session.auth||i.session.auth.status<2)return s.status=0,s.error=a.__("unauth"),void t.send(JSON.stringify(s));var o=i.body.descitems,c=[],n=i.body.collections,g=i.body.curs,f=[],d=i.body.ship,u=[],h=i.body.misc,p=[];if(o&&r.isArray(o))for(var m=0;m<o.length;m++){var v={};if(o[m].id&&o[m].id.match(/^[a-z0-9\-_]{1,50}$/i)){for(v.id=o[m].id,l=0;l<e.get("config").locales.avail.length;l++){var _=o[m][e.get("config").locales.avail[l]];_&&(_=_.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),v[e.get("config").locales.avail[l]]=_)}c.push(v)}}if(g&&r.isArray(g))for(var y=0;y<g.length;y++){var N={};if(g[y].id&&g[y].id.match(/^[a-z0-9\-_]{1,50}$/i)){for(N.id=g[y].id,N.exr=g[y].exr,N.exr&&(N.exr=parseFloat(N.exr)),isNaN(N.exr)&&(N.exr=""),l=0;l<e.get("config").locales.avail.length;l++){var O=g[y][e.get("config").locales.avail[l]];O&&(O=O.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),N[e.get("config").locales.avail[l]]=O)}f.push(N)}}if(d&&r.isArray(d))for(var S=0;S<d.length;S++){var J={};if(d[S].id&&d[S].id.match(/^[a-z0-9\-_]{1,50}$/i)){for(J.id=d[S].id,J.weight=d[S].weight,J.weight&&(J.weight=parseFloat(J.weight)),isNaN(J.weight)&&(J.weight=""),J.amnt=d[S].amnt,J.amnt&&(J.amnt=parseInt(J.amnt)),isNaN(J.amnt)&&(J.amnt=""),J.price=d[S].price,J.price&&(J.price=parseFloat(J.price)),isNaN(J.price)&&(J.price=""),l=0;l<e.get("config").locales.avail.length;l++){var w=d[S][e.get("config").locales.avail[l]];w&&(w=w.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),J[e.get("config").locales.avail[l]]=w)}u.push(J)}}if(h&&r.isArray(h))for(var b=0;b<h.length;b++){var q={};if(h[b].id&&"weight_units"==h[b].id){for(q.id=h[b].id,l=0;l<e.get("config").locales.avail.length;l++){var x=h[b][e.get("config").locales.avail[l]];x&&(x=x.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;"),q[e.get("config").locales.avail[l]]=x)}p.push(q)}}if(n&&r.isArray(n))for(var A=0;A<n.length;A++)if(n[A].id&&(n[A].id=n[A].id.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;")),n[A].items)for(ci=0;ci<n[A].items;ci++)n[A].items[ci]=n[A].items[ci].replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");e.get("mongodb").collection("warehouse_conf").remove({},function(){e.get("mongodb").collection("warehouse_conf").insert([{conf:"items",data:JSON.stringify(c)},{conf:"collections",data:JSON.stringify(n)},{conf:"curs",data:JSON.stringify(g)},{conf:"ship",data:JSON.stringify(d)},{conf:"misc",data:JSON.stringify(p)}],function(e){return e?(s.status=0,t.send(JSON.stringify(s))):t.send(JSON.stringify(s))})})}),i};