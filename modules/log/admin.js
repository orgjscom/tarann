module.exports=function(e){var t=e.get("express").Router(),s=require("path"),i=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:s.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),r=require("fs"),n=100,o=require("gaikan"),l=o.compileFromFile(r.existsSync(s.join(__dirname,"views")+"/custom_parts_table.html")?s.join(__dirname,"views")+"/custom_parts_table.html":s.join(__dirname,"views")+"/parts_table.html"),a=o.compileFromFile(r.existsSync(s.join(__dirname,"views")+"/custom_parts_table_tr.html")?s.join(__dirname,"views")+"/custom_parts_table_tr.html":s.join(__dirname,"views")+"/parts_table_tr.html"),_=o.compileFromFile(r.existsSync(s.join(__dirname,"views")+"/custom_parts_stack_btn.html")?s.join(__dirname,"views")+"/custom_parts_stack_btn.html":s.join(__dirname,"views")+"/parts_stack_btn.html");return t.get_module_name=function(e){return i.setLocale(e.session.current_locale),i.__("module_name_cp")},t.get("/",function(t,c){if(i.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<2)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/cp/log",void c.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var m={lang:i,auth:t.session.auth,log_html:""};r.exists(e.get("config").log.file.filename,function(d){return d?void r.readFile(e.get("config").log.file.filename,function(r,d){if(r)return m.log_html=i.__("cannot_read_log"),e.get("cp").render(t,c,{body:e.get("renderer").render_file(s.join(__dirname,"views"),"log",m,t),css:'<link rel="stylesheet" href="/modules/log/css/main.css">'},i,"log",t.session.auth);var g=d.toString().split("\n"),u="";g&&(g=g.reverse());for(var h in g)if(n>=h){var v;try{v=JSON.parse(g[h])}catch(f){}if(v){var p="";v.stack&&(p=_(o,{lang:i,stack:v.stack},void 0)),u+=a(o,{lang:i,item:v,stack_btn:p},void 0)}}return u.length&&(m.log_html=l(o,{lang:i,rows:u,total:g.length-1},void 0)),u||(m.log_html=i.__("no_log_file_available_yet")),e.get("cp").render(t,c,{body:e.get("renderer").render_file(s.join(__dirname,"views"),"log",m,t),css:'<link rel="stylesheet" href="/modules/log/css/main.css">'},i,"log",t.session.auth)}):(m.log_html=i.__("no_log_file_available_yet"),e.get("cp").render(t,c,{body:e.get("renderer").render_file(s.join(__dirname,"views"),"log",m,t),css:'<link rel="stylesheet" href="/modules/log/css/main.css">'},i,"log",t.session.auth))})}),t};