module.exports=function(e){var r=30,t=require("path"),s=e.get("express").Router(),n=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:t.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),i=e.get("renderer"),o=e.get("parser");return s.get("/",function(r,s){n.setLocale(r.session.current_locale);var o={title:n.__("module_name"),page_title:n.__("module_name"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/search/css/main.css" type="text/css">'},a=i.render_file(t.join(__dirname,"views"),"search",{lang:n,data:o},r);o.content=a,e.get("renderer").render(s,void 0,o,r)}),s.post("/data",function(t,s){n.setLocale(t.session.current_locale);var i={ipp:r},a=t.body.skip,d=t.body.query;if("undefined"!=typeof a&&!a.match(/^[0-9]{1,10}$/))return i.status=0,i.error=n.__("invalid_query"),void s.send(JSON.stringify(i));if(!d)return i.status=0,i.error=n.__("invalid_query"),void s.send(JSON.stringify(i));var l=o.words(d).words.split(/ /);if(!l||!l.length)return i.status=0,i.error=n.__("invalid_query"),void s.send(JSON.stringify(i));l=o.stem_all(l);for(var u=[],c=0;c<l.length;c++)if(l[c]){var _=new RegExp(l[c],"i");u.push({swords:{$regex:_}})}i.items=[];var f={slang:t.session.current_locale,$and:u};e.get("mongodb").collection("search_index").find(f).count(function(t,n){!t&&n>0?(i.total=n,e.get("mongodb").collection("search_index").find(f,{skip:a,limit:r}).toArray(function(e,r){if("undefined"!=typeof r&&!e)for(var t=0;t<r.length;t++){var n=[];n.push(r[t].stitle),n.push(r[t].sdesc),n.push(r[t].surl),i.items.push(n)}i.status=1,s.send(JSON.stringify(i))})):(i.status=1,i.total="0",s.send(JSON.stringify(i)))})}),s};