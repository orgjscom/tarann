module.exports=function(e){var t=e.get("express").Router(),r=require("path"),s=e.get("renderer"),i=e.get("config"),n=e.get("mailer"),a=require("crypto"),o=new(require("i18n-2"))({locales:i.locales.avail,directory:r.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),d=require("async"),_=e.get("config_auth");for(var c in _)e.use("/auth/",require("./providers/"+c)(e));var u=!1;e.get("config").graphicsmagick&&(u=require("gm"));var l=require("fs-extra"),f=require("mongodb").ObjectID;t.get("/captcha",function(t,r){var s=parseInt(9e3*Math.random()+1e3);t.session.captcha=s;var i=e.get("captcha").generate(s);i.png?(r.set("Content-Type","image/png"),i.png.stream(function(e,t,s){return e?next(e):void t.pipe(r)})):next()}),t.post("/captcha",function(t,r){var s=parseInt(9e3*Math.random()+1e3);t.session.captcha=s;var i=e.get("captcha").generate(s);i.b64?r.send(JSON.stringify({img:i.b64})):next()}),t.get("/",function(t,n){if(o.setLocale(t.session.current_locale),"undefined"!=typeof t.session&&"undefined"!=typeof t.session.auth&&t.session.auth!==!1)return void n.redirect(303,"/?rnd="+Math.random().toString().replace(".",""));var a=(parseInt(9e3*Math.random()+1e3),"b64");"captcha_gm"==e.get("config").captcha&&(a="png");var d=!1;t.session.captcha_req&&(d=!0);var c={title:o.__("auth"),page_title:o.__("auth"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/auth/css/user_auth.css" type="text/css">'},u=JSON.parse(JSON.stringify(_));for(var l in u)u[l].clientSecret&&delete u[l].clientSecret;e.get("settings")&&e.get("settings").site_mode&&("private"==e.get("settings").site_mode||"invites"==e.get("settings").site_mode)&&(u=[]);var f=i.protocol+"://"+t.get("host");t.session.auth_redirect_host?f=i.protocol+"://"+t.session.auth_redirect_host:t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect||(t.session.auth_redirect="/auth/profile?rnd="+Math.random().toString().replace(".",""));var g=s.render_file(r.join(__dirname,"views"),"login_user",{lang:o,captcha:a,captcha_req:d,data:c,redirect:t.session.auth_redirect,redirect_host:f,config_auth:JSON.stringify(u)},t);c.content=g,e.get("renderer").render(n,void 0,c,t)}),t.get("/cp",function(t,n){if(o.setLocale(t.session.current_locale),"undefined"!=typeof t.session&&"undefined"!=typeof t.session.auth&&t.session.auth!==!1)return void n.redirect(303,"/?rnd="+Math.random().toString().replace(".",""));var a=(parseInt(9e3*Math.random()+1e3),"b64");"captcha_gm"==e.get("config").captcha&&(a="png");var d=!1;t.session.captcha_req&&(d=!0);var _="";t.session.auth_redirect_host&&(_=i.protocol+"://"+t.session.auth_redirect_host);var c=s.render_file(r.join(__dirname,"views"),"login_cp",{lang:o,captcha:a,captcha_req:d,redirect_host:_,redirect:t.session.auth_redirect},t);n.send(c)}),t.get("/register",function(t,n){return o.setLocale(t.session.current_locale),"undefined"!=typeof t.session&&"undefined"!=typeof t.session.auth&&t.session.auth!==!1?void n.redirect(303,"/?rnd="+Math.random().toString().replace(".","")):void d.series([function(r){if(e.get("settings")&&e.get("settings").site_mode){if("private"==e.get("settings").site_mode)return g(t,n,o.__("register_not_allowed")),r(!0);if("invites"==e.get("settings").site_mode){var s=t.query.inv;if(!s||!s.match(/^[a-f0-9]{64}$/))return g(t,n,o.__("invite_required_to_register")),r(!0);e.get("mongodb").collection("invites").find({invcode:s},{limit:1}).toArray(function(e,s){return!e&&s&&s.length?"0"!=s[0].invused?(g(t,n,o.__("invite_already_used")),r(!0)):void 0:(g(t,n,o.__("invite_required_to_register")),r(!0))})}}r()},function(a){var d=t.query.inv;d&&d.match(/^[a-f0-9]{64}$/)||(d="");var _=(parseInt(9e3*Math.random()+1e3),"b64");"captcha_gm"==e.get("config").captcha&&(_="png");var c={title:o.__("register"),page_title:o.__("register"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/auth/css/register.css" type="text/css">'},u="";t.session.auth_redirect_host&&(u=i.protocol+"://"+t.session.auth_redirect_host);var l=s.render_file(r.join(__dirname,"views"),"register",{lang:o,captcha:_,captcha_req:!0,data:c,invcode:d,redirect_host:u,redirect:t.session.auth_redirect},t);return c.content=l,e.get("renderer").render(n,void 0,c,t),a()}])}),t.post("/register/process",function(t,s){if(s.setHeader("Content-Type","application/json"),o.setLocale(t.session.current_locale),e.get("settings")&&e.get("settings").site_mode&&"private"==e.get("settings").site_mode)return s.send(JSON.stringify({result:0,error:o.__("register_not_allowed")}));var _=t.body.username,c=t.body.password,u=t.body.email,l=t.body.captcha;if(!l.match(/^[0-9]{4}$/))return void s.send(JSON.stringify({result:0,field:"reg_captcha",error:o.__("invalid_captcha")}));if(l!=t.session.captcha)return t.session.captcha=0,void s.send(JSON.stringify({result:0,field:"reg_captcha",error:o.__("invalid_captcha")}));if(t.session.captcha=0,"undefined"==typeof _||"undefined"==typeof c)return void s.send(JSON.stringify({result:0,error:o.__("username_password_missing")}));if(!_.match(/^[A-Za-z0-9_\-]{3,20}$/))return void s.send(JSON.stringify({result:0,field:"reg_username",error:o.__("invalid_username_syntax")}));if(!c.match(/^.{8,80}$/))return void s.send(JSON.stringify({result:0,field:"reg_password",error:o.__("invalid_password_syntax")}));if(!u.match(/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/))return void s.send(JSON.stringify({result:0,field:"reg_email",error:o.__("invalid_email_syntax")}));var f=_.toLowerCase();u=u.toLowerCase();var g=a.createHash("md5"),p=g.update(i.salt+"."+c).digest("hex");d.series([function(r){if(e.get("settings")&&e.get("settings").site_mode&&"invites"==e.get("settings").site_mode){var i=t.body.invcode;if(!i||!i.match(/^[a-f0-9]{64}$/))return s.send(JSON.stringify({result:0,field:"reg_captcha",error:o.__("invalid_invcode")})),r(!0);e.get("mongodb").collection("invites").find({invcode:i},{limit:1}).toArray(function(t,i){return!t&&i&&i.length?"0"!=i[0].invused?(s.send(JSON.stringify({result:0,field:"reg_captcha",error:o.__("invite_already_used")})),r(!0)):void e.get("mongodb").collection("invites").update({_id:i[0]._id},{$set:{invused:_}},function(e){return e?(s.send(JSON.stringify({result:0,field:"reg_captcha",error:o.__("invite_already_used")})),r(!0)):void 0}):(s.send(JSON.stringify({result:0,field:"reg_captcha",error:o.__("invite_required_to_register")})),r(!0))})}r()},function(d){e.get("mongodb").collection("users").find({$or:[{username_auth:f},{email:u}]},{limit:1}).toArray(function(c,l){if(c)return s.send(JSON.stringify({result:0,error:o.__("reg_failed")})),d();if("undefined"!=typeof l&&l.length>0)return s.send(JSON.stringify({result:0,field:"reg_username",error:o.__("username_or_email_already_registered")})),d();var g=a.createHash("md5"),h=g.update(i.salt+"."+Date.now()).digest("hex");e.get("mongodb").collection("users").insert({username:_,username_auth:f,password:p,email:u,act_code:h,regdate:Date.now(),status:0},function(a,_){if(a)return s.send(JSON.stringify({result:0,error:o.__("reg_failed")})),d();var c=_[0]._id.toHexString(),l=i.protocol+"://"+t.get("host")+"/auth/activate?user="+c+"&code="+h;n.send(u,o.__("mail_register_on")+": "+e.get("settings").site_title,r.join(__dirname,"views"),"mail_register_html","mail_register_txt",{lang:o,site_title:e.get("settings").site_title,register_url:l},t,function(){t.session.captcha_req=!1,s.send(JSON.stringify({result:1}))})})})}])}),t.get("/activate",function(t,n){o.setLocale(t.session.current_locale);var a,d=t.query.user,_=t.query.code;("undefined"==typeof d||"undefined"==typeof _)&&(a=o.__("userid_or_code_missing")),d.match(/^[a-f0-9]{24}$/)||(a=o.__("invalid_userid_syntax")),_.match(/^[a-f0-9]{32}$/)||(a=o.__("invalid_code_syntax"));var c={title:o.__("activate"),page_title:o.__("activate"),keywords:"",description:"",extra_css:""};if(a){var u="";return t.session.auth_redirect_host&&(u=i.protocol+"://"+t.session.auth_redirect_host),c.content=s.render_file(r.join(__dirname,"views"),"activate",{lang:o,data:c,act_res:a,act_status:!1,redirect_host:u,redirect:t.session.auth_redirect},t),void e.get("renderer").render(n,void 0,c,t)}e.get("mongodb").collection("users").find({_id:new f(d),act_code:_,status:0},{limit:1}).toArray(function(_,u){if(_||"undefined"==typeof u||0===u.length){var l="";return t.session.auth_redirect_host&&(l=i.protocol+"://"+t.session.auth_redirect_host),c.content=s.render_file(r.join(__dirname,"views"),"activate",{lang:o,data:c,act_res:o.__("unable_to_activate"),act_status:!1,redirect_host:l,redirect:t.session.auth_redirect},t),e.get("renderer").render(n,void 0,c,t)}e.get("mongodb").collection("users").update({_id:new f(d)},{$set:{act_code:null,status:1}},function(_){var l=!0,g=o.__("activation_success");_?(a=o.__("unable_to_activate"),l=!1):(t.session.auth=u[0],t.session.auth.timestamp=Date.now());var p="";t.session.auth_redirect_host&&(p=i.protocol+"://"+t.session.auth_redirect_host),c.content=s.render_file(r.join(__dirname,"views"),"activate",{lang:o,data:c,act_res:g,act_status:l,redirect_host:p,redirect:t.session.auth_redirect},t),e.get("mongodb").collection("users").find({_id:new f(d)},{limit:1}).toArray(function(r,s){return"undefined"!=typeof s&&!r&&s.length>0&&s[0].status>0?(t.session.captcha_req=!1,t.session.auth=s[0],t.session.auth.timestamp=Date.now(),delete t.session.auth.password,e.get("renderer").render(n,void 0,c,t)):(c.act_res=o.__("unable_to_activate"),c.act_status=!1,e.get("renderer").render(n,void 0,c,t))})})})}),t.get("/reset",function(t,n){if(o.setLocale(t.session.current_locale),"undefined"!=typeof t.session&&"undefined"!=typeof t.session.auth&&t.session.auth!==!1)return void n.redirect(303,"/?rnd="+Math.random().toString().replace(".",""));var a=(parseInt(9e3*Math.random()+1e3),"b64");"captcha_gm"==e.get("config").captcha&&(a="png");var d={title:o.__("reset"),page_title:o.__("reset"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/auth/css/reset.css" type="text/css">'},_="";t.session.auth_redirect_host&&(_=i.protocol+"://"+t.session.auth_redirect_host);var c=s.render_file(r.join(__dirname,"views"),"reset",{lang:o,captcha:a,captcha_req:!0,data:d,redirect_host:_,redirect:t.session.auth_redirect},t);d.content=c,e.get("renderer").render(n,void 0,d,t)}),t.post("/reset/process",function(t,s){s.setHeader("Content-Type","application/json"),o.setLocale(t.session.current_locale);var d=t.body.email,_=t.body.captcha;return _.match(/^[0-9]{4}$/)?_!=t.session.captcha?(t.session.captcha=0,void s.send(JSON.stringify({result:0,field:"reset_captcha",error:o.__("invalid_captcha")}))):(t.session.captcha=0,d.match(/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/)?(d=d.toLowerCase(),void e.get("mongodb").collection("users").find({email:d},{limit:1}).toArray(function(_,c){if(_)return void s.send(JSON.stringify({result:0,error:o.__("reset_failed")}));if("undefined"==typeof c||!c.length)return void s.send(JSON.stringify({result:0,field:"reset_email",error:o.__("email_not_registered")}));var u=a.createHash("md5"),l=u.update(i.salt+"."+Date.now()).digest("hex");e.get("mongodb").collection("users").update({_id:c[0]._id},{$set:{res_code:l}},function(a){if(a)return void s.send(JSON.stringify({result:0,error:o.__("reset_failed")}));var _=c[0]._id.toHexString(),u=i.protocol+"://"+t.get("host")+"/auth/password?user="+_+"&code="+l;n.send(d,o.__("mail_reset_on")+": "+e.get("settings").site_title,r.join(__dirname,"views"),"mail_reset_html","mail_reset_txt",{lang:o,site_title:e.get("settings").site_title,reset_url:u},t,function(){t.session.captcha_req=!1,s.send(JSON.stringify({result:1}))})})})):void s.send(JSON.stringify({result:0,field:"reset_email",error:o.__("invalid_email_syntax")}))):void s.send(JSON.stringify({result:0,field:"reset_captcha",error:o.__("invalid_captcha")}))}),t.get("/password",function(t,i){o.setLocale(t.session.current_locale);var n,a=t.query.user,d=t.query.code;("undefined"==typeof a||"undefined"==typeof d)&&(n=o.__("userid_or_code_missing")),a.match(/^[a-f0-9]{24}$/)||(n=o.__("invalid_userid_syntax")),d.match(/^[a-f0-9]{32}$/)||(n=o.__("invalid_code_syntax"));var _={title:o.__("password_change"),page_title:o.__("password_change"),keywords:"",description:"",extra_css:""};return n?(_.content=s.render_file(r.join(__dirname,"views"),"password",{lang:o,data:_,reset_res:n,reset_status:!1,user:"",code:""},t),void e.get("renderer").render(i,void 0,_,t)):void e.get("mongodb").collection("users").find({_id:new f(a),res_code:d,status:{$ne:0}},{limit:1}).toArray(function(n,c){return n||"undefined"==typeof c||0===c.length?(_.content=s.render_file(r.join(__dirname,"views"),"password",{lang:o,data:_,reset_res:o.__("unable_to_reset"),reset_status:!1,user:"",code:""},t),e.get("renderer").render(i,void 0,_,t)):(_.content=s.render_file(r.join(__dirname,"views"),"password",{lang:o,data:_,reset_res:o.__("fill_the_form_to_set_new_password"),reset_status:!0,user:a,code:d},t),e.get("renderer").render(i,void 0,_,t))})}),t.post("/password/process",function(t,r){r.setHeader("Content-Type","application/json"),o.setLocale(t.session.current_locale);var s=t.body.password,n=t.body.user,d=t.body.code;if("undefined"==typeof s)return void r.send(JSON.stringify({result:0,error:o.__("password_missing")}));if(!s.match(/^.{8,80}$/))return void r.send(JSON.stringify({result:0,field:"reg_password",error:o.__("invalid_password_syntax")}));if(!n.match(/^[a-f0-9]{24}$/))return void r.send(JSON.stringify({result:0,error:o.__("invalid_userid_syntax")}));if(!d.match(/^[a-f0-9]{32}$/))return void r.send(JSON.stringify({result:0,error:o.__("invalid_code_syntax")}));var _=a.createHash("md5"),c=_.update(i.salt+"."+s).digest("hex");e.get("mongodb").collection("users").find({_id:new f(n),res_code:d},{limit:1}).toArray(function(t,s){return t?void r.send(JSON.stringify({result:0,error:o.__("unable_to_reset")})):"undefined"!=typeof s&&s.length?void e.get("mongodb").collection("users").update({_id:new f(n)},{$set:{res_code:"",password:c}},function(e,t){return e?void r.send(JSON.stringify({result:0,error:o.__("unable_to_reset")})):void r.send(JSON.stringify({result:1}))}):void r.send(JSON.stringify({result:0,field:"pwd_password",error:o.__("unable_to_reset")}))})}),t.get("/logout",function(t,i){if(o.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<1)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/auth/profile",void i.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));delete t.session.auth;var n={title:o.__("logout"),page_title:o.__("logout"),keywords:"",description:"",extra_css:""},a=s.render_file(r.join(__dirname,"views"),"logout",{lang:o,data:n},t);n.content=a,e.get("renderer").render(i,void 0,n,t)}),t.post("/process",function(t,r){r.setHeader("Content-Type","application/json"),o.setLocale(t.session.current_locale);var s=t.body.username,n=t.body.password,d=t.body.captcha;if(t.session.captcha_req){if(!d.match(/^[0-9]{4}$/))return void r.send(JSON.stringify({result:0,field:"auth_captcha",error:o.__("invalid_captcha")}));if(d!=t.session.captcha)return t.session.captcha=0,void r.send(JSON.stringify({result:0,field:"auth_captcha",error:o.__("invalid_captcha")}))}if(t.session.captcha=0,"undefined"==typeof s||"undefined"==typeof n)return void r.send(JSON.stringify({result:0,error:o.__("username_password_missing")}));if(!s.match(/^[A-Za-z0-9_\-]{3,20}$/))return void r.send(JSON.stringify({result:0,field:"auth_username",error:o.__("invalid_username_syntax")}));if(!n.match(/^.{5,80}$/))return void r.send(JSON.stringify({result:0,field:"auth_password",error:o.__("invalid_password_syntax")}));s=s.toLowerCase();var _=a.createHash("md5"),c=_.update(i.salt+"."+n).digest("hex");e.get("mongodb").collection("users").find({username_auth:s,password:c},{limit:1}).toArray(function(e,s){return"undefined"!=typeof s&&!e&&s.length>0&&s[0].status>0?(t.session.captcha_req=!1,t.session.auth=s[0],t.session.auth.timestamp=Date.now(),delete t.session.auth.password,void r.send(JSON.stringify({result:1}))):(t.session.captcha_req=!0,void r.send(JSON.stringify({result:0,field:"auth_password",error:o.__("auth_failed")})))})}),t.get("/profile",function(t,i){if(o.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<1)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/auth/profile",void i.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));var n={title:o.__("profile"),page_title:o.__("profile"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/auth/css/user_profile.css" type="text/css">'},a=s.render_file(r.join(__dirname,"views"),"profile",{lang:o,data:n,auth:t.session.auth},t);n.content=a,e.get("renderer").render(i,void 0,n,t)}),t.post("/profile/process",function(t,s){if(s.setHeader("Content-Type","application/json"),o.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<1)return void s.send(JSON.stringify({result:0,field:"",error:o.__("unauth")}));if(t.files&&t.files.file){if(!u)return void s.send(JSON.stringify({result:0,field:"",error:o.__("server_configuration_dont_support_avatar_upload")}));var d=t.files.file;if(d.size>1048576*e.get("config").max_upload_file_mb)return void s.send(JSON.stringify({result:0,field:"",error:o.__("file_too_big")}));if("image/png"!=d.mimetype&&"image/jpeg"!=d.mimetype)return void s.send(JSON.stringify({result:0,field:"",error:o.__("unsupported_image_format")}));var _=u(e.get("config").dir.tmp+"/"+d.name);if(_){_.autoOrient();var c=a.createHash("md5").update(i.salt+"."+t.session.auth._id).digest("hex");_.size(function(t,r){t?l.unlink(e.get("config").dir.tmp+"/"+d.name,function(){return s.send(JSON.stringify({result:0,field:"",error:o.__("unsupported_image_format")}))}):(r.width>=r.height?(_.resize(null,128),_.crop(128,128,0,0)):(_.resize(128,null),_.crop(128,128,0,0)),_.setFormat("jpeg"),_.write(e.get("config").dir.avatars+"/"+c+".jpg",function(t){t?l.unlink(e.get("config").dir.tmp+"/"+d.name,function(){return s.send(JSON.stringify({result:0,field:"",error:o.__("unsupported_image_format")}))}):(s.send(JSON.stringify({result:1,avatar_id:c})),l.unlink(e.get("config").dir.tmp+"/"+d.name,function(){}))}))})}else l.unlink(e.get("config").dir.tmp+"/"+d.name,function(){return s.send(JSON.stringify({result:0,field:"",error:o.__("unsupported_image_format")}))})}else{var f=t.session.auth.username,g=t.body.password,p=t.body.password_new,h=t.body.email_new,m=t.body.realname;if("undefined"==typeof g)return void s.send(JSON.stringify({result:0,field:"password_current",error:o.__("username_password_missing")}));if(!f.match(/^[A-Za-z0-9_\-]{3,20}$/))return void s.send(JSON.stringify({result:0,field:"password_current",error:o.__("invalid_username_syntax")}));if(!g.match(/^.{5,80}$/))return void s.send(JSON.stringify({result:0,field:"password_current",error:o.__("invalid_password_syntax")}));if(p&&!p.match(/^.{8,80}$/))return void s.send(JSON.stringify({result:0,field:"pc_password",error:o.__("invalid_new_password_syntax")}));if(m&&(m=m.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ").replace(/</g,"").replace(/>/g,"").replace(/\"/g,"")),m&&!m.match(/^.{1,40}$/))return void s.send(JSON.stringify({result:0,field:"rn_realname",error:o.__("invalid_realname")}));if(h&&!h.match(/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/))return void s.send(JSON.stringify({result:0,field:"ec_email",error:o.__("invalid_email_syntax")}));var v=f.toLowerCase(),y=a.createHash("md5"),w=y.update(i.salt+"."+g).digest("hex");e.get("mongodb").collection("users").find({username_auth:v,password:w},{limit:1}).toArray(function(d,_){return d||"undefined"==typeof _||!_.length?void s.send(JSON.stringify({result:0,field:"password_current",error:o.__("invalid_username_or_password")})):h&&2==_[0].status?void s.send(JSON.stringify({result:0,field:"password_current",error:o.__("administrator_cannot_change_email")})):void e.get("mongodb").collection("users").find({email:h},{limit:1}).toArray(function(d,c){if(c&&c.length)return void s.send(JSON.stringify({result:0,field:"password_current",error:o.__("email_already_taken")}));var u={};p&&(u.password=a.createHash("md5").update(i.salt+"."+p).digest("hex")),h&&(u.email=h,u.status=0,u.act_code=a.createHash("md5").update(i.salt+"."+Date.now()).digest("hex")),m&&(u.realname=m),Object.keys(u).length?e.get("mongodb").collection("users").update({_id:_[0]._id},{$set:u},function(a){if(a)return void s.send(JSON.stringify({result:0,field:"password_current",error:o.__("cannot_update")}));var d={result:1};if(m&&(d.realname=m,t.session.auth.realname=m),h){delete t.session.auth;var c=_[0]._id.toHexString(),l=i.protocol+"://"+t.get("host")+"/auth/activate?user="+c+"&code="+u.act_code;n.send(h,o.__("mail_change_email_on")+": "+e.get("settings").site_title,r.join(__dirname,"views"),"mail_change_email_html","mail_change_email_txt",{lang:o,site_title:e.get("settings").site_title,register_url:l},t,function(){s.send(JSON.stringify(d))})}else s.send(JSON.stringify(d))}):s.send(JSON.stringify({result:1}))})})}}),t.post("/oauth/process",function(t,r){if(r.setHeader("Content-Type","application/json"),o.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<1)return void r.send(JSON.stringify({result:0,field:"",error:o.__("unauth")}));if(!t.session.auth.need_finish)return void r.send(JSON.stringify({result:0,field:"",error:o.__("unauth")}));var s=t.body.username_new,n=t.body.password_new;if("undefined"==typeof n)return void r.send(JSON.stringify({result:0,field:"password_current",error:o.__("invalid_password_syntax")}));if(!s.match(/^[A-Za-z0-9_\-]{3,20}$/))return void r.send(JSON.stringify({result:0,field:"password_current",error:o.__("invalid_username_syntax")}));if(!n.match(/^.{5,80}$/))return void r.send(JSON.stringify({result:0,field:"password_current",error:o.__("invalid_password_syntax")}));var d=s.toLowerCase();n=a.createHash("md5").update(i.salt+"."+n).digest("hex"),e.get("mongodb").collection("users").find({username_auth:s},{limit:1}).toArray(function(i,a){return i?void r.send(JSON.stringify({result:0,field:"password_current",error:o.__("ajax_failed")})):a&&a.length?void r.send(JSON.stringify({result:0,field:"set_username",error:o.__("username_already_registered")})):void e.get("mongodb").collection("users").update({_id:new f(t.session.auth._id)},{$set:{username:s,username_auth:d,need_finish:"",password:n}},function(e){return e?void r.send(JSON.stringify({result:0,field:"set_username",error:o.__("cannot_update")})):(t.session.auth.username=s,t.session.auth.need_finish="",void r.send(JSON.stringify({result:1,username:s})))})})});var g=function(t,i,n){var a={title:o.__("error"),page_title:o.__("error"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/auth/css/user_auth.css" type="text/css">'},d=s.render_file(r.join(__dirname,"views"),"error",{lang:o,data:a,error_text:n},t);a.content=d,e.get("renderer").render(i,void 0,a,t)};return t};