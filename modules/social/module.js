module.exports=function(e){var s=e.get("express").Router(),t=(require("gaikan"),e.get("renderer")),i=require("path"),n=require("mongodb").ObjectID,r=require("crypto"),o=require("fs"),a=require("async"),u=require("../../core/socketsender")(e),d=e.get("redis_client"),_=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:i.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode});return s.get("/",function(s,n,o){var a=s.session.current_locale;_.setLocale(a);var u=require("moment");u.locale(a);e.set("settings").social_mode||"private",e.set("settings").social_areas||"[]";if(!s.session.auth||s.session.auth.status<1)return s.session.auth_redirect_host=s.get("host"),s.session.auth_redirect="/social",void n.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));var d={title:_.__("social"),page_title:_.__("social"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/social/css/frontend.css" type="text/css">'},g=_.__("unknown_regdate");s.session.auth.regdate&&(g=s.session.auth.regdate),e.get("mongodb").collection("social_friends").find({$or:[{u1:s.session.auth._id,friends:"1"},{u2:s.session.auth._id,friends:"1"}]}).count(function(o,c){e.get("mongodb").collection("social_friends").find({u2:s.session.auth._id,friends:{$ne:"1"}}).count(function(o,f){var l={username:s.session.auth.username,realname:s.session.auth.realname,name:s.session.auth.realname||s.session.auth.username,avatar:s.session.auth.avatar,regdate:s.session.auth.regdate,regdate_text:u(g).format("LLL"),email:s.session.auth.email,id:s.session.auth._id,id_hash:r.createHash("md5").update(e.get("config").salt+"."+s.session.auth._id).digest("hex")},m=t.render_file(i.join(__dirname,"views"),"social",{lang:_,locale:a,data:d,current_user:JSON.stringify(l),_current_user:l,friends_count:c||"0",inv_count:f||"0"},s);return d.content=m,e.get("renderer").render(n,void 0,d,s)})})}),s.post("/user/friends/search",function(s,t,n){var u=s.session.current_locale,g={status:1,items_per_page:30};if(_.setLocale(u),!s.session.auth||s.session.auth.status<1)return g.status=0,g.error=_.__("unauth"),t.send(JSON.stringify(g));var c=s.body.query,f=s.body.skip;if(!c||!String(c).length||String(c).length<3||String(c).length>100)return g.status=0,g.error=_.__("invalid_query"),t.send(JSON.stringify(g));if(f&&(f=parseInt(f)),f&&("number"!=typeof f||f%1!==0||0>f))return g.status=0,g.error=_.__("invalid_query"),t.send(JSON.stringify(g));f||(f=0),f*=g.items_per_page,c=c.replace(/[`~!@#$%^&*()_|+\-=?;:'",.<>\{\}\[\]\\\/]/gi,"");var l={$and:[{$or:[{username:new RegExp(c,"i")},{email:new RegExp(c,"i")},{realname:new RegExp(c,"i")}]},{status:{$ne:0}}]};e.get("mongodb").collection("users").find(l).count(function(s,n){return s||!n?(g.status=0,g.error=_.__("no_items_found"),t.send(JSON.stringify(g))):void e.get("mongodb").collection("users").find(l,{skip:f,limit:g.items_per_page}).sort({username:1}).toArray(function(s,n){if(s||!n)return g.status=0,g.error=_.__("no_items_found"),t.send(JSON.stringify(g));g.items=n;for(var u=d.multi(),c={},f=0;f<g.items.length;f++)u.get(e.get("config").redis.prefix+"socketio_online_"+g.items[f]._id);a.eachSeries(g.items,function(s,t){var n=r.createHash("md5").update(e.get("config").salt+"."+s._id.toHexString()).digest("hex");o.exists(i.join(__dirname,"..","..","public","images","avatars",n+".jpg"),function(e){e&&(c[n]=1),t()})},function(){u.exec(function(s,i){(s||!i)&&(i=[]);for(var n=0;n<g.items.length;n++){g.items[n].password&&delete g.items[n].password,g.items[n].avatar="/images/avatars/default.png",g.items[n].user_online="0",i&&i[n]&&1==i[n]&&(g.items[n].user_online="1");var o=r.createHash("md5").update(e.get("config").salt+"."+g.items[n]._id.toHexString()).digest("hex");c[o]&&(g.items[n].avatar="/images/avatars/"+o+".jpg")}return t.send(JSON.stringify(g))})})})})}),s.post("/user/friends/data",function(s,t,a){var u=s.session.current_locale,d={status:1,items_per_page:10};if(_.setLocale(u),!s.session.auth||s.session.auth.status<1)return d.status=0,d.error=_.__("unauth"),t.send(JSON.stringify(d));var g=s.body.user;if(!g.match(/^[a-f0-9]{24}$/))return d.status=0,d.error=_.__("invalid_username"),t.send(JSON.stringify(d));var c={_id:new n(g)};e.get("mongodb").collection("users").find(c,{limit:1}).toArray(function(n,a){return n||!a?(d.status=0,d.error=_.__("user_not_found"),t.send(JSON.stringify(d))):void e.get("mongodb").collection("social_friends").find({$or:[{$and:[{u1:s.session.auth._id},{u2:a[0]._id.toHexString()}]},{$and:[{u1:a[0]._id.toHexString()},{u2:s.session.auth._id}]}]},{limit:1}).toArray(function(n,u){var _="0";u&&u.length&&("1"==u[0].friends?_=1:(u[0].u1==s.session.auth._id&&(_=2),u[0].u2==s.session.auth._id&&(_=3)));var g=a[0];g.password&&delete g.password,g.email&&delete g.email,g.avatar="/images/avatars/default.png";var c=r.createHash("md5").update(e.get("config").salt+"."+g._id.toHexString()).digest("hex");o.exists(i.join(__dirname,"..","..","public","images","avatars",c+".jpg"),function(e){return e&&(g.avatar="/images/avatars/"+c+".jpg"),d.user=g,d.friendship=_,t.send(JSON.stringify(d))})})})}),s.post("/user/friendship/request",function(s,t,i){var r=s.session.current_locale,o={status:1};if(_.setLocale(r),!s.session.auth||s.session.auth.status<1)return o.status=0,o.error=_.__("unauth"),t.send(JSON.stringify(o));var a=s.body.id;return a.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("users").find({_id:new n(a)},{limit:1}).toArray(function(i,n){return i||!n?(o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o))):n[0]._id.toHexString()==s.session.auth._id?(o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o))):void e.get("mongodb").collection("social_friends").find({$or:[{$and:[{u1:s.session.auth._id},{u2:n[0]._id.toHexString()},{friends:""}]},{$and:[{u1:n[0]._id.toHexString()},{u2:s.session.auth._id},{friends:""}]}]},{limit:1}).toArray(function(i,n){return i||n&&n.length?(o.status=0,o.error=_.__("friendship_request_already_sent"),t.send(JSON.stringify(o))):void e.get("mongodb").collection("social_friends").insert({u1:s.session.auth._id,u2:String(a),friends:""},function(e,s){if(e)return o.status=0,o.error=_.__("friendship_request_error"),t.send(JSON.stringify(o));var i={friend_id:a};return u.emit(a,"social_new_inv",i),o.friend_id=a,t.send(JSON.stringify(o))})})}):(o.status=0,o.error=_.__("invalid_user_id"),t.send(JSON.stringify(o)))}),s.post("/user/friendship/accept",function(s,t,i){var r=s.session.current_locale,o={status:1};if(_.setLocale(r),!s.session.auth||s.session.auth.status<1)return o.status=0,o.error=_.__("unauth"),t.send(JSON.stringify(o));var a=s.body.id;return a.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("users").find({_id:new n(a)},{limit:1}).toArray(function(i,n){if(i||!n)return o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o));if(n[0]._id.toHexString()==s.session.auth._id)return o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o));var r={u1:n[0]._id.toHexString(),u2:s.session.auth._id,friends:{$ne:"1"}};e.get("mongodb").collection("social_friends").find(r,{limit:1}).toArray(function(i,n){return!i&&n&&n.length?void e.get("mongodb").collection("social_friends").update({_id:n[0]._id},{$set:{friends:"1"}},function(e,i){if(e)return o.status=0,o.error=_.__("friendship_request_error"),t.send(JSON.stringify(o));var n={friend_id:a};return u.emit(s.session.auth._id,"social_new_friend",n),u.emit(a,"social_new_friend",n),o.friend_id=a,t.send(JSON.stringify(o))}):(o.status=0,o.error=_.__("no_friendship_request_found"),t.send(JSON.stringify(o)))})}):(o.status=0,o.error=_.__("invalid_user_id"),t.send(JSON.stringify(o)))}),s.post("/user/friendship/remove",function(s,t,i){var r=s.session.current_locale,o={status:1};if(_.setLocale(r),!s.session.auth||s.session.auth.status<1)return o.status=0,o.error=_.__("unauth"),t.send(JSON.stringify(o));var a=s.body.id;return a.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("users").find({_id:new n(a)},{limit:1}).toArray(function(i,n){return i||!n?(o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o))):n[0]._id.toHexString()==s.session.auth._id?(o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o))):void e.get("mongodb").collection("social_friends").find({$or:[{$and:[{u1:s.session.auth._id},{u2:n[0]._id.toHexString()},{friends:"1"}]},{$and:[{u1:n[0]._id.toHexString()},{u2:s.session.auth._id},{friends:"1"}]}]},{limit:1}).toArray(function(s,i){return!s&&i&&i.length?void e.get("mongodb").collection("social_friends").remove({_id:i[0]._id},function(e,s){if(e)return o.status=0,o.error=_.__("friendship_remove_error"),t.send(JSON.stringify(o));var i={friend_id:a};return u.emit(a,"social_unfriend",i),t.send(JSON.stringify(o))}):(o.status=0,o.error=_.__("not_friends"),t.send(JSON.stringify(o)))})}):(o.status=0,o.error=_.__("invalid_user_id"),t.send(JSON.stringify(o)))}),s.post("/user/friends/inv",function(s,t,u){var g=s.session.current_locale,c={status:1,items_per_page:10};if(_.setLocale(g),!s.session.auth||s.session.auth.status<1)return c.status=0,c.error=_.__("unauth"),t.send(JSON.stringify(c));var f=s.body.skip;if(f&&(f=parseInt(f)),f&&("number"!=typeof f||f%1!==0||0>f))return c.status=0,c.error=_.__("invalid_query"),t.send(JSON.stringify(c));f||(f=0),f*=c.items_per_page;var l={$and:[{u2:s.session.auth._id},{friends:""}]};e.get("mongodb").collection("social_friends").find(l).count(function(s,u){return s||!u?(c.status=0,c.error=_.__("no_invitations_found"),t.send(JSON.stringify(c))):void e.get("mongodb").collection("social_friends").find(l,{skip:f,limit:c.items_per_page}).toArray(function(s,u){if(s||!u||!u.length)return c.status=0,c.error=_.__("ajax_failed"),t.send(JSON.stringify(c));for(var g=[],f=0;f<u.length;f++)g.push({_id:new n(u[f].u1)});e.get("mongodb").collection("users").find({$or:g}).sort({username:1}).toArray(function(s,n){if(s||!n||!n.length)return c.status=0,c.error=_.__("ajax_failed"),t.send(JSON.stringify(c));c.items=n;for(var u=d.multi(),g={},f=0;f<c.items.length;f++)u.get(e.get("config").redis.prefix+"socketio_online_"+c.items[f]._id);a.eachSeries(c.items,function(s,t){var n=r.createHash("md5").update(e.get("config").salt+"."+s._id.toHexString()).digest("hex");o.exists(i.join(__dirname,"..","..","public","images","avatars",n+".jpg"),function(e){e&&(g[n]=1),t()})},function(){u.exec(function(s,i){(s||!i)&&(i=[]);for(var n=0;n<c.items.length;n++){c.items[n].password&&delete c.items[n].password,c.items[n].avatar="/images/avatars/default.png",c.items[n].user_online="0",i&&i[n]&&1==i[n]&&(c.items[n].user_online="1");var o=r.createHash("md5").update(e.get("config").salt+"."+c.items[n]._id.toHexString()).digest("hex");g[o]&&(c.items[n].avatar="/images/avatars/"+o+".jpg")}return t.send(JSON.stringify(c))})})})})})}),s.post("/user/friends/list",function(s,t,u){var g=s.session.current_locale,c={status:1,items_per_page:10};if(_.setLocale(g),!s.session.auth||s.session.auth.status<1)return c.status=0,c.error=_.__("unauth"),t.send(JSON.stringify(c));var f=s.body.skip;if(f&&(f=parseInt(f)),f&&("number"!=typeof f||f%1!==0||0>f))return c.status=0,c.error=_.__("invalid_query"),t.send(JSON.stringify(c));f||(f=0),f*=c.items_per_page;var l={$or:[{u1:s.session.auth._id,friends:"1"},{u2:s.session.auth._id,friends:"1"}]};e.get("mongodb").collection("social_friends").find(l).count(function(u,g){return u||!g?(c.status=0,c.error=_.__("no_friends_found"),t.send(JSON.stringify(c))):void e.get("mongodb").collection("social_friends").find(l,{skip:f,limit:c.items_per_page}).toArray(function(u,g){if(u||!g||!g.length)return c.status=0,c.error=_.__("ajax_failed"),t.send(JSON.stringify(c));for(var f=[],l=0;l<g.length;l++){var m=g[l].u1;s.session.auth._id==m&&(m=g[l].u2),f.push({_id:new n(m)})}e.get("mongodb").collection("users").find({$or:f}).sort({username:1}).toArray(function(s,n){if(s||!n||!n.length)return c.status=0,c.error=_.__("ajax_failed"),t.send(JSON.stringify(c));c.items=n;for(var u=d.multi(),g={},f=0;f<c.items.length;f++)u.get(e.get("config").redis.prefix+"socketio_online_"+c.items[f]._id);a.eachSeries(c.items,function(s,t){var n=r.createHash("md5").update(e.get("config").salt+"."+s._id.toHexString()).digest("hex");o.exists(i.join(__dirname,"..","..","public","images","avatars",n+".jpg"),function(e){e&&(g[n]=1),t()})},function(){u.exec(function(s,i){(s||!i)&&(i=[]);for(var n=0;n<c.items.length;n++){c.items[n].password&&delete c.items[n].password,c.items[n].avatar="/images/avatars/default.png",c.items[n].user_online="0",i&&i[n]&&1==i[n]&&(c.items[n].user_online="1");var o=r.createHash("md5").update(e.get("config").salt+"."+c.items[n]._id.toHexString()).digest("hex");g[o]&&(c.items[n].avatar="/images/avatars/"+o+".jpg")}return t.send(JSON.stringify(c))})})})})})}),s.post("/user/messages/load",function(s,t,u){var g=s.session.current_locale,c={status:1};if(_.setLocale(g),!s.session.auth||s.session.auth.status<1)return c.status=0,c.error=_.__("unauth"),t.send(JSON.stringify(c));var f=s.body.id;return f.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("users").find({_id:new n(f)},{limit:1}).toArray(function(n,u){return n||!u?(c.status=0,c.error=_.__("user_not_found"),t.send(JSON.stringify(c))):u[0]._id.toHexString()==s.session.auth._id?(c.status=0,c.error=_.__("user_not_found"),t.send(JSON.stringify(c))):void e.get("mongodb").collection("social_conversations").find({$or:[{$and:[{u1:s.session.auth._id},{u2:u[0]._id.toHexString()}]},{$and:[{u1:u[0]._id.toHexString()},{u2:s.session.auth._id}]}]},{limit:1}).toArray(function(n,g){return n?(c.status=0,c.error=_.__("cannot_load_conversation"),t.send(JSON.stringify(c))):void a.series([function(t){g&&g.length?t():e.get("mongodb").collection("social_conversations").insert({u1:s.session.auth._id,u2:u[0]._id.toHexString()},function(){t()})},function(n){var a={$or:[{$and:[{u1:s.session.auth._id},{u2:u[0]._id.toHexString()}]},{$and:[{u1:u[0]._id.toHexString()},{u2:s.session.auth._id}]}]};e.get("mongodb").collection("social_messages").find(a).count(function(g,f){if(g)return c.status=0,c.error=_.__("cannot_load_messages"),n(),t.send(JSON.stringify(c));var l=0;f>150&&(l=f-150),e.get("mongodb").collection("social_messages").find(a).skip(l).sort({tstamp:1}).toArray(function(a,g){return a?(c.status=0,c.error=_.__("cannot_load_messages"),n(),t.send(JSON.stringify(c))):(c.messages=[],g.length&&(c.messages=g),c.user=u[0],c.user.avatar="/images/avatars/default.png",delete c.user.password,delete c.user.email,c.me={},c.me.username=s.session.auth.username,c.me.realname=s.session.auth.realname,c.me.avatar=s.session.auth.avatar,c.me.id=s.session.auth._id,void d.get(e.get("config").redis.prefix+"socketio_online_"+u[0]._id.toHexString(),function(a,d){c.user.online="0",d&&1==d&&(c.user.online="1"),e.get("mongodb").collection("social_conversations").find({$or:[{u1:s.session.auth._id,u2:u[0]._id.toHexString()},{u1:u[0]._id.toHexString(),u2:s.session.auth._id}]}).toArray(function(t,i){if(!t&&i&&i.length){var n="u1_unread_flag";i[0].u2==s.session.auth._id&&(n="u2_unread_flag");var r={$set:{}};r.$set[n]="",e.get("mongodb").collection("social_conversations").update({_id:i[0]._id},r,function(e){})}});var _=r.createHash("md5").update(e.get("config").salt+"."+c.user._id.toHexString()).digest("hex");o.exists(i.join(__dirname,"..","..","public","images","avatars",_+".jpg"),function(e){return e&&(c.user.avatar="/images/avatars/"+_+".jpg"),t.send(JSON.stringify(c)),n()})}))})})}])})}):(c.status=0,c.error=_.__("invalid_user_id"),t.send(JSON.stringify(c)))}),s.post("/user/messages/save",function(s,t,i){var r=s.session.current_locale,o={status:1};if(_.setLocale(r),!s.session.auth||s.session.auth.status<1)return o.status=0,o.error=_.__("unauth"),t.send(JSON.stringify(o));var a=s.body.user_id;if(!a||!a.match(/^[a-f0-9]{24}$/))return o.status=0,o.error=_.__("invalid_user_id"),t.send(JSON.stringify(o));var d=s.body.msg;return d&&(d=d.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ").replace(/\"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r\t]/g," ")),d?void e.get("mongodb").collection("users").find({_id:new n(a)},{limit:1}).toArray(function(i,n){return i||!n?(o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o))):n[0]._id.toHexString()==s.session.auth._id?(o.status=0,o.error=_.__("user_not_found"),t.send(JSON.stringify(o))):void e.get("mongodb").collection("social_messages").insert({u1:s.session.auth._id,u2:n[0]._id.toHexString(),msg:d,tstamp:Date.now()},function(i){if(i)return o.status=0,o.error=_.__("cannot_send_message"),t.send(JSON.stringify(o));e.get("mongodb").collection("social_conversations").find({$or:[{u1:s.session.auth._id,u2:n[0]._id.toHexString()},{u1:n[0]._id.toHexString(),u2:s.session.auth._id}]}).toArray(function(s,t){if(!s&&t&&t.length){var i="u1_unread_flag";t[0].u2==n[0]._id.toHexString()&&(i="u2_unread_flag");var r={$set:{last_tstamp:Date.now()},$inc:{msg_count:1}};r.$set[i]="1",e.get("mongodb").collection("social_conversations").update({_id:t[0]._id},r,function(e){})}});var r={from:s.session.auth._id,to:n[0]._id.toHexString(),msg:d,tstamp:Date.now()};return u.emit(s.session.auth._id,"social_chat_msg",r),u.emit(n[0]._id.toHexString(),"social_chat_msg",r),t.send(JSON.stringify(o))})}):(o.status=0,o.error=_.__("invalid_msg"),t.send(JSON.stringify(o)))}),s.post("/user/messages/conversations",function(s,t,u){var g=s.session.current_locale,c={status:1};return _.setLocale(g),!s.session.auth||s.session.auth.status<1?(c.status=0,c.error=_.__("unauth"),t.send(JSON.stringify(c))):void e.get("mongodb").collection("social_conversations").find({$or:[{u1:s.session.auth._id},{u2:s.session.auth._id}]}).sort({last_tstamp:-1}).toArray(function(u,g){if(u)return c.status=0,c.error=_.__("cannot_load_conversation"),t.send(JSON.stringify(c));if(!g||!g.length)return c.conversations=[],t.send(JSON.stringify(c));for(var f=[],l=0;l<g.length;l++){var m=g[l].u1;m==s.session.auth._id&&(m=g[l].u2),f.push({_id:new n(m)})}e.get("mongodb").collection("users").find({$or:f}).toArray(function(n,u){if(n||!u||!u.length)return c.status=0,c.error=_.__("cannot_load_conversation"),t.send(JSON.stringify(c));var f={},l={};a.series([function(s){a.eachSeries(u,function(s,t){var n=r.createHash("md5").update(e.get("config").salt+"."+s._id.toHexString()).digest("hex");o.exists(i.join(__dirname,"..","..","public","images","avatars",n+".jpg"),function(e){e&&(l[n]=1),t()})},function(){s()})},function(i){for(var n=0;n<u.length;n++){u[n].avatar="/images/avatars/default.png";var o=r.createHash("md5").update(e.get("config").salt+"."+u[n]._id.toHexString()).digest("hex");l[o]&&(u[n].avatar="/images/avatars/"+o+".jpg"),f[u[n]._id]=u[n]}for(var a=[],_=d.multi(),m=0;m<g.length;m++){var h=g[m].u1;h==s.session.auth._id&&(h=g[m].u2),_.get(e.get("config").redis.prefix+"socketio_online_"+h)}_.exec(function(e,n){(e||!n)&&(n=[]);for(var r=0;r<g.length;r++){var o=g[r].u1;o==s.session.auth._id&&(o=g[r].u2);var u="u1_unread_flag";g[r].u2==s.session.auth._id&&(u="u2_unread_flag");var d="0";u in g[r]&&"1"==g[r][u]&&(d="1");var _={user_id:o,avatar:f[o].avatar,name:f[o].realname||f[o].username,last_tstamp:g[r].last_tstamp||Date.now(),msg_count:g[r].msg_count||0,unread_flag:d,user_online:"0"};n&&n[r]&&1==n[r]&&(_.user_online="1"),a.push(_)}return c.conversations=a,t.send(JSON.stringify(c)),i()})}])})})}),s.post("/user/messages/markread",function(s,t,i){var n=s.session.current_locale,r={status:1};if(_.setLocale(n),!s.session.auth||s.session.auth.status<1)return r.status=0,r.error=_.__("unauth"),t.send(JSON.stringify(r));var o=s.body.id;return o.match(/^[a-f0-9]{24}$/)?void e.get("mongodb").collection("social_conversations").find({$or:[{u1:s.session.auth._id,u2:o},{u1:o,u2:s.session.auth._id}]}).toArray(function(i,n){if(i||!n||!n.length)return r.status=0,r.error=_.__("invalid_user_id"),t.send(JSON.stringify(r));var o="u1_unread_flag";n[0].u2==s.session.auth._id&&(o="u2_unread_flag");var a={$set:{}};return a.$set[o]="",e.get("mongodb").collection("social_conversations").update({_id:n[0]._id},a,function(e){}),t.send(JSON.stringify(r))}):(r.status=0,r.error=_.__("invalid_user_id"),t.send(JSON.stringify(r)))}),s.post("/user/messages/typing",function(s,t,i){var n=s.session.current_locale,r={status:1};if(_.setLocale(n),!s.session.auth||s.session.auth.status<1)return r.status=0,r.error=_.__("unauth"),t.send(JSON.stringify(r));var o=s.body.id;if(!o.match(/^[a-f0-9]{24}$/))return r.status=0,r.error=_.__("invalid_user_id"),t.send(JSON.stringify(r));var a=s.body.mode;return"start"!=a&&"stop"!=a?(r.status=0,r.error=_.__("invalid_mode"),t.send(JSON.stringify(r))):void e.get("mongodb").collection("social_conversations").find({$or:[{u1:s.session.auth._id,u2:o},{u1:o,u2:s.session.auth._id}]}).toArray(function(e,s){if(e||!s||!s.length)return r.status=0,r.error=_.__("invalid_user_id"),t.send(JSON.stringify(r));var i={rct:o,mod:a};return u.emit(o,"social_typing",i),t.send(JSON.stringify(r))})}),s};