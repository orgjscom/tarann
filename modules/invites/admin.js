module.exports=function(e){var t={invcode:1,invdate:1,invused:1},n=require("path"),s="invdate",i=-1,o=30,r=e.get("express").Router(),a=require("mongodb").ObjectID,d=new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:n.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode}),u=require("crypto");r.get_module_name=function(e){return d.setLocale(e.session.current_locale),d.__("module_name")},r.get("/",function(t,s){var i=t.session.current_locale;if(d.setLocale(i),!t.session.auth||t.session.auth.status<2)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/cp/invites",void s.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));var o=e.get("renderer").render_file(n.join(__dirname,"views"),"invites_control",{lang:d,locales:JSON.stringify(e.get("config").locales.avail),current_locale:i},t);e.get("cp").render(t,s,{body:o,css:'<link rel="stylesheet" href="/modules/invites/css/main.css">'},d,"invites",t.session.auth)}),r.post("/data/list",function(n,r){d.setLocale(n.session.current_locale);var a={ipp:o},u=n.body.skip,c=n.body.query,l=n.body.sort_mode,f=n.body.sort_cell;if("undefined"!=typeof u&&!u.match(/^[0-9]{1,10}$/))return a.status=0,a.error=d.__("invalid_query"),void r.send(JSON.stringify(a));if("undefined"!=typeof c&&!c.match(/^[\w\sА-Яа-я0-9_\-\.]{3,40}$/))return a.status=0,a.error=d.__("invalid_query"),void r.send(JSON.stringify(a));if(!n.session.auth||n.session.auth.status<2)return a.status=0,a.error=d.__("unauth"),void r.send(JSON.stringify(a));var v={};v[s]=i,"undefined"!=typeof f&&"undefined"!=typeof t[f]&&(v={},v[f]=1,"undefined"!=typeof l&&-1==l&&(v[f]=-1)),a.items=[];var g={};c&&(g={invcode:new RegExp(c,"i")}),e.get("mongodb").collection("invites").find(g).count(function(t,n){!t&&n>0?(a.total=n,e.get("mongodb").collection("invites").find(g,{skip:u,limit:o}).sort(v).toArray(function(e,t){if("undefined"!=typeof t&&!e)for(var n=0;n<t.length;n++){var s=[];s.push(t[n]._id),s.push(t[n].invdate),s.push(t[n].invcode),s.push(t[n].invused),a.items.push(s)}a.status=1,r.send(JSON.stringify(a))})):(a.status=1,a.total="0",r.send(JSON.stringify(a)))})}),r.post("/data/load",function(t,n){d.setLocale(t.session.current_locale);var s={},i=t.body.id;return"undefined"!=typeof i&&i.match(/^[a-f0-9]{24}$/)?!t.session.auth||t.session.auth.status<2?(s.status=0,s.error=d.__("unauth"),void n.send(JSON.stringify(s))):(s.data={},void e.get("mongodb").collection("invites").find({_id:new a(i)},{limit:1}).toArray(function(e,t){"undefined"==typeof t||e||t.length>0&&(s.data=t[0]),s.status=1,n.send(JSON.stringify(s))})):(s.status=0,s.error=d.__("invalid_query"),void n.send(JSON.stringify(s)))}),r.post("/data/generate",function(t,n){d.setLocale(t.session.current_locale);var s={err_fields:[],status:1};if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=d.__("unauth"),void n.send(JSON.stringify(s));var i=u.createHash("md5").update(Date.now()+Math.random().toString()).digest("hex")+u.createHash("md5").update(Date.now()+Math.random().toString()).digest("hex"),o=Date.now();e.get("mongodb").collection("invites").insert({invdate:o,invcode:i,invused:"0"},function(){s.status=1,s.invdate=o,s.invcode=i,s.invused="0",n.send(JSON.stringify(s))})}),r.post("/data/delete",function(t,n){d.setLocale(t.session.current_locale);var s={status:1};if(!t.session.auth||t.session.auth.status<2)return s.status=0,s.error=d.__("unauth"),void n.send(JSON.stringify(s));var i=t.body.ids;if("object"!=typeof i||i.length<1)return s.status=0,s.error=d.__("invalid_query"),void n.send(JSON.stringify(s));for(var o=0;o<i.length;o++)i[o].match(/^[a-f0-9]{24}$/)&&e.get("mongodb").collection("invites").remove({_id:new a(i[o])},c);n.send(JSON.stringify(s))});var c=function(){};return r};