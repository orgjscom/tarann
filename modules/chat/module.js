module.exports=function(e){var t=e.get("express").Router(),n=require("path"),s=require("async"),a=e.get("renderer"),r=(require("moment"),e.get("config")),i=require("crypto"),o=require("string"),d=require("../../core/socketsender")(e),c=e.get("redis_client"),u=require("mongodb").ObjectID,_=new(require("i18n-2"))({locales:r.locales.avail,directory:n.join(__dirname,"lang"),extension:".js",devMode:r.locales.dev_mode}),m=50,h=["color","mod_set","mod_unset","readonly_set","readonly_unset","nick","ban_set","ban_unset","clear"];return t.get("/",function(t,o){if(!t.session.auth||t.session.auth.status<1)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/chat",void o.redirect(303,"/auth?rnd="+Math.random().toString().replace(".",""));if(_.setLocale(t.session.current_locale),t.session.auth.need_finish){var d={title:_.__("module_name"),page_title:_.__("module_name"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/chat/css/main.css" type="text/css">'},u=a.render_file(n.join(__dirname,"views"),"need_finish",{lang:_},t);return d.content=u,e.get("renderer").render(o,void 0,d,t)}if(t.session.auth.chat_data&&t.session.auth.chat_data.ban_flag&&t.session.auth.status<2){var l={title:_.__("module_name"),page_title:_.__("module_name"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/chat/css/main.css" type="text/css">'},f=a.render_file(n.join(__dirname,"views"),"banned",{lang:_},t);return l.content=f,e.get("renderer").render(o,void 0,l,t)}var g=[],v={},p=[],y={};s.series([function(e){c.lrange(r.redis.prefix+"socketio_users_online",0,100,function(t,n){n&&n.length&&(g=n),e()})},function(n){var a=[""],r={};if(t.session.chat_channels&&t.session.chat_channels.length)for(var o in t.session.chat_channels){var d=i.createHash("md5").update([t.session.auth.username,t.session.chat_channels[o]].sort().join(" ")).digest("hex");r[d]=t.session.chat_channels[o],a.push(d)}s.eachSeries(a,function(t,n){e.get("mongodb").collection("chat_messages").find({channel_id:t,msg_deleted:{$exists:!1}}).count(function(s,a){if(s)return n(!0);a||(a=0);var i=0;a>m&&(i=a-m),e.get("mongodb").collection("chat_messages").find({channel_id:t,msg_deleted:{$exists:!1}}).skip(i).sort({timestamp:1}).toArray(function(e,s){if(s&&s.length)for(var a in s)s[a].username&&-1==p.indexOf(s[a].username)&&p.push(s[a].username),s[a].channel=r[t]||"",s[a].cmd&&(s[a].cmd=h.indexOf(s[a].cmd)),y[s[a].channel]||(y[s[a].channel]=[]),delete s[a].channel_id,delete s[a]._id,y[s[a].channel].push(s[a]);n()})})},function(){n()})},function(t){if(p.length){var n=[];for(var s in p)n.push({username:p[s]});for(var a in g)-1==p.indexOf(g[a])&&n.push({username:g[a]});e.get("mongodb").collection("users").find({$or:n}).toArray(function(e,n){if(n&&n.length)for(var s in n)n[s].chat_data?v[n[s].username]=n[s].chat_data:v[n[s].username]={},2==n[s].status&&(v[n[s].username].mod_flag=!0);t()})}else t()},function(s){var d={title:_.__("module_name"),page_title:_.__("module_name"),keywords:"",description:"",extra_css:'<link rel="stylesheet" href="/modules/chat/css/main.css" type="text/css">'},c=a.render_file(n.join(__dirname,"views"),"chat",{lang:_,data:d,current_locale:t.session.current_locale,current_username:t.session.auth.username,current_user:JSON.stringify({id:t.session.auth._id,id_hash:i.createHash("md5").update(r.salt+"."+t.session.auth._id).digest("hex")}),cmd_list:JSON.stringify(_.__("cmd_list")),messages_data:JSON.stringify(y),users_online:JSON.stringify(g),chat_users_data:JSON.stringify(v)},t);return d.content=c,e.get("renderer").render(o,void 0,d,t),s()}])}),t.post("/ajax/msg",function(t,n){var a={status:1};if(!t.session.auth||t.session.auth.status<1||t.session.auth.need_finish)return a.status=0,a.error=_.__("unauth"),n.send(JSON.stringify(a));var u=o(t.body.msg||"").stripTags().decodeHTMLEntities().s.replace(/[\n\r\t]/gm,""),m=t.body.channel||"",h=Date.now();if(m&&(!m.match(/^[A-Za-z0-9_\-]{3,20}$/)||m==t.session.auth.username))return a.status=0,a.error=_.__("invalid_channel"),n.send(JSON.stringify(a));var l=u.split(/ /).reduce(function(e,t){return e.length>t.length?e:t}).length;if(u.length<2||u.length>1024||l>30)return a.status=0,a.error=_.__("invalid_msg"),n.send(JSON.stringify(a));var f,g={},v={};s.series([function(t){m&&m.length?e.get("mongodb").collection("users").find({username:m}).toArray(function(e,s){return s&&s.length?(f=s[0]._id,v=s[0],void t()):(a.status=0,a.error=_.__("invalid_channel"),n.send(JSON.stringify(a)),t(!0))}):t()},function(n){e.get("mongodb").collection("users").find({username:t.session.auth.username}).toArray(function(e,t){t&&t.length&&t[0].chat_data&&(g=t[0].chat_data),n()})},function(e){return g.ro_flag||g.ban_flag?(a.status=0,a.error=_.__("your_account_is_ro"),n.send(JSON.stringify(a)),e(!0)):void e()},function(n){var s="";m&&m.length&&(s=i.createHash("md5").update([t.session.auth.username,m].sort().join(" ")).digest("hex")),a.msg_data={username:t.session.auth.username,timestamp:h,message:u,type:"u",data:{},channel_id:s},e.get("mongodb").collection("chat_messages").insert(a.msg_data,function(){return g&&(a.msg_data.data=g),n()})},function(e){m&&m.length&&(t.session.chat_channels||(t.session.chat_channels=[]),-1==t.session.chat_channels.indexOf(m)&&t.session.chat_channels.push(m)),e()},function(e){return a.msg_data.channel=m,m?(a.msg_data.nicknames={},v&&v.chat_data&&v.chat_data.nickname&&(a.msg_data.nicknames[m]=v.chat_data.nickname),g&&g.nickname&&(a.msg_data.nicknames[t.session.auth.username]=g.nickname),d.emit(f,"taracot_chat_message",a.msg_data)):c.publish(r.redis.prefix+"medved_broadcast",JSON.stringify({msgtype:"taracot_chat_message",msg:a.msg_data})),n.send(JSON.stringify(a)),e()}])}),t.post("/ajax/cmd",function(t,n){var a={status:1};if(!t.session.auth||t.session.auth.status<1||t.session.auth.need_finish)return a.status=0,a.error=_.__("unauth"),n.send(JSON.stringify(a));var i=o(t.body.cmd||"").stripTags().decodeHTMLEntities().s.replace(/[\n\r\t]/gm,"");Date.now();if(i.length<2&&i.length>1024)return a.status=0,a.error=_.__("invalid_cmd"),n.send(JSON.stringify(a));var d=i.split(" "),m=d[0].toLowerCase(),l=h.indexOf(m);return-1===l?(a.status=0,a.error=_.__("invalid_cmd"),n.send(JSON.stringify(a))):(a.cmd_timestamp=Date.now(),void s.series([function(n){if("color"==m){if(2!=d.length||!d[1].match(/^#(?:[0-9a-f]{3}){1,2}$/i))return a.status=0,a.error=_.__("cmd_color_invalid_value"),n(!0);var s=d[1].toLowerCase();a.cmd=m,a.cmd_index=l,a.cmd_data={username:t.session.auth.username,color:s},e.get("mongodb").collection("users").update({_id:new u(t.session.auth._id)},{$set:{chat_data:{color:s}}},function(e){return n(!0)})}else n()},function(n){if("mod_set"==m){if(2!=d.length||!d[1].match(/^[a-z0-9_\-]{3,20}$/i))return a.status=0,a.error=_.__("cmd_mod_invalid_username"),n(!0);var r=d[1].toLowerCase(),i={};s.series([function(n){return 2==t.session.auth.status?n():void e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&t[0].chat_data.mod_flag?n():(a.status=0,a.error=_.__("cmd_mod_insufficent_rights"),n(!0))})},function(t){e.get("mongodb").collection("users").find({username:r}).toArray(function(e,n){return n&&n.length?(n[0].chat_data&&(i=n[0].chat_data),t()):(a.status=0,a.error=_.__("cmd_mod_invalid_username"),t(!0))})},function(n){i.mod_flag=!0,e.get("mongodb").collection("users").update({username:r},{$set:{chat_data:i}},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={moderator:t.session.auth.username,new_moderator:r},n())})}],function(e){return n(e?!0:"insert")})}else n()},function(n){if("mod_unset"==m){if(2!=d.length||!d[1].match(/^[a-z0-9_\-]{3,20}$/i))return a.status=0,a.error=_.__("cmd_mod_invalid_username"),n(!0);var r=d[1].toLowerCase(),i={};s.series([function(n){return 2==t.session.auth.status?n():void e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&t[0].chat_data.mod_flag?n():(a.status=0,a.error=_.__("cmd_mod_insufficent_rights"),n(!0))})},function(t){e.get("mongodb").collection("users").find({username:r}).toArray(function(e,n){return n&&n.length&&n[0].chat_data&&n[0].chat_data.mod_flag?(n[0].chat_data&&(i=n[0].chat_data),t()):(a.status=0,a.error=_.__("cmd_err_not_moderator"),t(!0))})},function(n){i.mod_flag=!1,e.get("mongodb").collection("users").update({username:r},{$set:{chat_data:i}},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={moderator:t.session.auth.username,new_moderator:r},n())})}],function(e){return n(e?!0:"insert")})}else n()},function(n){if("readonly_set"==m){if(d.length<2||!d[1].match(/^[a-z0-9_\-]{3,20}$/i))return a.status=0,a.error=_.__("cmd_mod_invalid_username"),n(!0);var r=d[1].toLowerCase(),i={},o=[];if(d.length>2)for(var c=2;c<d.length;c++)o.push(d[c]);s.series([function(n){return 2==t.session.auth.status?n():void e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&t[0].chat_data.mod_flag?n():(a.status=0,a.error=_.__("cmd_mod_insufficent_rights"),n(!0))})},function(t){e.get("mongodb").collection("users").find({username:r}).toArray(function(e,n){return n&&n.length?(n[0].chat_data&&(i=n[0].chat_data),t()):(a.status=0,a.error=_.__("cmd_mod_invalid_username"),t(!0))})},function(n){i.ro_flag=!0,e.get("mongodb").collection("users").update({username:r},{$set:{chat_data:i}},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={moderator:t.session.auth.username,user_ro:r,reason:o.join(" ")||"?"},n())})}],function(e){return n(e?!0:"insert")})}else n()},function(n){if("readonly_unset"==m){if(d.length<2||!d[1].match(/^[a-z0-9_\-]{3,20}$/i))return a.status=0,a.error=_.__("cmd_mod_invalid_username"),n(!0);var r=d[1].toLowerCase(),i={},o=[];if(d.length>2)for(var c=2;c<d.length;c++)o.push(d[c]);s.series([function(n){return 2==t.session.auth.status?n():void e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&t[0].chat_data.mod_flag?n():(a.status=0,a.error=_.__("cmd_mod_insufficent_rights"),n(!0))})},function(t){e.get("mongodb").collection("users").find({username:r}).toArray(function(e,n){return n&&n.length?(n[0].chat_data&&(i=n[0].chat_data),t()):(a.status=0,a.error=_.__("cmd_mod_invalid_username"),t(!0))})},function(n){i.ro_flag=!1,e.get("mongodb").collection("users").update({username:r},{$set:{chat_data:i}},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={moderator:t.session.auth.username,user_ro:r},n())})}],function(e){return n(e?!0:"insert")})}else n()},function(n){if("nick"==m){if(2!=d.length)return a.status=0,a.error=_.__("cmd_mod_invalid_nickname"),n(!0);var r=o(d[1]).stripTags().decodeHTMLEntities().s.replace(/[\n\r\t'\"]/gm,""),i={};if(r.length<2||r.length>20)return a.status=0,a.error=_.__("cmd_mod_invalid_nickname"),n(!0);s.series([function(n){e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&(i=t[0].chat_data),n()})},function(n){i.nickname=r,e.get("mongodb").collection("users").update({_id:new u(t.session.auth._id)},{$set:{chat_data:i}},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={username:t.session.auth.username,nickname:r},n())})}],function(e){return n(e?!0:"insert")})}else n()},function(n){if("ban_set"==m){if(d.length<2||!d[1].match(/^[a-z0-9_\-]{3,20}$/i))return a.status=0,a.error=_.__("cmd_mod_invalid_username"),n(!0);var r=d[1].toLowerCase(),i={},o=[];if(d.length>2)for(var c=2;c<d.length;c++)o.push(d[c]);s.series([function(n){return 2==t.session.auth.status?n():void e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&t[0].chat_data.mod_flag?n():(a.status=0,a.error=_.__("cmd_mod_insufficent_rights"),n(!0))})},function(t){e.get("mongodb").collection("users").find({username:r}).toArray(function(e,n){return n&&n.length?(n[0].chat_data&&(i=n[0].chat_data),t()):(a.status=0,a.error=_.__("cmd_mod_invalid_username"),t(!0))})},function(n){i.ban_flag=!0,e.get("mongodb").collection("users").update({username:r},{$set:{chat_data:i}},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={moderator:t.session.auth.username,user_ban:r,reason:o.join(" ")||"?"},n())})}],function(e){return n(e?!0:"insert")})}else n()},function(n){if("ban_unset"==m){if(d.length<2||!d[1].match(/^[a-z0-9_\-]{3,20}$/i))return a.status=0,a.error=_.__("cmd_mod_invalid_username"),n(!0);var r=d[1].toLowerCase(),i={},o=[];if(d.length>2)for(var c=2;c<d.length;c++)o.push(d[c]);s.series([function(n){return 2==t.session.auth.status?n():void e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&t[0].chat_data.mod_flag?n():(a.status=0,a.error=_.__("cmd_mod_insufficent_rights"),n(!0))})},function(t){e.get("mongodb").collection("users").find({username:r}).toArray(function(e,n){return n&&n.length?(n[0].chat_data&&(i=n[0].chat_data),t()):(a.status=0,a.error=_.__("cmd_mod_invalid_username"),t(!0))})},function(n){i.ban_flag=!1,e.get("mongodb").collection("users").update({username:r},{$set:{chat_data:i}},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={moderator:t.session.auth.username,user_ban:r},n())})}],function(e){return n(e?!0:"insert")})}else n()},function(n){"clear"==m?s.series([function(n){return 2==t.session.auth.status?n():void e.get("mongodb").collection("users").find({_id:new u(t.session.auth._id)}).toArray(function(e,t){return t&&t.length&&t[0].chat_data&&t[0].chat_data.mod_flag?n():(a.status=0,a.error=_.__("cmd_mod_insufficent_rights"),n(!0))})},function(n){e.get("mongodb").collection("chat_messages").update({channel_id:"",timestamp:{$lt:Date.now()}},{$set:{msg_deleted:!0}},{multi:!0},function(e){return e?(a.status=0,a.error=_.__("cmd_database_error"),n(!0)):(a.cmd=m,a.cmd_index=l,a.cmd_data={moderator:t.session.auth.username},n())})}],function(e){return n(e?!0:"insert")}):n()}],function(s){if(!s)return a.status=0,a.error=_.__("invalid_cmd"),n.send(JSON.stringify(a));if("insert"!=s)return n.send(JSON.stringify(a));var i={username:t.session.auth.username,channel_id:"",timestamp:a.cmd_timestamp,type:"c",cmd:a.cmd,cmd_data:a.cmd_data};e.get("mongodb").collection("chat_messages").insert(i,function(){return i.cmd_index=l,c.publish(r.redis.prefix+"medved_broadcast",JSON.stringify({msgtype:"taracot_chat_message",msg:i})),n.send(JSON.stringify(a))})}))}),t.post("/ajax/channel/close",function(e,t){var n={status:1};if(!e.session.auth||e.session.auth.status<1||e.session.auth.need_finish)return n.status=0,n.error=_.__("unauth"),t.send(JSON.stringify(n));var s=e.body.channel;return s&&s.match(/^[A-Za-z0-9_\-]{3,20}$/)?(e.session.chat_channels&&e.session.chat_channels.length&&-1!=e.session.chat_channels.indexOf(s)&&e.session.chat_channels.splice(e.session.chat_channels.indexOf(s),1),void t.send(JSON.stringify(n))):(n.status=0,n.error=_.__("invalid_channel"),t.send(JSON.stringify(n)))}),t.post("/ajax/channel/history",function(t,n){var a={status:1};if(!t.session.auth||t.session.auth.status<1||t.session.auth.need_finish)return a.status=0,a.error=_.__("unauth"),n.send(JSON.stringify(a));var r=t.body.channel;if(!r||!r.match(/^[A-Za-z0-9_\-]{3,20}$/))return a.status=0,a.error=_.__("invalid_channel"),n.send(JSON.stringify(a));t.session.chat_channels||(t.session.chat_channels=[]),-1==t.session.chat_channels.indexOf(r)&&t.session.chat_channels.push(r);var o=i.createHash("md5").update([t.session.auth.username,r].sort().join(" ")).digest("hex"),d={};e.get("mongodb").collection("chat_messages").find({channel_id:o,msg_deleted:{$exists:!1}}).count(function(t,i){i||(i=0);var c=0;i>m&&(c=i-m);var u=[],_={};e.get("mongodb").collection("chat_messages").find({channel_id:o,msg_deleted:{$exists:!1}}).skip(c).sort({timestamp:1}).toArray(function(t,i){if(i&&i.length)for(var o in i)i[o].username&&-1==u.indexOf(i[o].username)&&u.push(i[o].username),i[o].channel=r,d[r]||(d[r]=[]),delete i[o].channel_id,delete i[o]._id,d[r].push(i[o]);s.series([function(t){if(u.length){var n=[];for(var s in u)n.push({username:u[s]});e.get("mongodb").collection("users").find({$or:n,chat_data:{$exists:!0}}).toArray(function(e,n){if(n&&n.length)for(var s in n)_[n[s].username]=n[s].chat_data;t()})}else t()},function(e){return a.users_data=_,a.messages=d,n.send(JSON.stringify(a)),e()}])})})}),t};