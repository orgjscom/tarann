module.exports=function(e){var t=e.get("express").Router(),n=require("path"),o=(require("mongodb").ObjectID,new(require("i18n-2"))({locales:e.get("config").locales.avail,directory:n.join(__dirname,"lang"),extension:".js",devMode:e.get("config").locales.dev_mode})),s=require("async");return t.get_module_name=function(e){return o.setLocale(e.session.current_locale),o.__("module_name_cp")},t.get("/",function(t,s){if(o.setLocale(t.session.current_locale),!t.session.auth||t.session.auth.status<2)return t.session.auth_redirect_host=t.get("host"),t.session.auth_redirect="/cp/siteconf",void s.redirect(303,"/auth/cp?rnd="+Math.random().toString().replace(".",""));for(var a={$or:[{oname:"site_mode"},{oname:"site_auth"}]},i=0;i<e.get("config").locales.avail.length;i++)a.$or.push({oname:"site_title",olang:e.get("config").locales.avail[i]}),a.$or.push({oname:"site_keywords",olang:e.get("config").locales.avail[i]}),a.$or.push({oname:"site_description",olang:e.get("config").locales.avail[i]});e.get("mongodb").collection("settings").find(a).toArray(function(a,i){var r="",l="",c=[];if(!a&&i&&i.length)for(var u=0;u<i.length;u++)if("site_mode"==i[u].oname&&(r=i[u].ovalue),"site_auth"==i[u].oname&&(l=i[u].ovalue),"site_title"==i[u].oname||"site_keywords"==i[u].oname||"site_description"==i[u].oname){var g={id:i[u].oname,val:i[u].ovalue,lang:i[u].olang};c.push(g)}var d=e.get("renderer").render_file(n.join(__dirname,"views"),"siteconf_cp",{lang:o,auth:t.session.auth,init_mode:r,init_authn:l,init_meta:JSON.stringify(c),locales:JSON.stringify(e.get("config").locales.avail)},t);e.get("cp").render(t,s,{body:d,css:'<link rel="stylesheet" href="/modules/siteconf/css/main.css">'},o,"siteconf_cp",t.session.auth)})}),t.post("/config/save",function(t,n){o.setLocale(t.session.current_locale);var a={status:1};if(!t.session.auth||t.session.auth.status<2)return a.status=0,a.error=o.__("unauth"),void n.send(JSON.stringify(a));var i=t.body.mode,r=t.body.authn,l=t.body.metadata;if("private"!=i&&"invites"!=i&&"public"!=i&&"maintenance"!=i)return a.status=0,n.send(JSON.stringify(a));try{l&&(l=JSON.parse(JSON.stringify(l)))}catch(c){return a.status=0,n.send(JSON.stringify(a))}if(!(l&&l instanceof Array))return a.status=0,n.send(JSON.stringify(a));for(var u=[],g=0;g<l.length;g++)if("site_title"==l[g].id||"site_description"==l[g].id||"site_keywords"==l[g].id)for(var d=0;d<e.get("config").locales.avail.length;d++){var f={olang:e.get("config").locales.avail[d],oname:l[g].id,ovalue:""};l[g][e.get("config").locales.avail[d]]&&(f.ovalue=l[g][e.get("config").locales.avail[d]].replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/[\n\r]/g," ")),u.push(f)}u.push({olang:"",oname:"site_mode",ovalue:i}),u.push({olang:"",oname:"site_auth",ovalue:r}),s.each(u,function(t,n){e.get("mongodb").collection("settings").update({oname:t.oname,olang:t.olang},t,{upsert:!0},function(e,t){return e||!t?n(!0):void n()})},function(e){return e?(a.status=0,n.send(JSON.stringify(a))):n.send(JSON.stringify(a))})}),t};