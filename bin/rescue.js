var program=require("commander"),async=require("async"),crypto=require("crypto"),config=require("../config"),mongoclient=require("mongodb").MongoClient,db;program.version(config.taracotjs).option("-m, --mongo [url]","Specify MongoDB connect URL").parse(process.argv);var mongo_url=program.mongo||config.mongo.url;async.series([function(o){console.log("This script will create a rescue account for your system.\n"),console.log("Database connection is required."),console.log("Current MongoDB URL: "+mongo_url+"\n"),program.confirm("Continue? ",function(e){e?o():(console.log("\n\nAborted"),process.exit(code=0))})},function(o){mongoclient.connect(mongo_url,config.mongo_options,function(e,n){e&&(console.log("\nCould not connect to the MongoDB. Please check config.js"),console.log(e),process.exit(1)),console.log("\nConnected to MongoDB"),db=n,o()})},function(o){db.collection("users").remove({username:"rescue"},function(){o()})},function(o){console.log("\nCreating rescue account\n");var e=crypto.createHash("md5"),n=e.update(config.salt+".rescue").digest("hex");db.collection("users").insert({username:"rescue",username_auth:"rescue",email:"rescue@taracot.org",realname:"System Rescue",status:2,password:n},function(e){e&&(console.log("... failed"),console.log(e),process.exit(1)),console.log("... success"),o()})}],function(o){o&&(console.log("\nRescue script failed"),console.log(o),process.exit(1)),console.log("\nFinished"),process.exit(code=0)});