var config=require("../config"),version=require("../version"),app=require("../app"),http=require("http").Server(app),io=require("socket.io")(http),crypto=require("crypto"),port=config.port||process.env.PORT||3e3,redis_client=app.get("redis_client"),ObjectId=require("mongodb").ObjectID,redis_subscriber;if(config.redis.active){var _redis=require("redis");redis_subscriber=_redis.createClient(config.redis.port,config.redis.host,{return_buffers:!1}),redis_subscriber.subscribe(config.redis.prefix+"medved_ipc"),redis_subscriber.subscribe(config.redis.prefix+"medved_broadcast"),redis_subscriber.on("message",function(e,i){if(e&&e==config.redis.prefix+"medved_ipc"&&i&&i.length){var s=JSON.parse(i);if(!s)return;io&&io.sockets.connected[s.session]&&io.sockets.connected[s.session].emit(s.msgtype,s.msg)}if(e&&e==config.redis.prefix+"medved_broadcast"&&i&&i.length){var r=JSON.parse(i);if(!r)return;for(var o in io.sockets.connected)io&&io.sockets.connected[o]&&io.sockets.connected[o].emit(r.msgtype,r.msg)}}),redis_subscriber.on("connect",function(e){app.set("redis_connected",!0)}),redis_subscriber.on("error",function(e){app.set("redis_connected",!1)})}var server=http.listen(port,function(){config.gid&&process.setgid(config.gid),config.uid&&process.setuid(config.uid),console.log(" _____                         _     ___ _____ \n|_   _|                       | |   |_  /  ___|\n  | | __ _ _ __ __ _  ___ ___ | |_    | \\ `--. \n  | |/ _` | '__/ _` |/ __/ _ \\| __|   | |`--. \\\n  | | (_| | | | (_| | (_| (_) | |_/\\__/ /\\__/ /\n  \\_/\\__,_|_|  \\__,_|\\___\\___/ \\__\\____/\\____/ \n"),console.log("[%s] server listening on port: "+port,process.pid)});io.on("connection",function(e){e.on("set_session",function(i,s,r){if(i&&i.match(/^[0-9a-z]{24}$/)&&s&&s.match(/^[0-9a-z]{32}$/)){if(s!=crypto.createHash("md5").update(config.salt+"."+i).digest("hex"))return;var o=i+s;r&&(redis_client.lrem(config.redis.prefix+"socketio_users_online",0,r),redis_client.lpush(config.redis.prefix+"socketio_users_online",r)),redis_client.set(config.redis.prefix+"socketio_online_"+i,1),r&&redis_client.set(config.redis.prefix+"socketio_data_username_"+i,r),redis_client.get(config.redis.prefix+"socketio_sessions_"+o,function(s,n){var t=[];n?t=n.split(","):app.get("mongodb").collection("users").find({_id:new ObjectId(i)}).toArray(function(e,s){var o={};!e&&s&&s.length&&(o=s[0],delete o.email,delete o.regdate,delete o.password,delete o._id,delete o.billing_funds),redis_client.publish(app.get("config").redis.prefix+"medved_broadcast",JSON.stringify({msgtype:"taracot_user_online",msg:{id:i,username:r,user_data:o,timestamp:Date.now()}}))}),t.push(e.id);for(var _=0;_<t.length;_++)io.sockets.connected[t[_]]||t.splice(_,1);redis_client.set(config.redis.prefix+"socketio_sessions_"+o,t.join(",")),redis_client.set(config.redis.prefix+"socketio_sid_"+e.id,o)})}}),e.on("disconnect",function(){if(e.id)var i=e.id;redis_client.get(config.redis.prefix+"socketio_sid_"+e.id,function(e,s){if(s){var r=s.substr(0,24);redis_client.get(config.redis.prefix+"socketio_data_username_"+r,function(e,o){var n="";o&&(n=o),redis_client.get(config.redis.prefix+"socketio_sessions_"+s,function(e,t){if(t){for(var _=t.split(","),c=0;c<_.length;c++)io.sockets.connected[_[c]]||_.splice(c,1);redis_client.set(config.redis.prefix+"socketio_sessions_"+s,_.join(",")),redis_client.del(config.redis.prefix+"socketio_sid_"+i),_.length||(redis_client.del(config.redis.prefix+"socketio_sessions_"+s),redis_client.del(config.redis.prefix+"socketio_online_"+r),o&&(redis_client.del(config.redis.prefix+"socketio_data_username_"+r),redis_client.lrem(config.redis.prefix+"socketio_users_online",0,o)),redis_client.publish(app.get("config").redis.prefix+"medved_broadcast",JSON.stringify({msgtype:"taracot_user_offline",msg:{id:r,username:n,timestamp:Date.now()}})))}})})}})})}),app.set("socket.io",io);