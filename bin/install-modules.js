function generateId(o){o||(o=16);for(var e="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=0;o>s;s++)e+=n.charAt(Math.floor(Math.random()*n.length));return e}function ensure_indexes(o,e,n,s,l){var i={unique:!1,background:!0,dropDups:!1,w:1};n&&(i=n);for(var c=[],r=0;r<e.length;r++){var t={};if(t[e[r]]=1,c.push({col:o,ix:t}),!s){var u={};u[e[r]]=-1,c.push({col:o,ix:u})}}async.every(c,function(o,e){db.collection(o.col).ensureIndex(o.ix,function(){e(!0)})},function(o){l()})}var program=require("commander"),async=require("async"),config=require("../config"),mongoclient=require("mongodb").MongoClient,fs=require("fs"),modules=["settings","search","auth","cp","pages","parts","user","lang"],db;program.version(config.taracotjs).option("-s, --silent","don't ask anything (perform silently)").option("-u, --update","update mode (no default values are created)").option("-m, --module [module]","install specified module only").parse(process.argv);var mongo_url=config.mongo.url,finst=function(){mongoclient.connect(mongo_url,config.mongo_options,function(o,e){if(o&&(console.log("\nCould not connect to the MongoDB. Please check config.js"),console.log(o),process.exit(1)),console.log("\nConnected to MongoDB"),db=e,program.module){fs.existsSync("../modules/"+program.module)&&fs.lstatSync("../modules/"+program.module).isDirectory()||(console.log("\nModule not found: "+program.module),process.exit(1));var n=require("../modules/"+program.module+"/install")(db,ensure_indexes,config);console.log("[*] Installing module: "+n.name+" ("+n.version+")"),n.collections(function(o){o&&(console.log("\n[!] Fail: "+o),process.exit(code=1)),n.indexes(function(o){o&&(console.log("\n[!] Fail: "+o),process.exit(code=1)),n.misc(function(o){o&&(console.log("\n[!] Fail: "+o),process.exit(code=1)),program.update?(console.log("\nInstallation complete."),process.exit(code=0)):n.defaults(function(o){o&&(console.log("\n[!] Fail: "+o),process.exit(code=1)),console.log("\nInstallation complete."),process.exit(code=0)})})})})}else fs.readdir("../modules",function(o,e){o&&(console.log("\nCould not get modules list"),console.log(o),process.exit(1));var n={},s=[];for(var l in modules)n[modules[l]]=!0;for(var i in e)fs.lstatSync("../modules/"+e[i]).isDirectory()&&!n[e[i]]&&modules.push(e[i]);for(var c in modules){var r=require("../modules/"+modules[c]+"/install")(db,ensure_indexes,config);r&&s.push(r)}async.eachSeries(s,function(o,e){console.log("[*] Installing module: "+o.name+" ("+o.version+")"),o.collections(function(n){n&&(console.log("\n[!] Fail: "+n),process.exit(code=1)),o.indexes(function(n){n&&(console.log("\n[!] Fail: "+n),process.exit(code=1)),o.misc(function(n){n&&(console.log("\n[!] Fail: "+n),process.exit(code=1)),program.update?e():o.defaults(function(o){o&&(console.log("\n[!] Fail: "+o),process.exit(code=1)),e()})})})})},function(o){console.log("\nInstallation complete."),process.exit(code=0)})})})};console.log("This script will install modules to your TaracotJS installation.\n"),console.log("A working MongoDB connection is required."),console.log("Current MongoDB URL: "+mongo_url+"\n"),console.log("Note: you should have been running install-system script before you continue.\n"),program.silent?finst():program.confirm("Do you wish to continue? ",function(o){o?finst():(console.log("\nAborted"),process.exit(code=0))});var dummy=function(){};